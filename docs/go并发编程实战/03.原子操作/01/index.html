<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-backend/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-backend";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>12 | atomic：要保证原子操作，一定要使用这几种方法 - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/go并发编程实战/03.原子操作/01" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-backend/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>后端开发<ul><li><a href="/blog-backend/go语言核心36讲">go语言核心36讲</a></li><li><a aria-current="page" class="active" href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/kafka核心技术与实战">kafka核心技术与实战</a></li><li><a href="/blog-backend/kafka核心源码解读">kafka核心源码解读</a></li><li><a href="/blog-backend/零基础学python">零基础学python</a></li><li><a href="/blog-backend/python核心技术与实战">python核心技术与实战</a></li><li><a href="/blog-backend/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-backend/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-backend/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-backend/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-backend/后端存储实战课">后端存储实战课</a></li><li><a href="/blog-backend/后端技术面试38讲">后端技术面试38讲</a></li><li><a href="/blog-backend/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li><li><a href="/blog-backend/现代c编程实战">现代c编程实战</a></li><li><a href="/blog-backend/罗剑锋的c实战笔记">罗剑锋的c实战笔记</a></li><li><a href="/blog-backend/零基础入门spark">零基础入门spark</a></li></ul></span><span>架构师<ul><li><a href="/blog-backend/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-backend/数据中台实战课">数据中台实战课</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-backend/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>后端开发<ul><li><a href="/blog-backend/go语言核心36讲">go语言核心36讲</a></li><li><a aria-current="page" class="active" href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/kafka核心技术与实战">kafka核心技术与实战</a></li><li><a href="/blog-backend/kafka核心源码解读">kafka核心源码解读</a></li><li><a href="/blog-backend/零基础学python">零基础学python</a></li><li><a href="/blog-backend/python核心技术与实战">python核心技术与实战</a></li><li><a href="/blog-backend/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-backend/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-backend/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-backend/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-backend/后端存储实战课">后端存储实战课</a></li><li><a href="/blog-backend/后端技术面试38讲">后端技术面试38讲</a></li><li><a href="/blog-backend/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li><li><a href="/blog-backend/现代c编程实战">现代c编程实战</a></li><li><a href="/blog-backend/罗剑锋的c实战笔记">罗剑锋的c实战笔记</a></li><li><a href="/blog-backend/零基础入门spark">零基础入门spark</a></li></ul></li><li>架构师<ul><li><a href="/blog-backend/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-backend/数据中台实战课">数据中台实战课</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-backend/go并发编程实战/01.开篇词">01.开篇词</a><ul><li><a href="/blog-backend/go并发编程实战/01.开篇词/01"><span>开篇词 | 想吃透Go并发编程，你得这样学！</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语">02.基本并发原语</a><ul><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/01"><span>01 | Mutex：如何解决资源并发访问问题？</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/02"><span>02 | Mutex：庖丁解牛看实现</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/03"><span>03｜Mutex：4种易错场景大盘点</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/04"><span>04｜ Mutex：骇客编程，如何拓展额外功能？</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/05"><span>05｜ RWMutex：读写锁的实现原理及避坑指南</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/06"><span>06 | WaitGroup：协同等待，任务编排利器</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/07"><span>07 | Cond：条件变量的实现机制及避坑指南</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/08"><span>08 | Once：一个简约而不简单的并发原语</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/09"><span>09 | map：如何实现线程安全的map类型？</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/10"><span>10 | Pool：性能提升大杀器</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/11"><span>11 | Context：信息穿透上下文</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-backend/go并发编程实战/03.原子操作">03.原子操作</a><ul><li><a aria-current="page" class="active" href="/blog-backend/go并发编程实战/03.原子操作/01"><span>12 | atomic：要保证原子操作，一定要使用这几种方法</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/04.channel">04.Channel</a><ul><li><a href="/blog-backend/go并发编程实战/04.channel/01"><span>13 | Channel：另辟蹊径，解决并发问题</span></a></li><li><a href="/blog-backend/go并发编程实战/04.channel/02"><span>14 | Channel：透过代码看典型的应用模式</span></a></li><li><a href="/blog-backend/go并发编程实战/04.channel/03"><span>15 | 内存模型：Go如何保证并发读写的顺序？</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/05.扩展并发原语">05.扩展并发原语</a><ul><li><a href="/blog-backend/go并发编程实战/05.扩展并发原语/01"><span>16 | Semaphore：一篇文章搞懂信号量</span></a></li><li><a href="/blog-backend/go并发编程实战/05.扩展并发原语/02"><span>17 | SingleFlight 和 CyclicBarrier：请求合并和循环栅栏该怎么用？</span></a></li><li><a href="/blog-backend/go并发编程实战/05.扩展并发原语/03"><span>18 | 分组操作：处理一组子任务，该用什么并发原语？</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/06.分布式并发原语">06.分布式并发原语</a><ul><li><a href="/blog-backend/go并发编程实战/06.分布式并发原语/01"><span>19 |  在分布式环境中，Leader选举、互斥锁和读写锁该如何实现？</span></a></li><li><a href="/blog-backend/go并发编程实战/06.分布式并发原语/02"><span>20 | 在分布式环境中，队列、栅栏和STM该如何实现？</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/07.结束语">07.结束语</a><ul><li><a href="/blog-backend/go并发编程实战/07.结束语/01"><span>结束语 | 再聊Go并发编程的价值和精进之路</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/summary">go并发编程实战</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="Add" data-depth="2"><a href="/blog-backend/go并发编程实战/03.原子操作/01#add"><span>Add</span></a></li><li title="CAS （CompareAndSwap）" data-depth="2"><a href="/blog-backend/go并发编程实战/03.原子操作/01#cas-compareandswap"><span>CAS （CompareAndSwap）</span></a></li><li title="Swap" data-depth="2"><a href="/blog-backend/go并发编程实战/03.原子操作/01#swap"><span>Swap</span></a></li><li title="Load" data-depth="2"><a href="/blog-backend/go并发编程实战/03.原子操作/01#load"><span>Load</span></a></li><li title="Store" data-depth="2"><a href="/blog-backend/go并发编程实战/03.原子操作/01#store"><span>Store</span></a></li><li title="Value类型" data-depth="2"><a href="/blog-backend/go并发编程实战/03.原子操作/01#value类型"><span>Value类型</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="12--atomic要保证原子操作一定要使用这几种方法"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#12--atomic要保证原子操作一定要使用这几种方法"><span class="icon icon-link"></span></a>12 | atomic：要保证原子操作，一定要使用这几种方法</h1><p>你好，我是鸟窝。</p><p>前面我们在学习Mutex、RWMutex等并发原语的实现时，你可以看到，最底层是通过atomic包中的一些原子操作来实现的。当时，为了让你的注意力集中在这些原语的功能实现上，我并没有展开介绍这些原子操作是干什么用的。</p><p>你可能会说，这些并发原语已经可以应对大多数的并发场景了，为啥还要学习原子操作呢？其实，这是因为，在很多场景中，使用并发原语实现起来比较复杂，而原子操作可以帮助我们更轻松地实现底层的优化。</p><p>所以，现在，我会专门用一节课，带你仔细地了解一下什么是原子操作，atomic包都提供了哪些实现原子操作的方法。另外，我还会带你实现一个基于原子操作的数据结构。好了，接下来我们先来学习下什么是原子操作。</p><h1 id="原子操作的基础知识"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#原子操作的基础知识"><span class="icon icon-link"></span></a>原子操作的基础知识</h1><p>Package sync/atomic 实现了同步算法底层的原子的内存操作原语，我们把它叫做原子操作原语，它提供了一些实现原子操作的方法。</p><p>之所以叫原子操作，是因为一个原子在执行的时候，其它线程不会看到执行一半的操作结果。在其它线程看来，原子操作要么执行完了，要么还没有执行，就像一个最小的粒子-原子一样，不可分割。</p><p>CPU提供了基础的原子操作，不过，不同架构的系统的原子操作是不一样的。</p><p>对于单处理器单核系统来说，如果一个操作是由一个CPU指令来实现的，那么它就是原子操作，比如它的XCHG和INC等指令。如果操作是基于多条指令来实现的，那么，执行的过程中可能会被中断，并执行上下文切换，这样的话，原子性的保证就被打破了，因为这个时候，操作可能只执行了一半。</p><p>在多处理器多核系统中，原子操作的实现就比较复杂了。</p><p>由于cache的存在，单个核上的单个指令进行原子操作的时候，你要确保其它处理器或者核不访问此原子操作的地址，或者是确保其它处理器或者核总是访问原子操作之后的最新的值。x86架构中提供了指令前缀LOCK，LOCK保证了指令（比如LOCK CMPXCHG op1、op2）不会受其它处理器或CPU核的影响，有些指令（比如XCHG）本身就提供Lock的机制。不同的CPU架构提供的原子操作指令的方式也是不同的，比如对于多核的MIPS和ARM，提供了LL/SC（Load Link/Store Conditional）指令，可以帮助实现原子操作（ARMLL/SC指令 LDREX和STREX）。</p><p><strong>因为不同的CPU架构甚至不同的版本提供的原子操作的指令是不同的，所以，要用一种编程语言实现支持不同架构的原子操作是相当有难度的</strong>。不过，还好这些都不需要你操心，因为Go提供了一个通用的原子操作的API，将更底层的不同的架构下的实现封装成atomic包，提供了修改类型的原子操作（<a target="_blank" rel="noopener noreferrer" href="https://preshing.com/20150402/you-can-do-any-kind-of-atomic-read-modify-write-operation/">atomic read-modify-write<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，RMW）和加载存储类型的原子操作（<a target="_blank" rel="noopener noreferrer" href="https://preshing.com/20130618/atomic-vs-non-atomic-operations/">Load和Store<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）的API，稍后我会一一介绍。</p><p>有的代码也会因为架构的不同而不同。有时看起来貌似一个操作是原子操作，但实际上，对于不同的架构来说，情况是不一样的。比如下面的代码的第4行，是将一个64位的值赋值给变量i：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">const x int64 = 1 + 1&lt;&lt;33</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func main() {</span></div><div class="token-line"><span class="token plain">        var i = x</span></div><div class="token-line"><span class="token plain">        _ = i</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>如果你使用GOARCH=386的架构去编译这段代码，那么，第5行其实是被拆成了两个指令，分别操作低32位和高32位（使用 GOARCH=386 go tool compile -N -l test.go；GOARCH=386 go tool objdump -gnu test.o反编译试试）：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABW8AAABTCAMAAADX9AXGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAACTUExURQArNitzkJOhkFVQNgAramWOdysrNgArV1WOoZOOdwBkgpOhoWVkNgBQd3qhoXpzV2WhoZN/akN/oZOhgkMrNlVkNisrapOOkFV/oUNzkHqOdysrV3qOkFVQalVzalWOglWOkHqhkHpzd0N/gpN/gmWhkJOOgmWOoXpzaitkglVQV1VzgmVkakMrV0NkgkMrav///9yrR3gAAAABYktHRDCu3C3kAAAAB3RJTUUH5wkbAR8OZr162wAAAAFvck5UAc+id5oAABCXSURBVHja7Z15e6S4EcZhx2u7wVczk8lOrs0mmdzH9/92QXcJldQSptslqd4//GAZDFUlCiEk/YaBxWKxWCwWi8XqRuMPnz76ElisK+jux/uPvoSO9PB4Qt3NUfC1O99Os9TTRxsg9fA4z1tDxAVuy7D9atTzy2rca8xKzF53RI2SV79Wtbu3s/h1+fzl7m02lj+/oHaZOx2Ledob5my6jn/+8tHmf5AeHo3pbiu+bzrfZkZhqbiSXlcTkVQrJIO9eXKM4s4c/YvE9qtRzy9nEYBX3ErMXndEjRrFhT+/PHn5VmwtyjbELHF/S3OxmKe9Yc+m6vjdW/0VZp+chy7XHDzflkZh3UM6nhWIUr6dQNvH06YWRPerTLLiOttibQtg7+aIuqSv+/lXQb6VqRbLt3dvp68/3o9PeMyT3nBn03U80n5uX4tt1C4X2/ioN4ujsJzuG7g9pTt+/TKffpp1BVqfOucBNPJXq7+F7X3xznb6Jkrl29uTLlS7Ucq3qjqIn5N8+1vmszFbRFM+ZZ+8/eoWmm+tlfKtTHrA2Vt1vnW3YHa+XWunfpPF6kbSG+CGV3W8jQxQLufXwMMyH5yND8X7lcogm5xQHAXYvnX1GZztG5kuzLREB8z6niSrzvNv7uWj515bqGx7DTpp5C6jyMKy5T8a402+nan0heqYSVMmEUiTbtU1SzsmVSfsflVLhtE98Hwr1y0Rx8mzd3NEXVpr5xkYntOfYO90tG4kveHO1nn7Nt68VcljevXy7XwOerbKo6D6b5f1B6zP9mzIOWhKGLxePHiajMqHJt+K37Y9oOr5s/5cwJPI5ttX6R4Ktq9X9lvxPJEXtsy/m08qxqqR556j3n51a9S2IVa6MHr22iMqlGzgqPcs/3uZTIR4f8IPvzd3OlI3kt6wZ+u7/zbRvLUFMN8i7wy7orDWaJFUXH0GZ6vmLc3mW9n0mV3b1ORb4zf/kEE2IcxW+B5++bvljYxz0VzD5e6PcX4d3NU3k29lDXRfGgIrXT+DsXdzRH0a5Yvktn0rayza/gTvoGHduOgNdba+xyckem+Fc2WZ15+A5IjyKKicOsD/tzlbFf2BMN/K76+mFXQx344232J5ikTu8q9vgs9MmX9m/Xxppj9h2w+NWen7pYGea/Fauc23fvtns/+PP601Aa0bGd5wr7OdKug09/+onkNBvg3urbIoyHeJ9Skn3kVn2yr0z1bF/QvyrWu3DsN727dEbIeREx8DnRkjzD8tZB2hoN6NSJb17K2opsZls6y/lRh/u2yeNLpuZHlDfdvpN996tQv5u/7kk27f7onCGk7ZHPZ6DcDZqrh/g3xreqWQfOv9Kdp/q/8tCdvBaBPRZQSuUH6bt9fYyHgw7fXFmulb6WqwtTc4oio9/MFY/fCosqxp6Uq74vl2NDnTrxueN3R3IXa2nvNtsnkrJdyucsIS678d9kRB7LoeMvqZRZ2tyv5bmVaX+WK+TY5PePhZOotGhQSficSnzeeX9c78o/pI9Gq+b4pRGa3Md5AvZOIHaqUdnwDstUfUKP01V87vUN2qr/renebYeLDzeqd/fTujdcPzRphv3dk6zrfJ5u1k+87Fj7W9GhufsCcKqn177+qzPVuN4xPU4Ld5fhXGj7OelIvmW9lvch4j429NpwoJ2YHEauStGOOnOoDceFQ7ZqH+dAtmQqJW2vG3rcznBVZOs5nZa6eTS9Os7VpyP98Hrm5Ab6inE362fvPtheatiYL01elbbPztvihMOq/Y+mzOVtH42/2qobeExQqUuVJKzYM2rifXiHxnc/LIKFTRk/BO9WAjq0Vl3ukjtydCmdlQcGvnfzowCo3nItk5WEVvCYsViFcCpKAjo9B4voW9tiwWi/Whaj3fslgsFovFYrFYLBaLxWJhamD0P4uF6KAvNc+/JGhFPJQs1DTjI713xCPhe0w1xOMd+XakM4I+l1+Wpn3VJ7iqh+eDUY0UHyFibgzmfIwmgK6sfOv6unub1eKfp3u7WJSZSb6IFaqL+WXO8phX3ZqWarg/yjSbWqpLmB/y+WWe8BXbiuNhZm9np5mm4yEnPo8khi/k8svStK9qJcdIej5Ys4OZ2K4mY7syt9/d26u+MVxZ+dZN7NOZVi+bsLjFmsV1lPPLnOWYvCP0LYwzzUwyblQl/DJPiHP3xEP5voBp1nI8KHHdcvll0bK6Ndm5/toHD49/ksPU/+wtKa/KPF/pWu7KyrduoLu3v3z/NEx//dvpfrRAB3Xp4mc5v2xIQhu8I5YT4BMETLO2J0uU8Ms8hc7dFQ/l+xKmGZl4HM8vozTPN5dfBsoql10hYTAve3DFu/H0FUwLUhnClHlrUupa7srKt26g9XZbXofl72aVPhlBNfFJrZdSyi8bkvkW2ra2vPQV+N7UBU0vsBADPHi5xGaGBfTyhM7dEw/t+xKmGZl4HM4vW+38B5X+21x+GSirW24FMCEZHeiD518+wWmYCyzzVx1VtRxbWT536zbmnqfT1+//fDx9daveSrOi6zGmyVlDKt96tulqE2OaNY02izVvvVxiM8ME+q4S+bYgHpNbhymXaUYmHofzy5SdNBb7yOWXgbK65QfKRMf4QPRigXw7zTLNnm03L2AK2Xyry8q3bmHuemffff+XaNzCfDvJdf3O+/hl6XzrjpjsWx3KNKt/LeW4ovwymEtcZtCtsyfkgGFfPCb4TprHNCMTj8P5ZWa1YAq9Crn8MldWt/weEZVagQ9GyXwyuzy/yO+apqzSfCuaNw9+vhWlO/llQ3a+BbcExjQjc39fQdHeW4QVo983zBsy2jlQHA/r+3ymGZl4HM4vo0RoyeWXubKPvuJD7NWa9EKkxgeys8vmW5VuXVml/QniW/Um34qfcqOcXzaU9ieY69gyzcjc38crvgJumG9178CrGwqDjgcrjMcEOjAzmWZk4nE8v2yhk2+z+WW27KMv+H3yLLIDUY0PzPLbs/p+r1GotqzO72XabPC9TFTXf8s/FPPLhiH7e5n/ASZgmpHpLzxeccBDpH27Po2+2eGI+PjbsngAT+cyzcjE43h+2USnPyGbX+bK6ha8A0ybwh9no9u3Ot3CsirHg5l8C8aDqbvVjAnDjoqSswZ4UMDT8Wwzp44wzch8Dz9cCcADfFeGmWGZk53jxfHYDArJYZqRicfh/DI1tpjG97Jcfhkoq1twfIJhQPrjyLXNL2hHL5wXUcd8B5tv3XwH1/tXzi8bkvnWs82Mv8WZZmTGex6uBL8M5hKYGSY7XCmcjrYrHoutvblMMzLxOJ5f5maMEFAmvwyW1S07/talVG+epO6rNfF1ZXC/BZkLTHM+r8237kPJYCco7+CXOcsRfpln2+TMDZlm7c5nSvHLvFyCZQY9ct/rxdsTDzA9N49p1kI86n/7ZnWpY8hZyVu43fn6h/HLnMrjkZM+vW8ZDcSjidlYrA51EDmry/XBjuOXgf9ZHo+M9cFgfqo8HswvY1Us5pfR0nXi0VJ7kPllLBaLslrKtywWi8VisVgsFovFYrFYmKqf3Mpiobri97Iuxyzk6kB+WVpV0s364pe1ps1aPKMdZJ7HL0PK3BF05kAczy8bk/NeInZY7/bCNLsdvwyLR2YUuqGbVcgva1RmjKQmlLmtNL8MK3NHEJrjezi/zPMLcihqh/NuL0yzm/HLsHhkRqEbulm1/LL2pO8GQyjL55eFZe4IQmvYHM4vg37B3PmErtJivNsN0+xm/DIsHplRIEo3Y36ZXnh+bgLwgPDLILUsl1+GMs30EYTWaLwGv2yILyaFH+F82gvT7Kb8ssBxmVEgSjdjfpl8ZYGWVyyEXwapZbn8MpxpNsA1j0msQX4NftngVlbbCD8C+LQXptlN+WXDJh65USBKN2N+WWB5xUL4ZYBalssvizDN1BGUGDvX4JdpvyBCj4A+7YRpdlt+2TYe2VEYSNLNmF+2bC2vVxi/DFDLcvllEaaZOoJYvj2cX+Yvxb7xbngE9GknTLPb8su28ciPAkm6GfPLZrneL7C8XmH8Mkcoy+WXxZlmoE1ApT/hCvyy2HViR3g+7YNpdnN+mR+P3CgQpZsxv8yz6KMv+H3C+GWOUJbLL4swzUzFp/W9TJt9GL8snm7R2uT5tA+m2W35ZWE8CqJAkG7G/DJrJViGvlZh/LJhQJYtvcQvC8vsEaTGgx3NLwN+SfLLvNp09+Z1A7bNNLstvwyJR2YUzK7E6GbMLxNjEzzLKxbGL1Plfr69yC8LyiCeh9B8h4P5ZdAvSX4ZJGw57/bANLspvwyLR2YUhAjSzZhfZh7ByvLahfDLhiDfXuKXhWXwCErzeY/ll/0H+iXFLwOELejdDphmN+WX4fHIjIL+583QzWj0GLBYhTqGX4apA6YZCX5ZWm3SzfqYEctqTwfxyzA1vz4YEX5ZWq3RzZhfxqpYzC+jpY+IR12tReaXsViselVXvmWxWCwWi8VisVgsFovFwtTCYNTLEmP5eFxbX+LvZTdTYnIER8HX/nwrh5kTGWJxiV9mBhGnuVX1yPk+QmkLuGSUorVDcja8/oLr1rmOrf4nleJlpb2Bcsk6VDa/LCPfZkYhn0bWm+RMPnrzea0gv8x8pkxzq+qR832E0hZwyShFa5/Fs1r7wqxx7baGcn5Z2hs4l6xDZfPLovm2NAoFNLLetF3F+yN1iV9mLjPNrapHG98HUQi5ZJSitctis86emtr5BLZ28MuS3ohxyfpTNr8slm+Lo1BCIyOt4/lllO7gNL9MvRW618L6F3DC861jmoVcMkrR2qH1ffa/aukhtV7UGWzt4JclvRHjknWnKOABcgD9HGFXZFQqjkIJjYy0DueXgSX4PlwX+GXBQ7T69u3G95rSZtcMQ7hkhKK1R2sFlBap1GcXCtvQU4DSvKykN2Jcsu4Ub966DKIzg8sReL7NjkIBjYy0DueXDfIdj8aD/wK/bLtsxVxrKw/I+t6ntOkijEtGJlr7zH3SoBTDd3Bbu/hlKW9EuGS9KdG8VRrd+rcuR2z6E3ZEIZdGRlqH88uUF2h8gUnzywY/RKmV/WvRxveA0iZ/RbhkhKK1Q3ZR7+x8m+ZlXfQGxiXrTaneW5NBwhzh31zlUcinkZHW4fyy69FT9hnnrm/LLxu8fNtCug18v1iyyYCzyihFa4dkcnW9thn9CUOSl5XhjZBL1plSK+DaDHKZXlcWhRIaGWkdzi8jZXuSXzbAfNtEug1871HaMC4ZqWiVy37xzP5eNqR4WVneCLhknekC4GHYtGpjbMDyKOTSyEjrcH6Z4aGTuIPT/DKQb5tIt6Hv7QgEqw2XjFS0yqWiuFbP7PFgQ4qX5Xkj4OnEuGR96RLgQScClyNGpP922BOFXBoZaR3PL5MvBRONbzBpfpkLkc/zqlfW9x6lzTHNQi4ZpWgVS9/xcpBC5nyHNC8LeiPMtxEuWV9KNG8HkEEujE/YE4VcGhlpXYFfRmmG6AV+mZ324PG8Kpb1/ZbS5holDc3nncxT8/P/8Pm8hfyyL9AbIb8M55L1pVTzdoAcwOT4231RyKORtaoaektYrEDX45d1oMP4ZUdGoYqehHeqBxtZLeqK/LLmdRy/7MgoNJ6LmF/Gqli8EiAFHRmFxvMt88tYLBYZtZ5vWSwWi8VisVgsFovFYrEw1TrFs0zML2OxWDfQ/wGpOxrE6cvdpwAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyMy0wOS0yN1QwMTozMToxNCswMDowMFExzuoAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjMtMDktMjdUMDE6MzE6MTQrMDA6MDAgbHZWAAAAKHRFWHRkYXRlOnRpbWVzdGFtcAAyMDIzLTA5LTI3VDAxOjMxOjE0KzAwOjAwd3lXiQAAAABJRU5ErkJggg==" alt=""/></p><p>如果GOARCH=amd64的架构去编译这段代码，那么，第5行其中的赋值操作其实是一条指令：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage6e666e20a0f44d95d78c1bca4303f1a32966.59c51fe4.png" alt=""/></p><p>所以，如果要想保证原子操作，切记一定要使用atomic提供的方法。</p><p>好了，了解了什么是原子操作以及不同系统的不同原子操作，接下来，我来介绍下atomic原子操作的应用场景。</p><h1 id="atomic原子操作的应用场景"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#atomic原子操作的应用场景"><span class="icon icon-link"></span></a>atomic原子操作的应用场景</h1><p>开篇我说过，使用atomic的一些方法，我们可以实现更底层的一些优化。如果使用Mutex等并发原语进行这些优化，虽然可以解决问题，但是这些并发原语的实现逻辑比较复杂，对性能还是有一定的影响的。</p><p>举个例子：假设你想在程序中使用一个标志（flag，比如一个bool类型的变量），来标识一个定时任务是否已经启动执行了，你会怎么做呢？</p><p>我们先来看看加锁的方法。如果使用Mutex和RWMutex，在读取和设置这个标志的时候加锁，是可以做到互斥的、保证同一时刻只有一个定时任务在执行的，所以使用Mutex或者RWMutex是一种解决方案。</p><p>其实，这个场景中的问题不涉及到对资源复杂的竞争逻辑，只是会并发地读写这个标志，这类场景就适合使用atomic的原子操作。具体怎么做呢？你可以使用一个uint32类型的变量，如果这个变量的值是0，就标识没有任务在执行，如果它的值是1，就标识已经有任务在完成了。你看，是不是很简单呢？</p><p>再来看一个例子。假设你在开发应用程序的时候，需要从配置服务器中读取一个节点的配置信息。而且，在这个节点的配置发生变更的时候，你需要重新从配置服务器中拉取一份新的配置并更新。你的程序中可能有多个goroutine都依赖这份配置，涉及到对这个配置对象的并发读写，你可以使用读写锁实现对配置对象的保护。在大部分情况下，你也可以利用atomic实现配置对象的更新和加载。</p><p>分析到这里，可以看到，这两个例子都可以使用基本并发原语来实现的，只不过，我们不需要这些基本并发原语里面的复杂逻辑，而是只需要其中的简单原子操作，所以，这些场景可以直接使用atomic包中的方法去实现。</p><p><strong>有时候，你也可以使用atomic实现自己定义的基本并发原语</strong>，比如Go issue有人提议的CondMutex、Mutex.LockContext、WaitGroup.Go等，我们可以使用atomic或者基于它的更高一级的并发原语去实现。我先前讲的几种基本并发原语的底层（比如Mutex），就是基于通过atomic的方法实现的。</p><p>除此之外，atomic原子操作还是实现lock-free数据结构的基石。</p><p>在实现lock-free的数据结构时，我们可以不使用互斥锁，这样就不会让线程因为等待互斥锁而阻塞休眠，而是让线程保持继续处理的状态。另外，不使用互斥锁的话，lock-free的数据结构还可以提供并发的性能。</p><p>不过，lock-free的数据结构实现起来比较复杂，需要考虑的东西很多，有兴趣的同学可以看一位微软专家写的一篇经验分享：<a target="_blank" rel="noopener noreferrer" href="https://docs.microsoft.com/zh-cn/windows/win32/dxtecharts/lockless-programming">Lockless Programming Considerations for Xbox 360 and Microsoft Windows<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这里我们不细谈了。不过，这节课的最后我会带你开发一个lock-free的queue，来学习下使用atomic操作实现lock-free数据结构的方法，你可以拿它和使用互斥锁实现的queue做性能对比，看看在性能上是否有所提升。</p><p>看到这里，你是不是觉得atomic非常重要呢？不过，要想能够灵活地应用atomic，我们首先得知道atomic提供的所有方法。</p><h1 id="atomic提供的方法"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#atomic提供的方法"><span class="icon icon-link"></span></a>atomic提供的方法</h1><p>目前的Go的泛型的特性还没有发布，Go的标准库中的很多实现会显得非常啰嗦，多个类型会实现很多类似的方法，尤其是atomic包，最为明显。相信泛型支持之后，atomic的API会清爽很多。</p><p>atomic为了支持int32、int64、uint32、uint64、uintptr、Pointer（Add方法不支持）类型，分别提供了AddXXX、CompareAndSwapXXX、SwapXXX、LoadXXX、StoreXXX等方法。不过，你也不要担心，你只要记住了一种数据类型的方法的意义，其它数据类型的方法也是一样的。</p><p>关于atomic，还有一个地方你一定要记住，<strong>atomic操作的对象是一个地址，你需要把可寻址的变量的地址作为参数传递给方法，而不是把变量的值传递给方法</strong>。</p><p>好了，下面我就来给你介绍一下atomic提供的方法。掌握了这些，你就可以说完全掌握了atomic包。</p><h2 id="add"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#add"><span class="icon icon-link"></span></a>Add</h2><p>首先，我们来看Add方法的签名：</p><p><img src="data:image/png;base64,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" alt=""/></p><p>其实，Add方法就是给第一个参数地址中的值增加一个delta值。</p><p>对于有符号的整数来说，delta可以是一个负数，相当于减去一个值。对于无符号的整数和uinptr类型来说，怎么实现减去一个值呢？毕竟，atomic并没有提供单独的减法操作。</p><p>我来跟你说一种方法。你可以利用计算机补码的规则，把减法变成加法。以uint32类型为例：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">AddUint32(&amp;x, ^uint32(c-1)).</span></div></pre></div><p>如果是对uint64的值进行操作，那么，就把上面的代码中的uint32替换成uint64。</p><p>尤其是减1这种特殊的操作，我们可以简化为：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">AddUint32(&amp;x, ^uint32(0))</span></div></pre></div><p>好了，我们再来看看CAS方法。</p><h2 id="cas-compareandswap"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#cas-compareandswap"><span class="icon icon-link"></span></a>CAS （CompareAndSwap）</h2><p>以int32为例，我们学习一下CAS提供的功能。在CAS的方法签名中，需要提供要操作的地址、原数据值、新值，如下所示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)</span></div></pre></div><p>我们来看下这个方法的功能。</p><p>这个方法会比较当前addr地址里的值是不是old，如果不等于old，就返回false；如果等于old，就把此地址的值替换成new值，返回true。这就相当于“判断相等才替换”。</p><p>如果使用伪代码来表示这个原子操作，代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">if *addr == old {</span></div><div class="token-line"><span class="token plain">    	*addr = new</span></div><div class="token-line"><span class="token plain">    	return true</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    return false</span></div></pre></div><p>它支持的类型和方法如图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage1b771b0ffac37d8f952ca485ff58daf27177.6549c80b.png" alt=""/></p><h2 id="swap"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#swap"><span class="icon icon-link"></span></a>Swap</h2><p>如果不需要比较旧值，只是比较粗暴地替换的话，就可以使用Swap方法，它替换后还可以返回旧值，伪代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">old = *addr</span></div><div class="token-line"><span class="token plain">    *addr = new</span></div><div class="token-line"><span class="token plain">    return old</span></div></pre></div><p>它支持的数据类型和方法如图所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA0wAAACgCAMAAAAILRzhAAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAAKFUExURf////7+/7fa45DG1Nrs8XC2x+/3+eLw9FiqvgqCoAN/nZrM2LPY4RSHpJjK1/3+/miyxNDn7ZXJ1gaAnqTR3Oby9TKWrziasu72+On09kiiuE2kuvH4+pHH1AB9nLjb4+jz9iiRrEqjufT5+0Kftkaht2+2x9Pp7vL4+oC+ziGOqQWAnjaZsanT3vr8/ff7/JvM2CSPqkOftsbi6dns8FWovRaIpW61x9jr8B6MqIXB0CaQq6LQ2w+FouXy9bDX4DGWryqSrJzN2ev19zycs0+lu9/v8yOPqnm7y2Ovwvv9/ePx9DCVrzubs2y0xi2UrVOnvGCuwXi6yx+NqBOHo2mzxZbJ1m21xur099bq7yeRq2eyxJ3N2VyswHW5yYPAzxCFosvk6wiBn63V367W4Ha5ytTp7n69zc3m7OTx9ZLH1cnj6r3d5arU3ojC0T+dtOHw89Ho7WGuws/n7PX6+4G/zhqKpu32+DWYseDv8yKOqaDP2rTZ4qvU3pPI1UmiuKzV34K/zne6yg2Eocjj6mqzxdfr72Kvwtzt8YnD0crk6h2Mp8Xh6Hq7y7nb5D6dtPD3+Y7F02Www7LY4VapvV+twbzd5RiJpdLo7ny8zBuLpufz9vP5+jeZsY/G1J7O2cTh6EykunO4yc7m7BKGoyyTrTqbs06luvb6+8Hf54TAz7vc5XK3yFepvl6twL7e5vj7/FCmu4zE0rrc5EWgtxeJpbba45/O2r/e5qfS3cDf52axxJnL11KnvN7u8uz1+AmCn6jT3QyDoSuTrYfC0NXq73G3yNvt8cPg6HS4yVqrv/n8/S+VrkujuXu8zLHX4USgtq/W4LXZ4sfi6X29zVSovYvE0gEz3DAAAAABYktHRACIBR1IAAAAB3RJTUUH5wkbAR8bC2CeMAAAAAFvck5UAc+id5oAACNFSURBVHja7Z39YxTVvcZnQgrMmL3ZAEkhL5M3sho33RUk4c0VCPJiEl4TgQoajJYiarCAm5iA1YQoAm0gvAShpdo0belFzK1SCq1tta16qdr29vb+Pfe8zcyZl7M7y87JLOQ8P8Bm9sw58z1znplzzpz5rCQJCQkJCQkJCQkJCQkJ3XWS86YFfQj+KP8b0zkHZi9BKHDNmKmo9wV9EKYKQv9R6NwaDhXpH4tCYcaus2bP4XtsxSXfnOs58bzSsvJUgVVolfrHquqaWh9KEApa5fPVusj9XlM/UP+gFm34Vsxz9pVahXUDaUPxhxZo0YUPy/DzokZFa1o8D329ZOky2SWb1GYqXo7yfCSR57rXo4sTWmLxo/Bj4YqVqrqq2fvxW7T6sTW13oNZu249FYojMFczOUog0XopQShwFYUeb/GcuLVN3RDZuEnb7PmKyDBT7Ra17r6t7UoBTJLoeGJbndrWCj63bC/Z4ZZNajNVVVdK7L2+/WRi566nFJh/y9Pqps7Oai1yh26yK3UwFbufMVI6A3M1k0M4Wi8lCAUvR2tPoZbHu54Fl8LYMu/7MMz0nPqdQnhlnV8Obo1L94ARBc7zmd3NrtmkMFPrd/cWV1c+v+8Fxl4tjysvgs8vqd0w+0bQaufuN3PLTqmDeXm5eZ1yBpaJmbyUIBS0ams0oJpa0kJh66utqf7eAUVtOAg3HHolCXpI80jqnt7qKvj/q31lh/q1wxI8y0fAv4e1fpD0tQWa8v1FEjTQ668lteSsmETMVKlNW7FAS7wRB5+gKqWBwaOodJBfUWgI9lUOdsAj6Ey+iYo18pJis5Jae/NbqPkfK41GNx+Bh1qpvV2vlB2CCY6f0HZHO1TlNdw8w6GTP0hoC34ogz+BQkU9vcOnJNIqK1TUETyt0Xcycw+gFxZGowuBLx3hQaFG7z0YeajvVb0QEpj88MKourIApsFmmgeqev8Kw0yoBHCoJxtUZWQ6+BOWEPZUglDQajlZr42cOdliMZPStCFyNrr8ZTCgKlPrtp2Loi4F0KGy0F74f/w83GMAnkwNntoBsFt5WfTckfrR5AXY0rvaw+FR9R3ZMNPFpgMbq7Vu6dKZEa3+zCVS+qnh3h6wKR9+PtjRCTfU/UiS6Lzkd1SQV3I2NFN+X7QmUtelhmGOTdF1byEzSfKMmdqPL8RI8wx3NW3aeC4B+j/5Z0oHK/L0Ca+jg+B49+I/T6O2qcvcQ5IKlIbLW0eVPMkeHhIxk8dgJOmIdsT4EgUm/URpr++sVvfJ5GhXPwb6zWcV1WamUMfMSIP2eEv8fMVg6Zm9XkoQygHhfpjFTOq0QtiPOAKv5PC0r+jqJokLlNF9ZLYJNY8dJV2rLoE9wLX/3VWXQdJ3YZOt1N6bDsdX8GJMzNS2FvZS4C2C6t3s+GnXI/pneRlszPkn0GFQeT2zu7Qc5gUODHQyV4CE+7CZYI5EYxdHfga+IWbStsdhp65TojuHhfdv6MvX08/dP58e81F7rF33BPg4Y3x+uT08JGImj8HAFj9AtpDAliz9eTG8VsCv0b7d2jQZVqvNTMnj8CjhXYfq1KYuQSgH5GKm5cVke20NGjXP/cXIL3FiecWopi24XAU/D5zIl66EfpW4Anp9xhmtqg4b46Rm2DsiZjotkV6K0f5gB/PifxqTUQXKVdD7v9JFjbBQXhX40gsP7NIqs7+Gc8QqLnn/0Hp4F8Nm6jhoxKObqSikaaWtevpYRLHM+lF79ONbVhiE5hYeMZPHYOAs4zUypCGBVajPwf8+6BrA+9bWoG5alb2bNyLrR6+bKW0JQjkgFzOhgRHcXlXdOGFLHqv8L0WL/hp0qvLAeKJzOL+kU8qbDRvnA/tWqaiDr5vpYMd2w0xwg7X9tZw88o3R0Ick27HkR3Mlc7rCzIv4Af5HjpGYyXTdvC0XpOLNx3UzoR2sZpqet+tsdLgYJ5f3ze62TChTe4Q1LLDFHh4UMZPHYGiTkOMNX9+Dt4PhHtyXJHCYyTgZhpnSliCUA0ptprDLHrHfbFJvwFmIgfL5A/LQ8KlOeHktL0sM/LZ4z4Kw0XLMVu/W/qBa28h8cf44HpaRPam8PJjJENNMUAXK08hC8k3FNjFOm2n0xhkoMLSyhYfENJNrME4zkarF2zMzU9oShHJAmdyZyOBXejMJBhQTjcO3rudJedcfLoOp+tWXJGs37+jg9jRmkjpxt6q1bTyfOhg6L9/MdGoYj3wKlN8dsu5Gm8ncwRYeUkozOYJh35mKl9+RmVKWIJQDSmUmMmaqffu1CZT2vIqv7lXV42B7xYkIGJ6DK3gfzGE7aoev9oVdx0z29gdHJZLeOoqHl5I2fHQQ7UnlRUYZeMyE5g0yNRO5IhAzfRhyPHCm9ujUzKdB1vAkHLermRjBwPT6iIYE5hwzwTnT9GbyUIJQDgi3jR3j0DZo0owyE5nNK1DIbN7qhuQV+H+BAp8VHh3UwJlsuZYIwVNcof1eluLb8ZiprNw2m0e3P/gApxnNYs3rBc0VdOqSY+RgyKQXldebSWM2T36ans3zZCY4tRD/GM3nv6jAWe6xpL6crXB1Dxk5UXsUhcb/AKdZpsXs4SG5mClFMBKeX6cDW7J0+I+W2bxm99m8sHFceDLCQwlCOSDcNuT1WkPkQIdmM1N5WfQXuw4oDfpMWNFSdUMkMhxFl8aeXvQws1/r7ZFgO4nWhNv/FEXNrav68mX8NMVhpitd1RvvRw+wdnVWK5+AzWtmfxcNVM5c0h/HUHkB71RvPND0KWxYrW3Rs5ENn0bDXs3UrzVsnQEMlNg5Z2fiz8ck6ULywX5U1Pm4eTeg9pBnRUe33lenwrlya3hIDjOlDAY+7XU+Z6ruvEw9Z4K7Rmo+7WKaqac3cW6OlxKEckCkWR6CiwCaf20zE1oBkax/wEj9wF9WqdqD78AEkjyEOh/5J9Ajebg8QZl5EF48K7W37SsgzPYXe0OJfoBXzCofwZWb+Ck/XkugLxQw85Jize1aOzowsHlzNLr5JDUss8phpvKR6MW/StKiswmtCS10rdSLqq5yNRNeobDq2UJneFAOM6UORn7afQVEw4fUCoiNirr/fA3TTNL5du0zTyUI3ZPKZLmfTay1ef7r1b4hOftcUmpHSaq1eX6XIHRPKgsztWxvWD05B3lj8Bb3Iq6bk4l8AqNLELonlYWZpLXrlvG+YSC1XL7q02sYTM0Yp9824hGYtQShe1HZmEkqCN28NxrI9Pfsb9r6HZi9BCEhqwQD4o5LEBISEhISEhISEhISEhISEhISmmSJ2bw7LkEocAmiq2cJoqtQSgVEdIWvpm+C67+xWq5q+DMPoqskfT500Wy6xSWaO7MyrVhEV/dg/CS6eilBKHAFQ3SFb3NoC8LGnSRPwWbiQXSFL1ZEh40LBmiId2omh1IH4x/R1UsJQsErGKIrfN0vz7yqFpc0dYXhBw5EV/ju3fAMc2Pe4EW/zcQIxj+iq5cShIJWUERXqRu+NasrFknuwgfAgegKOrLjlJda28pesZopa6IrKxj/iK5eShAKWkERXXt6aQ5kweAsfABciK5XDIamhBrihQqbmbIlujKC8ZHo6qEEoRxQMETXotB6ePN6Ow6zam1bQ26NXIiuFYOvg8v/yvPozgMaomQ3U7ZEV0YwPhJdPZQglAMKhugKbl4dB8DFFyLsYpGlS8gBcCG6htXZmzaGR9HvsbS2vR93mClboisjGB+Jrh5KEMoBBUN0BZd30HWsbey6Am58yg2z0XAguoZRG9yztLdHig2BhugwU7ZEV0YwPhJdPZQglAMKhuhKkuSpp0GnakvMZiZ/ia74X3kI3IBWKC9JKc10R0RXRjA+El09lCCUAwqG6Er5bUCn7YAbEReiK8kCfNvTq1FoH11ZE10ZwfhIdPVQglAOKBiia/4J9IAkT62Q9qJ7AZ614kF0BdaEWchDoaL4eVQW/atKkpQ90ZURjI9EVw8lCOWAgiG6xraEXpCk+DXjCb5lNs9Xoqu0dl3ddJD1OmN2GaXzkejKCMZHoquHEoRyQMEQXYE9EufI9BTOmX7O5C/RFbTVan02z0znI9GVEYyPRFcPJQjlgAIiukqPHlBAgcaK2SLLCgh/ia7yFw0qWtZAp/OT6MoIxkeiq4cShO5JCaIrliC6CmUtQXQlRQiiq1C2EkRXJEF0FcpegugKJYiuQkFLMCDuuAQhISEhISEhISEhISEhISEhIaHgNf2/xZqZyZZjpvDgD+6OtRbL8oJ8shIM0fVC8vaEx6TlZY+1OrfSxK8Kf9hd8beT2uZDHCLgqwsLo2iBoCe1XFVOeklnp8WOXVz/N/pvb6CylMqsuj3ieuWboQIv6fiIM9EV8bbALitszOP8vqsttoQMQ8jr16112ZzGTKfv4AR3a9UbnWcs+wj46uXl0bNbZ9i3YkiY1rT4Uet2+Z2LFywbWLRpKy12dcMW6zn3wUyZVTcb12sLcBkkEwQkzkTXCm1NJBI5kDTfHmAmZDTFolCz++Zwqn0rMj/B5E09/yPgq0qt22VrVfXSoQh8WyY5lnp3JrrdQoutwIveXYO9QzNlW90MM0nPfxnc4l/ORFdS6eVl+B3TtAldynQHJqcy00/651bUTP/t6XhGNcFoFFlHwFnuxerBFCjzU1/4mGaiabEvL3/aNhLJ3kzZVjfLTFJ3UMxo7kRXvdKvdG0H/y5q1N/KIS+fO+CoseYFpMBw6Eypug2Uhc9jEdj1wdeQPUywqySD/TteWYZfZELpgf72RDS6W/lUa3iefjeLBrc+sL5JD8vIVwfASscaFQJdpc/unUdgVDVVr0aiAfQycDdCjJ3uukK3E1sBYJDx2oOa0ngMnRe9sg3mq1kskt5UJxohdiL+0AJ9T0LTsCNjzah1WC5Niz3ShQZl6Xi0rFa06Pt6pcW+tVKNbvhCzry6GbheM25QYl6Jeh4eRWcwZuJOdDXQ9rCAD0Idn13G74uSlmKHo8Yi0duzbkdLiiFoNZF48oZ0BJkWvi17ec5XKhymUGBX6ZFoB8igC6NcUXqkidc7Zk/rkSwvOlLgVnCseilmvvmPJFe+lDddGktWd3ZWq7PsZ/eOIzDMZNarmShP7UeXtArY7lddcjGTXgDYCZyMnQlYw2Zlx8/DYvfSxVrMhE/pFnUD3HPMMJMdGUtFbcByTVpsyzWEUkzLo2W0orHk6FZQaaCOQQhfzblcrYDhT6bVzcD1mnHX1nQlmp68At9q1qGhky7ORFe9bm5qnWAU2/5X1CaeM1qKHY76kvKsXiAGrRI28S9HhsFlMnb7RL4F7PrycogRLy8zUa5YsUjvQsiOsJjJBLeeV+tlSZ4G7qdUvqT9zd0PiRHlpUaHPusIDDOZ9WomerVvRJbePDEbFH1plQ5HsZjJKGDP9dsxuNOABXnrLNZipp7HwP3lhvp1DLZp2OPDZrIjY6moDViuSYvt6UWZpeXRMlrR9sF3Yd6gjhf9fDE4kD+0Q95ThtXNwPWaceMSgeSRE/m5YyY/ia64bmJ/TyKuIzrVbyZBXVJcVgr0M9GILioIMYZpKBONuGdJatoGds1D1UqjXLFmDd5ashRcCS1mMsGt+AAnqmrpfMnZvdKFrscVepcr6whMMxn1SiWaaOztkfr7vgaVeXSQ/D6A1UxGAUUh2AuI7TDGQBhr6CiWfIda+PMHtO0tZKgvPw1jwmayI2OpqA1YrkmL1Tk36Xi07q2IhFO+I2bUBNwhw+p2x/VScZMSgU4PGgicSRZnomsFgbyNwn4u7NHCuhzfQTdqqimSCV04iiOnQOc2ynvPJnAvmcbnkcsYBX9Akj95p0Xa9nWt1UxmCy0uiW6uxJgUM19ydivsZL1sI9BlqVczUcXg0ZZr1+5PHsGOlvTTIDkKqF2j7n+pCg8uzMp2Foukb1C3TMcAWVT0NguBkDITFbUxI+U0SToerXsrkvKUjvVjuCHFP2mIkqPMsLrdOW5U3HpLCWwmKK2Zwi57ZER0xTOd+05OGG1Ev8y6N8V//B1x4U622MxUoGyY82bVMm9mcmvAlhPxQH2Hpu5/wZKvfnY/vYyOwCDrZRuBy7HQicD96OXl/bU11+LXjK6+u5mk+EPtmrYJjtWpynYWK+EWD6fGB/45QzYn7IxqcDGTGTXTTOl5tAwzSYs2RzVl4zw0Vtz5P61rF1Jm8lrdLDMZcee+mbImutKBkQvNj+pSNEVzutRipp7e/XCsVuGTmcAdqWrXqHKLzte4VNrORLYRuBwLnain91rB9SKpYtX3xgesOzoKgKmfQxcyqrKdxSLRG/Q70+EUZjKDTHtnYvNoWWYCLlqyONqwGnTq4Lv7dDfPc3WzzGSEmetm8oHoSgfmMuKwNcVTw+bDQVxxLdfQ0ey5jo6v0wZ2JTlmaKbCf30IG9e7wOxUvuTEHNFsj1SyjcDlWOhE8lDJU6Dco6H63XnWHe0FfO83sGf6h3bgDKqyncVK+BSZZnIZMxlnm3ymoqbMpI+ZcEHpebTurai88jjIW64HztiG6vLUsGkmz9XtbiYqbspMAY+ZuBFd6bpZ3bAu3zYXZoejVmjwB5Li//uF0RTxbN6lVStBmuNJG9h1Rwk1m+f2EG87fEASi9juTAPod/hgo6DyJWf3+S8hPFU6vhX4baJWyjoCY5rDUq9mItCctE7YKprMxzrbIKWZRteiffvR3BlpWUZlk+OjcpRPFdpuVTfUNwqts3lGoyeTEVTUhplMWqwxm5eGR+veinp64UlCVs5TPyuUCqepppno6q6dSFHdDFyvGbdppnDAs3nciK6WW+4HodGt91me0tjhqOWbtYZ9ndXKClk3B37OBI6vPVzT9SnMjQK7wrn6cLh9kGmmW+D7jZs0m5lADuduRuATGzpf0v4OJxI7d92OvjcdOA1eebOMwGiblno1E0n5J9BM1oBmdqmXLE2ci2xQNWsB5WXqV3Pq4c8a0pVNjo/KsQI+lLKYqXaLWndfhH7OZJqJIGPNqI0DPuzynCk1j5bRisBJqp/zlbqmFrhD3bBxU1cX/M5R3UUhaHZWdTNwvWbchpl+VBfwcyZuRFdr/xU90L5JrR9wwFHRs3q0joKYg6yAgD9tu+CRXWgHE+wqyQWbtI5XnmWaCa6QSCz+Ycg2Znp0cZOWOHvMmq/e/hbpayJWP/bN4qwjcDUTlQhsRxcjy++8wfUJjRS6Fu8LVxkrH71grWz9+MwcH/nTf9gHUejLa+jxkd1MOjLWiFo/YJoWS6+ASMGjZbQi+eGPQN6vwK71vANKdOHxRnq4YxSc3/fvWnZ1s3C9RtyGmd5MBrQCgouyQn3ZxVqbd7foiJqXfSZBiKbFOtfm5bCag1qbx0W+mkkqun4j+0wCU/z9yULU+i0LLbYiwPcaMtTqhu13x2uM3uSvmeRlru8z3SX649kA31XLRlZa7Nz9W3gDcH2SPO3u8b0X+WsmMMwtnZd9LkIZyU6LHbvYfVe4SV4R5Ju2d4EEA2LyJRgQQkJCQkJCQkJCQkJCQkJCQkKZ6h6fx5vcKTMxz8Vfk0h09UjlNOTOcqWXnXl6dSXTYrNRcck353pOnC021SueFSlY1unUEF+iq7H6ED3IZVE5H12c0BKYPVq4YqWqrkJwJxbLNY2ZDtPQCCRWsXAVJVnFC5dLRhsKsr90r35sjbXRk0WlKK6VGFMKy21CVK4ssakOPCu9eNQRWaCs06khvkRXq5kcwq36208mdu56SoFAsZan1U2dndUY58lguaYxU6XDTIxi0fr+mii8OdT+W91weesoernA9/oNg39b6tWGfZ2bUAGViY4nttWpiJ/mMzaVpGJEFiTrdGqIL9HVi5laHldelCDAqVuSntndiPhPeLv7evFUZvrw8vOV1cV7u1MvLkXFls9fugderuGbZ8+p3ymE9wkdXOejsJn0uJa/bJSLKsRnbCpOxYwsMNbp1BBvoqvVTO5Uzp5ek91VgV9YOA0TurBcKYKoK8tVeltRO6K7tQeLrO+1uhWbfwK9lU290i6P0K9EZUBgpV46Qs3ZSUztxy/a4ZeJ0PtfBztgjbtgU+0U0xTYVNv50k8mM7LAWKdTQ7yJrm5mclA5sY5CpOJe/CcinzlZrjRBlMFyjb27QPtplSw5zcQo9gi4ELScPA+9Ko/0UZOHGRBYnWZyEFNxbV87ka9TaQ52dOLi7a+z2immKbCptvPVchJSUnU+kUtkAbJOp4b4El3dzOSgckIV3r+hz3hzf+5++AKzg+VKE0RZLFd53/LN8BunmVyLjX3w5GNGl3DtOnpMkQGB1WkmOzEVqXza4Dt6R05ehrtcDmyqg2KaApvqOF9UZ9AtsgBZp1NDfImubmayUznRX5pWasyCxyKQc+BkudIEURbLNW/wxuqGNbUuZnIpFsL2HzfmUsrLkvTcWAYEVqeZ7MRU+JemKf3Gjw4VKPjXnRzYVDuRJxU21cFONVIxIguOdTo1xJfo6jpmsuGagKbn7TobHSZ0W3nf7G7ZjeVKc9pYxLwvRoDR3vqji5lcir10Zl+deo60OdCVe52ONAMCq8uYSa9N00x7//l1tdJM7kxjyY/wHd5hEjvFNBWczkGoM1IxIguOKDc1xJfo6tFMUAUKnm+QbypoYtzJcvViJl2ezCQhoBaef491z7ZOjGdAYPVkJgndIfDkd/64Pgx1NwlFMb0zMzEiE2biK75EV4Omnt5M+ui4QPkd4o86Wa48zASuCaifBW+HMVYO6QisXs2kTze0to3rYxfWncmgmN6xmdwiE2biK85E1+2kl96J5jMYiFtkWWKmD0PkibCT5UoTRDNhuboXSxiLuMnJzYNXY8wc0hFY05uJ/MoDNlPx8FLjgB3YVOeYiY1NZZiJHVlwrNOpIc5E18NdaPnZkmqD5+igcsY/RhPuLypwln0saSxXc7BcaYJoJixX92JxDnKzWoEi0n9CtXB1D+4TZUBg3XP94zj6vTBXM8HJiA+6huBTNwSMA50983dmHdhUB8U0BTbVxUygy8CKTAqSdTo1xJnoGruqtocjM5UERge7UjnHkomdc3Ym/nxMki4kH+xHo5PzcReWK00QzYDlyigW5LC1/3b0H3Phj540fIsMioxbQAYE1vj74LhmKpqbmTAxFbi6Yd++BvUvslS7ZvZ3zR9+OOzynMlKMU2BTXWYaaIxehb0ItwjC5R1OjXEmegqFX74kaI1DX0OP7OonIvOJrQmtNC1Uv+5HnAMLixXiiCaAcuVUSwGjaLgjF8Jqql1NVM6AitcpLCyYKebmQgxNf7QKjXasKKQ+kkheFQu2FQ7xTQFNtX5exP3l2ibDzEiu9dYp1NDPqG+gmG5vto3NImv/UwuNvXeYp1ODfnFzQuE5Xpj8NZkljaZ2NR7jHU6NeSXmYJgubZcvjqJsMVJxabea6zTqSHfiK73Ost1UrGpgnU6xSUYED5KMCCEhISEhISEhISEhISEhISEhLhKzOb5KDGbx1+C6OqnBNF1KisXiK6S9PnQRbPhFJfgz7yJrvCN+CZzkeyFpNuC2QzFIrpKUvyTHxuvUQAbwHdVuBFdXSMTRFfuygGiqyTPikaHDUeDhoYbEWeiK3w9RHlv6wz9UNdoPpjJId1MrQ1a8gB5yRK+GYHMxInoyohMEF15K3iiK3w3aXiGuTFvEN+lOBNdISThKWrMMmswxNFM5WXK7w00Ebj3NnWhzVyIrszIBNGVq3KB6Ap6muOUl1rbyl5BjYgz0RU03lLqBjuWjLxlMZOvRFdQUdNMp8QiyV24wrkQXZmRCaIrV+UE0fWKAbmUUEO7gBsRb6JrP3wzXFd5WUlx2GYmH4muE42I5EBUMDhL7/1xIbqyIhNEV87KAaJrxeDr8E3V8+jSDRoauSLzJrqG+/JKo9GFF/Bug3mS3Uw+El2rqm9/Au5tn6HOV2vbGr0rwIfoyopMEF05KweIrmF19qaN4VEFzty2tr0fx+l4E11BI+zaEDmXQHSTseR62WEmH4muRaHZn86M1KlwKjwWWbrEmJfgQXRlRyaIrnyVA0TXMOrT7FkKmmlsCE7fonS8ia6gycHb7osKiLG8tGG15DCTj0RXcK8CLbvwO3BwuUK5YU7y8SC6siMT3Dy+ygGiK5lcGwL3jhUKRFlazMSL6EpSwAu7PG33v6SUZsqW6Eq2wFvWjHH4NIlpJh+IruzIhJn4KgeIruRUg297ejUD3cOb6KqbNQx/qkkvlcrJV6Ir2QK/HTBCDEt8iK7syISZ+Cp4oiuZfJKHQkXx8+gGMKLVn7nEm+gqDaCnLjDh9DxULP2zTT4TXXt64Y/koD/2orL0n23iQXRlRyaIrnwVPNFVWruuDpzp/HXz9Ycj9GweN6Kr9K/dENP6xW7jsSlKwofoKi+Dj7sL3zDmrPVuHg+iKyMySRBdeSsHiK7wUZI+m4dEP2fiR3SV96kN+pwXEiGf8yC6wpo8S2bzcE0SM3EhurpHJoiu3JULRFf5iwY1uvAFo5QKegUEN6KrVPjsAk1pPGbswjZT9kRX6YH1CS35yiF9D5KED9HVPTJBdL0bJYiuniWIrkKpJYiu3ksTRFehlBJEV68SRFehNBJEV48SRFehyZNgQPgowYAQEhISEhISEhISEhISEhISEuKs+K+OB30InNXzxAzrBq5TemJSj6tymOgKV08/OebcmtNM18ygrpJ06HdtFmytHetqUCxZvK/MghNgV47KDaIra8uNjn+55Oof0zXVljsVG+rqvmXu/vfj1N52rGtaM2UYnAC78lMuEF2ZW57/0nXtp29M15RbfFMaM0mHFYrM5cC6pjVTpsEJsCs35QLRlbml296ysPxiuqbe4pvSmal8vvFapMvScd/NJMCunJQTRNfw8mdggSclcwtmtJ4a/hh1gNYOJbSm9eitKl+ZrsyCjdrxEepaFPq/Z0EOPzhEbRlp7kAAAPNtcifWFZ8aG9Y1fXC1NXXPlEajpcecwQmwKx/lBNE1DDFvZ6OJK+YWzGg9Onga7juWHK0/ci4KRyL+Ml2ZBRP5CnUtCs1uAserPRU3tySU9rrVEACgt24XrCs6NXasa/rgamtUpSZSp/blO4ITYFdeygGiaxgWCPKGtyGdpIcYrf24C1e/8jjwbT28CfjMdGUVTOQr1LUo1LYWHi+89RgwPTzvX7xcfwXeBeuK0tqxrumDAxeCFTJ8gR12G63BCbArL+UC0RX9G/8YnmKyBTNaB+iufqUNb5o905VdMJHPUFdUxR90DZhbRvD4yGQzuGBdMX7QhnX1AqxFKXaUwJfsbcEJsCsn5QLRFXvmNCTGWbbo4+bPh5oQSs9npiu7YCKfoa5oS/HyskPWLdTI0g3rCjc54HmesYDyyPU9juAEPo+TcoboSn9rNdNYsvq+sapPPJpJl3czOQt2ZuEb1JX6lm0mGuuanZlMvp4wE3/lDtG1k3FnmmhEb69XcjNTp6c7k09QVzgT6vXOhLCu2Zmp5Zq4M02ecoDo6jJ0Ia0c/bdjHDWhIza8qQ9MV2bBziyyh7q6jZnCejn6Hc4F64pv8Dasq2czWcZMhpnEmImPcoDoGialoEk1vAWfdjybV1uTvF+S1rbZ8KY+MF0ZBfOBuhaF4BMGfTYPbwnjnc0egAvWFaWyY13TB1dbA6Ge+mweXasC7MpNOUB0DatdX/VHMICUbMGnnTxnuqF2HJipDOID8pPpyiiYD9S1KDQ7Wb8LPzvSt4Txzgc7nM+ZDKwrSmXHuqYPDj5nOjeHPCO01KoAu3JTDhBdw6HfkIUI5hbys5FoBQRc6pB8+4ddsBxfma6MgvlAXcHdiKyAMLeE8b7NjBUQN6kVEDasa9rgwLHfIisgbLUqwK53kzJFfbGXxTHW5vklRsF8oK7OFXq64h+nWpt3hzInNRwSYNe7SP6Z6fkv13No1ukK5gN1ZZvp1s8Om3/4hXVlm0mAXe8m+Wcm6SXX95n8knvBnKCuTDOVl9LvM/mFdWWaSYBd7yr5aKZYZJzjxBPH1y6cYpkpvt3+pq0vWFeWmQTYdepKMCD8lmBACAkJCQkJCQkJCQkJCQkJCd19+n/jACIUbC8a1gAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyMy0wOS0yN1QwMTozMToyNyswMDowMO5W05QAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjMtMDktMjdUMDE6MzE6MjcrMDA6MDCfC2soAAAAKHRFWHRkYXRlOnRpbWVzdGFtcAAyMDIzLTA5LTI3VDAxOjMxOjI3KzAwOjAwyB5K9wAAAABJRU5ErkJggg==" alt=""/></p><h2 id="load"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#load"><span class="icon icon-link"></span></a>Load</h2><p>Load方法会取出addr地址中的值，即使在多处理器、多核、有CPU cache的情况下，这个操作也能保证Load是一个原子操作。</p><p>它支持的数据类型和方法如图所示：</p><p><img src="data:image/png;base64,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" alt=""/></p><h2 id="store"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#store"><span class="icon icon-link"></span></a>Store</h2><p>Store方法会把一个值存入到指定的addr地址中，即使在多处理器、多核、有CPU cache的情况下，这个操作也能保证Store是一个原子操作。别的goroutine通过Load读取出来，不会看到存取了一半的值。</p><p>它支持的数据类型和方法如图所示：</p><p><img src="data:image/png;base64,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" alt=""/></p><h2 id="value类型"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#value类型"><span class="icon icon-link"></span></a>Value类型</h2><p>刚刚说的都是一些比较常见的类型，其实，atomic还提供了一个特殊的类型：Value。它可以原子地存取对象类型，但也只能存取，不能CAS和Swap，常常用在配置变更等场景中。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>接下来，我以一个配置变更的例子，来演示Value类型的使用。这里定义了一个Value类型的变量config， 用来存储配置信息。</p><p>首先，我们启动一个goroutine，然后让它随机sleep一段时间，之后就变更一下配置，并通过我们前面学到的Cond并发原语，通知其它的reader去加载新的配置。</p><p>接下来，我们启动一个goroutine等待配置变更的信号，一旦有变更，它就会加载最新的配置。</p><p>通过这个例子，你可以了解到Value的Store/Load方法的使用，因为它只有这两个方法，只要掌握了它们的使用，你就完全掌握了Value类型。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">type Config struct {</span></div><div class="token-line"><span class="token plain">        NodeName string</span></div><div class="token-line"><span class="token plain">        Addr     string</span></div><div class="token-line"><span class="token plain">        Count    int32</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func loadNewConfig() Config {</span></div><div class="token-line"><span class="token plain">        return Config{</span></div><div class="token-line"><span class="token plain">            NodeName: &quot;北京&quot;,</span></div><div class="token-line"><span class="token plain">            Addr:     &quot;10.77.95.27&quot;,</span></div><div class="token-line"><span class="token plain">            Count:    rand.Int31(),</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    func main() {</span></div><div class="token-line"><span class="token plain">        var config atomic.Value</span></div><div class="token-line"><span class="token plain">        config.Store(loadNewConfig())</span></div><div class="token-line"><span class="token plain">        var cond = sync.NewCond(&amp;sync.Mutex{})</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        // 设置新的config</span></div><div class="token-line"><span class="token plain">        go func() {</span></div><div class="token-line"><span class="token plain">            for {</span></div><div class="token-line"><span class="token plain">                time.Sleep(time.Duration(5+rand.Int63n(5)) * time.Second)</span></div><div class="token-line"><span class="token plain">                config.Store(loadNewConfig())</span></div><div class="token-line"><span class="token plain">                cond.Broadcast() // 通知等待着配置已变更</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">        }()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        go func() {</span></div><div class="token-line"><span class="token plain">            for {</span></div><div class="token-line"><span class="token plain">                cond.L.Lock()</span></div><div class="token-line"><span class="token plain">                cond.Wait()                 // 等待变更信号</span></div><div class="token-line"><span class="token plain">                c := config.Load().(Config) // 读取新的配置</span></div><div class="token-line"><span class="token plain">                fmt.Printf(&quot;new config: %+v\n&quot;, c)</span></div><div class="token-line"><span class="token plain">                cond.L.Unlock()</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">        }()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        select {}</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>好了，关于标准库的atomic提供的方法，到这里我们就学完了。事实上，atomic包提供了非常好的支持各种平台的一致性的API，绝大部分项目都是直接使用它。接下来，我再给你介绍一下第三方库，帮助你稍微开拓一下思维。</p><h1 id="第三方库的扩展"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#第三方库的扩展"><span class="icon icon-link"></span></a>第三方库的扩展</h1><p>其实，atomic的API已经算是很简单的了，它提供了包一级的函数，可以对几种类型的数据执行原子操作。</p><p>不过有一点让人觉得不爽的是，或者是让熟悉面向对象编程的程序员不爽的是，函数调用有一点点麻烦。所以，有些人就对这些函数做了进一步的包装，跟atomic中的Value类型类似，这些类型也提供了面向对象的使用方式，比如关注度比较高的<a target="_blank" rel="noopener noreferrer" href="https://github.com/uber-go/atomic">uber-go/atomic<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，它定义和封装了几种与常见类型相对应的原子操作类型，这些类型提供了原子操作的方法。这些类型包括Bool、Duration、Error、Float64、Int32、Int64、String、Uint32、Uint64等。</p><p>比如Bool类型，提供了CAS、Store、Swap、Toggle等原子方法，还提供String、MarshalJSON、UnmarshalJSON等辅助方法，确实是一个精心设计的atomic扩展库。关于这些方法，你一看名字就能猜出来它们的功能，我就不多说了。</p><p>其它的数据类型也和Bool类型相似，使用起来就像面向对象的编程一样，你可以看下下面的这段代码。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">var running atomic.Bool</span></div><div class="token-line"><span class="token plain">        running.Store(true)</span></div><div class="token-line"><span class="token plain">        running.Toggle()</span></div><div class="token-line"><span class="token plain">        fmt.Println(running.Load()) // false</span></div></pre></div><h1 id="使用atomic实现lock-free-queue"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#使用atomic实现lock-free-queue"><span class="icon icon-link"></span></a>使用atomic实现Lock-Free queue</h1><p>atomic常常用来实现Lock-Free的数据结构，这次我会给你展示一个Lock-Free queue的实现。</p><p>Lock-Free queue最出名的就是 Maged M. Michael 和 Michael L. Scott 1996年发表的<a target="_blank" rel="noopener noreferrer" href="https://www.cs.rochester.edu/u/scott/papers/1996_PODC_queues.pdf">论文<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中的算法，算法比较简单，容易实现，伪代码的每一行都提供了注释，我就不在这里贴出伪代码了，因为我们使用Go实现这个数据结构的代码几乎和伪代码一样：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">package queue</span></div><div class="token-line"><span class="token plain">    import (</span></div><div class="token-line"><span class="token plain">    	&quot;sync/atomic&quot;</span></div><div class="token-line"><span class="token plain">    	&quot;unsafe&quot;</span></div><div class="token-line"><span class="token plain">    )</span></div><div class="token-line"><span class="token plain">    // lock-free的queue</span></div><div class="token-line"><span class="token plain">    type LKQueue struct {</span></div><div class="token-line"><span class="token plain">    	head unsafe.Pointer</span></div><div class="token-line"><span class="token plain">    	tail unsafe.Pointer</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    // 通过链表实现，这个数据结构代表链表中的节点</span></div><div class="token-line"><span class="token plain">    type node struct {</span></div><div class="token-line"><span class="token plain">    	value interface{}</span></div><div class="token-line"><span class="token plain">    	next  unsafe.Pointer</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    func NewLKQueue() *LKQueue {</span></div><div class="token-line"><span class="token plain">    	n := unsafe.Pointer(&amp;node{})</span></div><div class="token-line"><span class="token plain">    	return &amp;LKQueue{head: n, tail: n}</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    // 入队</span></div><div class="token-line"><span class="token plain">    func (q *LKQueue) Enqueue(v interface{}) {</span></div><div class="token-line"><span class="token plain">    	n := &amp;node{value: v}</span></div><div class="token-line"><span class="token plain">    	for {</span></div><div class="token-line"><span class="token plain">    		tail := load(&amp;q.tail)</span></div><div class="token-line"><span class="token plain">    		next := load(&amp;tail.next)</span></div><div class="token-line"><span class="token plain">    		if tail == load(&amp;q.tail) { // 尾还是尾</span></div><div class="token-line"><span class="token plain">    			if next == nil { // 还没有新数据入队</span></div><div class="token-line"><span class="token plain">    				if cas(&amp;tail.next, next, n) { //增加到队尾</span></div><div class="token-line"><span class="token plain">    					cas(&amp;q.tail, tail, n) //入队成功，移动尾巴指针</span></div><div class="token-line"><span class="token plain">    					return</span></div><div class="token-line"><span class="token plain">    				}</span></div><div class="token-line"><span class="token plain">    			} else { // 已有新数据加到队列后面，需要移动尾指针</span></div><div class="token-line"><span class="token plain">    				cas(&amp;q.tail, tail, next)</span></div><div class="token-line"><span class="token plain">    			}</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    // 出队，没有元素则返回nil</span></div><div class="token-line"><span class="token plain">    func (q *LKQueue) Dequeue() interface{} {</span></div><div class="token-line"><span class="token plain">    	for {</span></div><div class="token-line"><span class="token plain">    		head := load(&amp;q.head)</span></div><div class="token-line"><span class="token plain">    		tail := load(&amp;q.tail)</span></div><div class="token-line"><span class="token plain">    		next := load(&amp;head.next)</span></div><div class="token-line"><span class="token plain">    		if head == load(&amp;q.head) { // head还是那个head</span></div><div class="token-line"><span class="token plain">    			if head == tail { // head和tail一样</span></div><div class="token-line"><span class="token plain">    				if next == nil { // 说明是空队列</span></div><div class="token-line"><span class="token plain">    					return nil</span></div><div class="token-line"><span class="token plain">    				}</span></div><div class="token-line"><span class="token plain">    				// 只是尾指针还没有调整，尝试调整它指向下一个</span></div><div class="token-line"><span class="token plain">    				cas(&amp;q.tail, tail, next)</span></div><div class="token-line"><span class="token plain">    			} else {</span></div><div class="token-line"><span class="token plain">    				// 读取出队的数据</span></div><div class="token-line"><span class="token plain">    				v := next.value</span></div><div class="token-line"><span class="token plain">                    // 既然要出队了，头指针移动到下一个</span></div><div class="token-line"><span class="token plain">    				if cas(&amp;q.head, head, next) {</span></div><div class="token-line"><span class="token plain">    					return v // Dequeue is done.  return</span></div><div class="token-line"><span class="token plain">    				}</span></div><div class="token-line"><span class="token plain">    			}</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    // 将unsafe.Pointer原子加载转换成node</span></div><div class="token-line"><span class="token plain">    func load(p *unsafe.Pointer) (n *node) {</span></div><div class="token-line"><span class="token plain">    	return (*node)(atomic.LoadPointer(p))</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    // 封装CAS,避免直接将*node转换成unsafe.Pointer</span></div><div class="token-line"><span class="token plain">    func cas(p *unsafe.Pointer, old, new *node) (ok bool) {</span></div><div class="token-line"><span class="token plain">    	return atomic.CompareAndSwapPointer(</span></div><div class="token-line"><span class="token plain">    		p, unsafe.Pointer(old), unsafe.Pointer(new))</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>我来给你介绍下这里的主要逻辑。</p><p>这个lock-free的实现使用了一个辅助头指针（head），头指针不包含有意义的数据，只是一个辅助的节点，这样的话，出队入队中的节点会更简单。</p><p>入队的时候，通过CAS操作将一个元素添加到队尾，并且移动尾指针。</p><p>出队的时候移除一个节点，并通过CAS操作移动head指针，同时在必要的时候移动尾指针。</p><h1 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#总结"><span class="icon icon-link"></span></a>总结</h1><p>好了，我们来小结一下。这节课，我们学习了atomic的基本使用方法，以及它提供的几种方法，包括Add、CAS、Swap、Load、Store、Value类型。除此之外，我还介绍了一些第三方库，并且带你实现了Lock-free queue。到这里，相信你已经掌握了atomic提供的各种方法，并且能够应用到实践中了。</p><p>最后，我还想和你讨论一个额外的问题：对一个地址的赋值是原子操作吗？</p><p>这是一个很有趣的问题，如果是原子操作，还要atomic包干什么？官方的文档中并没有特意的介绍，不过，在一些issue或者论坛中，每当有人谈到这个问题时，总是会被建议用atomic包。</p><p><a target="_blank" rel="noopener noreferrer" href="https://dave.cheney.net/2018/01/06/if-aligned-memory-writes-are-atomic-why-do-we-need-the-sync-atomic-package">Dave Cheney<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>就谈到过这个问题，讲得非常好。我来给你总结一下他讲的知识点，这样你就比较容易理解使用atomic和直接内存操作的区别了。</p><p>在现在的系统中，write的地址基本上都是对齐的（aligned）。 比如，32位的操作系统、CPU以及编译器，write的地址总是4的倍数，64位的系统总是8的倍数（还记得WaitGroup针对64位系统和32位系统对state1的字段不同的处理吗）。对齐地址的写，不会导致其他人看到只写了一半的数据，因为它通过一个指令就可以实现对地址的操作。如果地址不是对齐的话，那么，处理器就需要分成两个指令去处理，如果执行了一个指令，其它人就会看到更新了一半的错误的数据，这被称做撕裂写（torn write） 。所以，你可以认为赋值操作是一个原子操作，这个“原子操作”可以认为是保证数据的完整性。</p><p>但是，对于现代的多处理多核的系统来说，由于cache、指令重排，可见性等问题，我们对原子操作的意义有了更多的追求。在多核系统中，一个核对地址的值的更改，在更新到主内存中之前，是在多级缓存中存放的。这时，多个核看到的数据可能是不一样的，其它的核可能还没有看到更新的数据，还在使用旧的数据。</p><p>多处理器多核心系统为了处理这类问题，使用了一种叫做内存屏障（memory fence或memory barrier）的方式。一个写内存屏障会告诉处理器，必须要等到它管道中的未完成的操作（特别是写操作）都被刷新到内存中，再进行操作。此操作还会让相关的处理器的CPU缓存失效，以便让它们从主存中拉取最新的值。</p><p>atomic包提供的方法会提供内存屏障的功能，所以，atomic不仅仅可以保证赋值的数据完整性，还能保证数据的可见性，一旦一个核更新了该地址的值，其它处理器总是能读取到它的最新值。但是，需要注意的是，因为需要处理器之间保证数据的一致性，atomic的操作也是会降低性能的。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage531353d55255fe851754659d90cbee814f13.f38615cd.jpg" alt=""/></p><h1 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/03.原子操作/01#思考题"><span class="icon icon-link"></span></a>思考题</h1><p>atomic.Value只有Load/Store方法，你是不是感觉意犹未尽？你可以尝试为Value类型增加 Swap和CompareAndSwap方法（可以参考一下<a target="_blank" rel="noopener noreferrer" href="https://github.com/golang/go/issues/39351">这份资料<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。</p><p>欢迎在留言区写下你的思考和答案，我们一起交流讨论。如果你觉得有所收获，也欢迎你把今天的内容分享给你的朋友或同事。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/go并发编程实战/03.原子操作/01.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/27 11:15:40</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-backend/umi.e14e5a14.js"></script>
  </body>
</html>
