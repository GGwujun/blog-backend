<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-backend/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-backend";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>03｜Mutex：4种易错场景大盘点 - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/go并发编程实战/02.基本并发原语/03" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-backend/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>后端开发<ul><li><a href="/blog-backend/go语言核心36讲">go语言核心36讲</a></li><li><a aria-current="page" class="active" href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/kafka核心技术与实战">kafka核心技术与实战</a></li><li><a href="/blog-backend/kafka核心源码解读">kafka核心源码解读</a></li><li><a href="/blog-backend/零基础学python">零基础学python</a></li><li><a href="/blog-backend/python核心技术与实战">python核心技术与实战</a></li><li><a href="/blog-backend/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-backend/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-backend/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-backend/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-backend/后端存储实战课">后端存储实战课</a></li><li><a href="/blog-backend/后端技术面试38讲">后端技术面试38讲</a></li><li><a href="/blog-backend/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li><li><a href="/blog-backend/现代c编程实战">现代c编程实战</a></li><li><a href="/blog-backend/罗剑锋的c实战笔记">罗剑锋的c实战笔记</a></li><li><a href="/blog-backend/零基础入门spark">零基础入门spark</a></li></ul></span><span>架构师<ul><li><a href="/blog-backend/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-backend/数据中台实战课">数据中台实战课</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-backend/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>后端开发<ul><li><a href="/blog-backend/go语言核心36讲">go语言核心36讲</a></li><li><a aria-current="page" class="active" href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/kafka核心技术与实战">kafka核心技术与实战</a></li><li><a href="/blog-backend/kafka核心源码解读">kafka核心源码解读</a></li><li><a href="/blog-backend/零基础学python">零基础学python</a></li><li><a href="/blog-backend/python核心技术与实战">python核心技术与实战</a></li><li><a href="/blog-backend/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-backend/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-backend/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-backend/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-backend/后端存储实战课">后端存储实战课</a></li><li><a href="/blog-backend/后端技术面试38讲">后端技术面试38讲</a></li><li><a href="/blog-backend/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li><li><a href="/blog-backend/现代c编程实战">现代c编程实战</a></li><li><a href="/blog-backend/罗剑锋的c实战笔记">罗剑锋的c实战笔记</a></li><li><a href="/blog-backend/零基础入门spark">零基础入门spark</a></li></ul></li><li>架构师<ul><li><a href="/blog-backend/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-backend/数据中台实战课">数据中台实战课</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-backend/go并发编程实战/01.开篇词">01.开篇词</a><ul><li><a href="/blog-backend/go并发编程实战/01.开篇词/01"><span>开篇词 | 想吃透Go并发编程，你得这样学！</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-backend/go并发编程实战/02.基本并发原语">02.基本并发原语</a><ul><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/01"><span>01 | Mutex：如何解决资源并发访问问题？</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/02"><span>02 | Mutex：庖丁解牛看实现</span></a></li><li><a aria-current="page" class="active" href="/blog-backend/go并发编程实战/02.基本并发原语/03"><span>03｜Mutex：4种易错场景大盘点</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/04"><span>04｜ Mutex：骇客编程，如何拓展额外功能？</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/05"><span>05｜ RWMutex：读写锁的实现原理及避坑指南</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/06"><span>06 | WaitGroup：协同等待，任务编排利器</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/07"><span>07 | Cond：条件变量的实现机制及避坑指南</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/08"><span>08 | Once：一个简约而不简单的并发原语</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/09"><span>09 | map：如何实现线程安全的map类型？</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/10"><span>10 | Pool：性能提升大杀器</span></a></li><li><a href="/blog-backend/go并发编程实战/02.基本并发原语/11"><span>11 | Context：信息穿透上下文</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/03.原子操作">03.原子操作</a><ul><li><a href="/blog-backend/go并发编程实战/03.原子操作/01"><span>12 | atomic：要保证原子操作，一定要使用这几种方法</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/04.channel">04.Channel</a><ul><li><a href="/blog-backend/go并发编程实战/04.channel/01"><span>13 | Channel：另辟蹊径，解决并发问题</span></a></li><li><a href="/blog-backend/go并发编程实战/04.channel/02"><span>14 | Channel：透过代码看典型的应用模式</span></a></li><li><a href="/blog-backend/go并发编程实战/04.channel/03"><span>15 | 内存模型：Go如何保证并发读写的顺序？</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/05.扩展并发原语">05.扩展并发原语</a><ul><li><a href="/blog-backend/go并发编程实战/05.扩展并发原语/01"><span>16 | Semaphore：一篇文章搞懂信号量</span></a></li><li><a href="/blog-backend/go并发编程实战/05.扩展并发原语/02"><span>17 | SingleFlight 和 CyclicBarrier：请求合并和循环栅栏该怎么用？</span></a></li><li><a href="/blog-backend/go并发编程实战/05.扩展并发原语/03"><span>18 | 分组操作：处理一组子任务，该用什么并发原语？</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/06.分布式并发原语">06.分布式并发原语</a><ul><li><a href="/blog-backend/go并发编程实战/06.分布式并发原语/01"><span>19 |  在分布式环境中，Leader选举、互斥锁和读写锁该如何实现？</span></a></li><li><a href="/blog-backend/go并发编程实战/06.分布式并发原语/02"><span>20 | 在分布式环境中，队列、栅栏和STM该如何实现？</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/07.结束语">07.结束语</a><ul><li><a href="/blog-backend/go并发编程实战/07.结束语/01"><span>结束语 | 再聊Go并发编程的价值和精进之路</span></a></li></ul></li><li><a href="/blog-backend/go并发编程实战/summary">go并发编程实战</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="Lock/Unlock不是成对出现" data-depth="2"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#lockunlock不是成对出现"><span>Lock/Unlock不是成对出现</span></a></li><li title="Copy已使用的Mutex" data-depth="2"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#copy已使用的mutex"><span>Copy已使用的Mutex</span></a></li><li title="重入" data-depth="2"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#重入"><span>重入</span></a></li><li title="死锁" data-depth="2"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#死锁"><span>死锁</span></a></li><li title="Docker" data-depth="2"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#docker"><span>Docker</span></a></li><li title="issue 36114" data-depth="3"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-36114"><span>issue 36114</span></a></li><li title="issue 34881" data-depth="3"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-34881"><span>issue 34881</span></a></li><li title="Kubernetes" data-depth="2"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#kubernetes"><span>Kubernetes</span></a></li><li title="issue 72361" data-depth="3"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-72361"><span>issue 72361</span></a></li><li title="issue 45192" data-depth="3"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-45192"><span>issue 45192</span></a></li><li title="gRPC" data-depth="2"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#grpc"><span>gRPC</span></a></li><li title="issue 795" data-depth="3"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-795"><span>issue 795</span></a></li><li title="etcd" data-depth="2"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#etcd"><span>etcd</span></a></li><li title="issue 10419" data-depth="2"><a href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-10419"><span>issue 10419</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="03mutex4种易错场景大盘点"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#03mutex4种易错场景大盘点"><span class="icon icon-link"></span></a>03｜Mutex：4种易错场景大盘点</h1><p>你好，我是鸟窝。</p><p>上一讲，我带你一起领略了Mutex的架构演进之美，现在我们已经清楚Mutex的实现细节了。当前Mutex的实现貌似非常复杂，其实主要还是针对饥饿模式和公平性问题，做了一些额外处理。但是，我们在第一讲中已经体验过了，Mutex使用起来还是非常简单的，毕竟，它只有Lock和Unlock两个方法，使用起来还能复杂到哪里去？</p><p>正常使用Mutex时，确实是这样的，很简单，基本不会有什么错误，即使出现错误，也是在一些复杂的场景中，比如跨函数调用Mutex或者是在重构或者修补Bug时误操作。但是，我们使用Mutex时，确实会出现一些Bug，比如说忘记释放锁、重入锁、复制已使用了的Mutex等情况。那在这一讲中，我们就一起来看看使用Mutex常犯的几个错误，做到“Bug提前知，后面早防范”。</p><h1 id="常见的4种错误场景"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#常见的4种错误场景"><span class="icon icon-link"></span></a>常见的4种错误场景</h1><p>我总结了一下，使用Mutex常见的错误场景有4类，分别是Lock/Unlock不是成对出现、Copy已使用的Mutex、重入和死锁。下面我们一一来看。</p><h2 id="lockunlock不是成对出现"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#lockunlock不是成对出现"><span class="icon icon-link"></span></a>Lock/Unlock不是成对出现</h2><p>Lock/Unlock没有成对出现，就意味着会出现死锁的情况，或者是因为Unlock一个未加锁的Mutex而导致panic。</p><p>我们先来看看缺少Unlock的场景，常见的有三种情况：</p><ol><li>代码中有太多的if-else分支，可能在某个分支中漏写了Unlock；</li><li>在重构的时候把Unlock给删除了；</li><li>Unlock误写成了Lock。</li></ol><p>在这种情况下，锁被获取之后，就不会被释放了，这也就意味着，其它的goroutine永远都没机会获取到锁。</p><p>我们再来看缺少Lock的场景，这就很简单了，一般来说就是误操作删除了Lock。 比如先前使用Mutex都是正常的，结果后来其他人重构代码的时候，由于对代码不熟悉，或者由于开发者的马虎，把Lock调用给删除了，或者注释掉了。比如下面的代码，mu.Lock()一行代码被删除了，直接Unlock一个未加锁的Mutex会panic：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">func foo() {</span></div><div class="token-line"><span class="token plain">        var mu sync.Mutex</span></div><div class="token-line"><span class="token plain">        defer mu.Unlock()</span></div><div class="token-line"><span class="token plain">        fmt.Println(&quot;hello world!&quot;)</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>运行的时候panic：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAz8AAAC9CAMAAACqGzM/AAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAAGPUExURQArNoWZAGqUtSaL0hdkbXNnKwArImOZAHeZAIWVnR6L0iZwjSZxkZOhoZOhg0ArNgBLdnyhg4WFGR8rIoV2IiFfVQA/iSGL0iaLnhErNglftCZtcQArcRyL0iaLtBc/cRFt0jp2AB8rKx9BNjpnGR8rNgArK1GFAIWZClFBNgBBGXOZAGN2ImNWNgBWEhxRNiZ6iQkrVQk/NhFfiQkrNgArVRd60gkrcQBRngArU1WQoZOhkVVxg5OQdiYrNgArZ2ihoZOAZ0CAoXxxdmhhNgBhg0Bhg4WZEjorK2NWIh9nCmNWKxc/NnxxU1VLNnyhoVVhNjorNhErVWihkXyhkVVxkYWZMV6StUCL0iaLwxFXbQcrNpOQkTorIoWZXFCL0hErcRdfVSaLswwrNjpnCh9WEhFftAlRnlFnIoWXgBdfcSZ9o3eVnR5wjVWQkUArZ2iQkXyQdiZLdmihg0CAkXyAZ3yQg3yQkXyQoWhxdkCAgyZhg2hxU2iAoSYrZyZxdlWQg2iQdkBLdkArU////z4n4YoAAAABYktHRIRi0FpxAAAAB3RJTUUH5wkbARwx+/YEJQAAAAFvck5UAc+id5oAABZOSURBVHja7Z2Jn+RGdce1mZg1G/XO2NjBLNgBErMcsXedGLOz12w3I0wceoZjlzsXkBtsfBvsmBz/eFTHe1X1qqoldbeOnv59P/ZopZaqJHW9rkP1068oai71xB8d9MsfFwCMT1McPFYUn7jsLdvy+Cf7jZ8rf9LP/Shns6uHie1HTxx2TgtcfJoj4clPXQ6WLePnUr8BdOWgpwDKRAriB6TYXvw8FdRPj18SAfR0Ufzpp731Zz5TFNdSkfHZzz2b2iyOv3LQVwAhfkB7eowfWQN91i//z/3Zs3UIfb59/Ijj6/jpKYAQP6A9rvjXK1+oo+SLf178xfNfun7py18piq9+LYqfJz/1l7Yn9EJRvOgd97xK7cUgfkQABeVfc+Pawc2X/qr465e//srNbzyr97j5skrnlvrQLuqjbr78+VT8BAF0fHt25+69+8XJg9ls7l/h4pv1llNd/qt794+e+FbQw4m320jhdBazWZ2s2lrOTlvkB/YJKu+vfvv6pUt/c7mOn+uPfeLyC69d+tt6/YUX4/h5/kWzvf7/y195jY9L1T8igKL4UfXPzZdeefpzz964RvHD9c+NWwfPfeeaDjJbT8Xx4wfQYl4X6bo86+XSu8LFnbPCi5Pzud6XiLfb+KF0Fip4vqu2lsHAQjY/sE9w/HzvNYqSp776tRfMylOqAhLx88XreruOG7W0x6XjJwggET9PFypQ6ript8fx88z3X7HrdUfp1kEmflwAnfzgTMcBLd0VLnTh5jh5GH4ebzfxE6Sn93vkJ7oiP7BPuG5O3QB7zYsf1S4rEvGj/tZ7mPZa/bk9Lh0/P/zRj1fWP9ey8WPacfqIp22HKBE/P/npz+x1uHbY4er4EZ/H2038BNvV+vnPz73W24r8wD4hRwAofl793hfS9Y+Nn1f/7nJwXDJ+/v4fVvd/VH8nV//8I40i3PzGP5kD4/j5xS/5OlrXPy3jJ65/Diu//Yb6Byi4+vmViJ9vqyEEFT86ki7RkuJH94Ge/Gc+zrbsgvgJw4fK/3PfUcub/6L+dYvrH9XHsZ+89Irt/xzc/FfTSbpxKxk/Xvis6v/olZMHp/pzGT/xdrWlSPV/9D8Lkwv6P0DDBf6xovjSda/9ptb/TQ/APUUNNLXk+FHjb2phj3MDchw///7jIHpUbioCTJSo5zmqX0Pxoz7/+n/oT27w+Fu9+sxnbh3oP3w8x89//sy/EBoPq5di/M0U7mqmP4/aW/H2esuycOm48beTB/OC4yebH9gnGh//rMnjIny2zRURPpqh21Fot+09vcVPv+FzcEWGT3U6bDtq6PzAJOkrfn7da/QcHPwmupLFwO2oofMDU6Sv+Ok5fA7Gvm8AAAAAAGMh5xWTfiynI8sR7I9xKbAnxPPyecZKxxn73v6IH7An9Bg/C4zugosO4geA9XG6MXqeIeIn1Icd39aTw8q5py/T+jR/fz2vBfED9gDWjfE8SBE/Yn6kCYr6L283+rRwf8QP2A9IN+bm4YfxI+fnV/M6Lo5fP3PbKUyi/RE/4MLj9MuzmZ5oLOIn1su88ds333ri0G0P48fbf3Ha/XQA2CmovJ+8fehvKXL1z8kP7i7fuTsvWtQ/AFx4uL5QfaCjdwvWj0kdGbF476x6f+ltp/jx90f7DewHXjvMNN9IPxbpyCzl1cMj9SYApy+jMOH9Mf4GAAAAAAAAAAAAAAAAYAscnc/yzzu76uj6Yg1fuLWuK5kengeDPA3PaabifNPZl2et60L8gG5YSQJTid/lXY0feV0bpLcyfqpJ1M9gLBA/jVsRPyCDmoajJ+6of6j3POt52POC1uMStRC6ObuM9HR2FhxRzfRWPUuuLtqBbs9/L7tlbV84+zlf19rp2et0ekCTzsMPZr87v3MWzlufu/31++bPMfV8b7C/0++cWf81+3vK6yJ+It2cXUbbw3jQ87J/f6ilqyoLp9sz/gbZ+FnLF25ZyPqnc3q8fR6c2dHDs/rzxdLNG7T3y5tPSzNwwT7glTO/PPB6GD+xbsH6g0TbQ04eeDKHuqwFur0Em/rCZeOnZXo5fx/lA3Tvfhw/br+6wsJ7ffcIW84qau/Y+Kmkns7gdHZh/MR6OoE60FQLS1XWpL9btPuGvnDZ+GmZHl1nwm8rGT/uvhQlOkT7hClnus3h/57yuqh/WGfXrf5RmJSrex/afkar+mdNX7i28ZNLj66zdf3j6Q8fYbh7j7DxU5cT087XLRxvXbTmWWcXxk+spxP9mY9cZKp6yOn20v2f7r5w7vxS/Z/O6dF1yv6PjR9Kj+4X768+WKABtz/QK6lmrHvTA0lunfR0FhovE/ET6enE+JtKzw44qDCKdXvxeF03Xzi+HPu5GL/unJ49L6cH1FD8UHqFG3jT++tjgxMCYKuUKFwArAtGdwFYmwVGdwEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGJGO759q/T7odLrHt6dhgAfAKOTe0NsaGOyAC0DLYlzOhOso4geADsW4QvyAvYHe7yz94+x65LNWmd0C/7iw45KJH5Ou9IHjdGS67r3TNn7E+7EBmALkLyD94+x65LNm+/nOP46OY3Lxo9OVPnDODy6VLuIHTJvYZy3088nGz0N5HJOLn8Bni453fnDZdNF+A5Ml9pUS5TwXP0G7bo34idIX6Xo+I4gfMFXWrn/IP+7tqHBvJX5Q/4CdIO7/BH5ykc+aKOfOj45ZGT/SBy4XP+j/gJ2AxrmkfxytC581tVkNkMX+cZZKtufC+JE+cLSM0sX4G9gVqj5L5gZ+7jaO0H4Dk6U6lePP02Cq5wVAQPT8cyJM9bwAAAAAAAAAF5hWejk97tzAYpThgHFyBaALLeKn11Hyjc4MgK3TdtqM2a9FKTUVgXpQKmqESmzQ6+o57GnBS/18NXVGMr1Iv4cKCIzBtuPHzkNYzPUcHo+jJ/5rGa2rKUFH56e8zD4LitOT9VzH9zUA0IWMrk3q5R5+MPvduZLwhM9laD9PT+fr745v66JdkhLPRJFaXdSlXAWG2kXXEDQPiNYLV3PUy1z8xOlR/PB5ogEHeiSta0vofcqrh3VBjvRytv7h40L9nQkB9dcUa18nYeqN0uyky/933XpRUPDppW6/JUIoTs9m5M4T8QN6JK1rS+gV6q11GY30cjZ+Hqb1D9W83nD8+pmLnzcezPUhdl7c0Zv31SH8lgS7rs/M1nO0NNVLSJSezcg7T8QP6JHWejkdP7Fezuv/JPV3b/z2zbfUiinGvl5Bl3pVzhdLLuS0XpgayV8mezIyvcKueeeJ+AE90i1+Yr1cOn6cLu/u8p27c9ri+iv1EY90l2WmC/rHtv6h9fuJ8EnFj0yvoPrHnSfGD0CPpHVtCb2cjh+nlyM9jtlPxg/3PxbvnVXvL11GNF6m/nADze//eOv63zaXj6j9JnRAcXrc/7G6Poxfgx5J69qKWC9n4scbJ6MSbsbfRPyQ/q5uVdl+i+rZ8POakwdz+4dOwdPhqfacrofcUj3X0c+DZPzI9Fi/t0DzDVwotlMRiKc9A+UKwMVgpGlAAAAAAAAAAAAA6J1ytvo1VE2fb/NU1nyeOpXnsEfnMwyhbMCO3r+m5zB4TtMSDMhvxvTu32Le4vMO8ZNLr1U+OVromZrS7wLp+ORS/SOVjdAB8vw90hF6OyaffyV0icH2zJLzkceTH5Ratvm53nb+dJ82yD/QYcr7R+lGnw9Pk8Oc+bx9/OTSa5dPjub42dgpT2Rov/ZwqWa5VsEXFs5r8tD+S+/KeeeZ+EkcH2zPLW0+8ni1zf3f4ndly/nTfdog/0CHKe8fpRt/Pjysjqv830uroyuo42Djw/ncmfhXvxtino3eP/LFs9uj9N28n9Lzz1tHD2iu45FZt+cl/fGi931H58nzi5LxkyhjOn4SOkB3R7wWh5lPpa7rUVCPxceb86TtuSXl49YXge+gPl+/52fvf9/5032S+bt8w+8hr8ss3Pywubt/Qbrjtuj0qQe+I7/XOtQ7Z97nXBp4XqmdL/rOmWzfmf0jXwizPUrfzTslgfi6ekBzHed23Z6X9McL5rkWqfNcHT86HsP2iP72EjpAbk6GNY5Zo/Ms9XR193vBx9vzzPnFePMczVTbwPfC8x0U2l+6//3nb++TyJ+/H5t+Nn+pw/S+n1N71yndTI0+FKUpF/R7RdfKQV3aGdROv01xRlScAu8f+xLZ7SJ9Lx2bz9p6wJJnnXslXvrjyTZe4jyDq5JLLx7NyfD3H+kAOauwW2bj52GYnzyeDqbtuWXBv39mna7DtG/U5+XsjnfJdP/7zt/dpzD/wJ/QI6fLpPvnvh+KFpfuNru93bHfJ8W/aih5cgV3vqF+jqOF50vTljA997ti0xHpu1Yf5bOuHlBcR0XtpIQ/UfC9xb+nlkz9E+0n6h/WAZaxACpxv8V50PF0ni1+/4PfP74f9T9UuzTqf9j733f+ztcmzD8qP5n8pQ5Tfs9euuL+Do18rwGVVIofusnp+kfXtUH9Y/aPf9fdl+Wn736H6PN19YD2Ouj3zZ6XjJ9N6x+dXyJ+Yh0gtS7k1xvWP1R/yeP5/jb2P0w+vN3XR5ZWlyIKq7qTfedP90nmL+ufXP5Sh+muy/v90X9GDh8eDrT6u49E/HDj0rbqRf9HXbfpMdjPuRoR/QqqfmT61B/hfNbUA3L1Zn337HnJ+HH9H9vP6dj/MdrAoMGQ0RXaeI++3rD/41IRx9N5No5/UT5uu74ffzjU3XDTz/bqGXv/e89/4Y3J+fmL/k82f7qzrMN0us9TKo2lJ3MeC642rE9d/YNgO/bL4HO9x9Lp6mj8pGR/u8o1DIrYF4+2y/QpHTlY1VUPaI/n8Z0yPJ6Oi/SDkX8fuU56z2/8JY83CqQO0DYuWD8o40eMf8W6RG98c8XzF24c8fMTe9yJHT1VJ+CP/Nv733v+dJ9E/rnxt5wu090/7/1ohbuu+P4OTNPYX9exQX9/v52z7Xwyx681C2IESdLYszXGyn/s6x76erperxtXCN852vfsn6C/24WRfPLGLkeIn6kzjv9c9+9nV87zYuQ/9nUDAAAAAID9Aj5zAKwPfOYAWAf4zAGwPvCZAyDC/u7rsnl8+9TzkQt+4OEzB0AM69FU2VS6DNJdyPl58JkDIIL1aKr0Kb1lRp8EnzkAEpAerf4RV2Uxp0+CzxwAaUxkVPc+1O/LOFxd/8BnDgDG6dHqdpGvy5U6MfjMARDDerRiwbr1yvdvg88cAC3YWvsHPnNg/+haXvsGPnNgh1iMoQIDAAAAAAAAgIsH/Oe2xiD+aRf4aQD85/abQQbqL/C3Mb0HHfCfi5G+c6T/y/mdpfzflik94TD+c85NZiT/uS343630n7P7Z/WaAwL/uXSG4XuvzfyjhN9Z0n/u+L8P7Tu8ZaEcxn/OvUZ5HP+5LfjfrfSfo/3HePelBP5zzf5zvt+aaEFk/edSesLh/OceOR+4Efzncv53W/Ofs/tPIH7gP9fCf8H3dxE1SNZ/zvw+Sj3hQP5z7HMwlv9c2v9uW/5zgS/AuCEE/7kW/j+e31rQzcr7z5XcLE+1P3r3f+P0x/Gfy/nfbct/zv8+xvUPhv9cG/8530cl9d6ghD7Q/VYEI+fD+M/l/N+G8p/L+d9ty38uOP9Rn0zAf65N/eO17+VoUsZ/rsh8v8P4z1H6Y/nP0XX35T8X9EfHjB/4z7Xzn+Nxp2gwNqk3VNepfnednlDET8/+b3wfxvKfy/nfbcl/jsdDPxq5/Qb/uXb+c8HzjkSHVeoDyxmfR+r5Rd/+b5z+WP5zGf+7rfnPUX7R/R0Y+M/Bf24P8h3reuA/1w9jlyPEz9TZFV+3XTnPi5H/2NcNAAAAAAD2h/WGuFYfldPNyXbuKn3dRAQdpMtaczmRqwB9seYo7XojZ/HWbDpTedFVwo2lyxI94wsOfd+lsYtTz3PPvaKb1dc0/LA2xI96jrbauSvrd1f423NL0reRLoLTKVfrt6L8fBeWdZaogC42ZsbR8etn5Wk1L6o77x0W5ftt4qdhdtHq+DFzMv7nfj5+sn53hmb9lpndQzor2q5mIdpnO0n9VpTfxvEzlfcrgC609J/j8mvnqVRXHy1P3n50761g3qzTP3k6sKDgS11bTlentpb1ibmDg/1a+N211m+59h/5E5UuNiL9mEXmR7qsdZcFGnA7SQf/OZoMrOOtuvq/b344Lzl+/HmA5nk868DS8cO6tLSurt5q5qE/YBVMsF+j3117/RbHjwrKIL5ttz41vyDWa21c/yB+dpAO/nN29t2yPK33q67+3+sfnMbx4+bxs09cOn5Yf5XWNfAsftH/aet310G/xfFjdJD2c47vUL/lrkPq3RA/e0lr/zmnD7Wzzuv/4vjx/OBIB5Zpvx0G8SPzPTr/uZtV7tVTbf3uOui3WDgU6Lhy+jFxHe46ET/7Sjv/uXCLOSZR/7BOiWuQoPeQi5+4/jl0AxLJ/Vb73bXXb7EK3+n2SMeV0Y8VRUrvhvGDfaS9/1w4vkrx87HVqbE+jXRKTsfEQjpSyYW6tLSuTjcn1T/ftWlG+zX43bXWbwlVNX/uvVOpNEKW1X54GL/eS9r7zxlfOQvFz/2K9W8LHn/Tr3MiHZMTxNFzFqFrS+rq9DuNHpj3TdlxwHC/Rr+7lvotes8B6az8z0k4r6+1wQ9v4/hB823HaWw/9DF/ZxsM88Pdt78Yqp/dZmr+c1NjKtOEwCSB/xwAAAAAAAAAbIUJ+c9Nh/SQxI76o3Vj26P1F3/0H/5zEen42YuBbMSPx074zzXt18KfLgXp71h/UabfZ5XS91l/g3D/YfzlGtPtOf9AH7mJv5y9f37pqsyD7VAHOWF2w3+uab8144fdIazOweruPJL+cnxktP8w/nKN6fac/xb87bS/HN0//xXzajv59yW+j8kxKf+5FnpAfb7Wfy70zUjq/wr7Ra/0mQv80sQ3n/SXq9NR6cn9h/KXo2XgQ1C4+zeWv11Xfzm6f+640HduB2YFTMp/roUe0Jyv9Z+L/E1i/Z/9Llb7LES6O+/IpL+cTS/efxh/ucjnzf8yh/CXy/jbdfWXo/vn/CCc75z2V4i/j6kxKf+5FnpAOl/jn9Ws/3PlaoXPD/mleX6PJrOMvxz7vIn9h/KX4/w9HzZT5obxl8v523X1l6P7x+mx75zx74vv79SYmP9cox6Q00/GT0L/585+lc+c9UtLfJ70l8unN5C/nPCZcxc6jL9cTp+Y02/K/MlfTubn+c7p34LE9zExpuY/16QH5PNN1z+x/q8oiub6R+Pp7rzPk/5ynN7bmfjp2d+Nl7L/UwzjL5fzt+vqL/cx6RwpPfadKzL3d2JMzH+uUQ9I+5F/Y6P+r6XPnPVLI92djJ9Y30fpLdPtt7793bxlMC42kL9c1t+us7+cuX/B+ap6yfr3Jb6PaTE1/7kmPSD7zFn/uUb9X0ufOfJL4/FEgdTb+emlxg/69neTxxMD+cvl/O26+svR/QvOV20n/77c9zEVpus/l9YDbvJ0f8B2wNjP0+HvM43rHc9/Lj3yv/b3M7DP3NjlCPGz62zo67Z1PeCwPnNjlyPEDwAAAAAA2HfG8p8bRhCzF7IbsD3+H/k6lJp/c95fAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDIzLTA5LTI3VDAxOjI4OjQ5KzAwOjAwRZ1VRAAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyMy0wOS0yN1QwMToyODo0OSswMDowMDTA7fgAAAAodEVYdGRhdGU6dGltZXN0YW1wADIwMjMtMDktMjdUMDE6Mjg6NDkrMDA6MDBj1cwnAAAAAElFTkSuQmCC" alt=""/></p><h2 id="copy已使用的mutex"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#copy已使用的mutex"><span class="icon icon-link"></span></a>Copy已使用的Mutex</h2><p>第二种误用是Copy已使用的Mutex。在正式分析这个错误之前，我先交代一个小知识点，那就是Package sync的同步原语在使用后是不能复制的。我们知道Mutex是最常用的一个同步原语，那它也是不能复制的。为什么呢？</p><p>原因在于，Mutex是一个有状态的对象，它的state字段记录这个锁的状态。如果你要复制一个已经加锁的Mutex给一个新的变量，那么新的刚初始化的变量居然被加锁了，这显然不符合你的期望，因为你期望的是一个零值的Mutex。关键是在并发环境下，你根本不知道要复制的Mutex状态是什么，因为要复制的Mutex是由其它goroutine并发访问的，状态可能总是在变化。</p><p>当然，你可能说，你说的我都懂，你的警告我都记下了，但是实际在使用的时候，一不小心就踩了这个坑，我们来看一个例子。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">type Counter struct {</span></div><div class="token-line"><span class="token plain">        sync.Mutex</span></div><div class="token-line"><span class="token plain">        Count int</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func main() {</span></div><div class="token-line"><span class="token plain">        var c Counter</span></div><div class="token-line"><span class="token plain">        c.Lock()</span></div><div class="token-line"><span class="token plain">        defer c.Unlock()</span></div><div class="token-line"><span class="token plain">        c.Count++</span></div><div class="token-line"><span class="token plain">        foo(c) // 复制锁</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    // 这里Counter的参数是通过复制的方式传入的</span></div><div class="token-line"><span class="token plain">    func foo(c Counter) {</span></div><div class="token-line"><span class="token plain">        c.Lock()</span></div><div class="token-line"><span class="token plain">        defer c.Unlock()</span></div><div class="token-line"><span class="token plain">        fmt.Println(&quot;in foo&quot;)</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>第12行在调用foo函数的时候，调用者会复制Mutex变量c作为foo函数的参数，不幸的是，复制之前已经使用了这个锁，这就导致，复制的Counter是一个带状态Counter。</p><p>怎么办呢？Go在运行时，有<strong>死锁的检查机制</strong>（<a target="_blank" rel="noopener noreferrer" href="https://golang.org/src/runtime/proc.go?h=checkdead#L4345">checkdead()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 方法），它能够发现死锁的goroutine。这个例子中因为复制了一个使用了的Mutex，导致锁无法使用，程序处于死锁的状态。程序运行的时候，死锁检查机制能够发现这种死锁情况并输出错误信息，如下图中错误信息以及错误堆栈：</p><p><img src="data:image/png;base64,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" alt=""/></p><p>你肯定不想运行的时候才发现这个因为复制Mutex导致的死锁问题，那么你怎么能够及时发现问题呢？可以使用<strong>vet工具</strong>，把检查写在Makefile文件中，在持续集成的时候跑一跑，这样可以及时发现问题，及时修复。我们可以使用go vet检查这个Go文件：</p><p><img src="data:image/png;base64,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" alt=""/></p><p>你看，使用这个工具就可以发现Mutex复制的问题，错误信息显示得很清楚，是在调用foo函数的时候发生了lock value复制的情况，还告诉我们出问题的代码行数以及copy lock导致的错误。</p><p>那么，vet工具是怎么发现Mutex复制使用问题的呢？我带你简单分析一下。</p><p>检查是通过<a target="_blank" rel="noopener noreferrer" href="https://github.com/golang/tools/blob/master/go/analysis/passes/copylock/copylock.go">copylock<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>分析器静态分析实现的。这个分析器会分析函数调用、range遍历、复制、声明、函数返回值等位置，有没有锁的值copy的情景，以此来判断有没有问题。可以说，只要是实现了Locker接口，就会被分析。我们看到，下面的代码就是确定什么类型会被分析，其实就是实现了Lock/Unlock两个方法的Locker接口：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">var lockerType *types.Interface</span></div><div class="token-line"><span class="token plain">    	</span></div><div class="token-line"><span class="token plain">    	// Construct a sync.Locker interface type.</span></div><div class="token-line"><span class="token plain">    	func init() {</span></div><div class="token-line"><span class="token plain">    		nullary := types.NewSignature(nil, nil, nil, false) // func()</span></div><div class="token-line"><span class="token plain">    		methods := []*types.Func{</span></div><div class="token-line"><span class="token plain">    			types.NewFunc(token.NoPos, nil, &quot;Lock&quot;, nullary),</span></div><div class="token-line"><span class="token plain">    			types.NewFunc(token.NoPos, nil, &quot;Unlock&quot;, nullary),</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    		lockerType = types.NewInterface(methods, nil).Complete()</span></div><div class="token-line"><span class="token plain">    	}</span></div></pre></div><p>其实，有些没有实现Locker接口的同步原语（比如WaitGroup），也能被分析。我先卖个关子，后面我们会介绍这种情况是怎么实现的。</p><h2 id="重入"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#重入"><span class="icon icon-link"></span></a>重入</h2><p>接下来，我们来讨论“重入”这个问题。在说这个问题前，我先解释一下个概念，叫“可重入锁”。</p><p>如果你学过Java，可能会很熟悉ReentrantLock，就是可重入锁，这是Java并发包中非常常用的一个同步原语。它的基本行为和互斥锁相同，但是加了一些扩展功能。</p><p>如果你没接触过Java，也没关系，这里只是提一下，帮助会Java的同学对比来学。那下面我来具体讲解可重入锁是咋回事儿。</p><p>当一个线程获取锁时，如果没有其它线程拥有这个锁，那么，这个线程就成功获取到这个锁。之后，如果其它线程再请求这个锁，就会处于阻塞等待的状态。但是，如果拥有这把锁的线程再请求这把锁的话，不会阻塞，而是成功返回，所以叫可重入锁（有时候也叫做递归锁）。只要你拥有这把锁，你可以可着劲儿地调用，比如通过递归实现一些算法，调用者不会阻塞或者死锁。</p><p>了解了可重入锁的概念，那我们来看Mutex使用的错误场景。划重点了：<strong>Mutex不是可重入的锁。</strong></p><p>想想也不奇怪，因为Mutex的实现中没有记录哪个goroutine拥有这把锁。理论上，任何goroutine都可以随意地Unlock这把锁，所以没办法计算重入条件，毕竟，“臣妾做不到啊”！</p><p>所以，一旦误用Mutex的重入，就会导致报错。下面是一个误用Mutex的重入例子：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">func foo(l sync.Locker) {</span></div><div class="token-line"><span class="token plain">        fmt.Println(&quot;in foo&quot;)</span></div><div class="token-line"><span class="token plain">        l.Lock()</span></div><div class="token-line"><span class="token plain">        bar(l)</span></div><div class="token-line"><span class="token plain">        l.Unlock()</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func bar(l sync.Locker) {</span></div><div class="token-line"><span class="token plain">        l.Lock()</span></div><div class="token-line"><span class="token plain">        fmt.Println(&quot;in bar&quot;)</span></div><div class="token-line"><span class="token plain">        l.Unlock()</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func main() {</span></div><div class="token-line"><span class="token plain">        l := &amp;sync.Mutex{}</span></div><div class="token-line"><span class="token plain">        foo(l)</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>写完这个Mutex重入的例子后，运行一下，你会发现类似下面的错误。程序一直在请求锁，但是一直没有办法获取到锁，结果就是Go运行时发现死锁了，没有其它地方能够释放锁让程序运行下去，你通过下面的错误堆栈信息就能定位到哪一行阻塞请求锁：</p><p><img src="data:image/png;base64,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" alt=""/></p><p>学到这里，你可能要问了，虽然标准库Mutex不是可重入锁，但是如果我就是想要实现一个可重入锁，可以吗？</p><p>可以，那我们就自己实现一个。这里的关键就是，实现的锁要能记住当前是哪个goroutine持有这个锁。我来提供两个方案。</p><ul><li>方案一：通过hacker的方式获取到goroutine id，记录下获取锁的goroutine id，它可以实现Locker接口。</li><li>方案二：调用Lock/Unlock方法时，由goroutine提供一个token，用来标识它自己，而不是我们通过hacker的方式获取到goroutine id，但是，这样一来，就不满足Locker接口了。</li></ul><p>可重入锁（递归锁）解决了代码重入或者递归调用带来的死锁问题，同时它也带来了另一个好处，就是我们可以要求，只有持有锁的goroutine才能unlock这个锁。这也很容易实现，因为在上面这两个方案中，都已经记录了是哪一个goroutine持有这个锁。</p><p>下面我们具体来看这两个方案怎么实现。</p><p><strong>方案一</strong>：<strong>goroutine id</strong></p><p>这个方案的关键第一步是获取goroutine id，方式有两种，分别是简单方式和hacker方式。</p><p>简单方式，就是通过runtime.Stack方法获取栈帧信息，栈帧信息里包含goroutine id。你可以看看上面panic时候的贴图，goroutine id明明白白地显示在那里。runtime.Stack方法可以获取当前的goroutine信息，第二个参数为true会输出所有的goroutine信息，信息的格式如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">goroutine 1 [running]:</span></div><div class="token-line"><span class="token plain">    main.main()</span></div><div class="token-line"><span class="token plain">            ....../main.go:19 +0xb1</span></div></pre></div><p>第一行格式为goroutine xxx，其中xxx就是goroutine id，你只要解析出这个id即可。解析的方法可以采用下面的代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">func GoID() int {</span></div><div class="token-line"><span class="token plain">        var buf [64]byte</span></div><div class="token-line"><span class="token plain">        n := runtime.Stack(buf[:], false)</span></div><div class="token-line"><span class="token plain">        // 得到id字符串</span></div><div class="token-line"><span class="token plain">        idField := strings.Fields(strings.TrimPrefix(string(buf[:n]), &quot;goroutine &quot;))[0]</span></div><div class="token-line"><span class="token plain">        id, err := strconv.Atoi(idField)</span></div><div class="token-line"><span class="token plain">        if err != nil {</span></div><div class="token-line"><span class="token plain">            panic(fmt.Sprintf(&quot;cannot get goroutine id: %v&quot;, err))</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        return id</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>了解了简单方式，接下来我们来看hacker的方式，这也是我们方案一采取的方式。</p><p>首先，我们获取运行时的g指针，反解出对应的g的结构。每个运行的goroutine结构的g指针保存在当前goroutine的一个叫做TLS对象中。</p><p>第一步：我们先获取到TLS对象；</p><p>第二步：再从TLS中获取goroutine结构的g指针；</p><p>第三步：再从g指针中取出goroutine id。</p><p>需要注意的是，不同Go版本的goroutine的结构可能不同，所以需要根据Go的<a target="_blank" rel="noopener noreferrer" href="https://github.com/golang/go/blob/89f687d6dbc11613f715d1644b4983905293dd33/src/runtime/runtime2.go#L412">不同版本<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>进行调整。当然了，如果想要搞清楚各个版本的goroutine结构差异，所涉及的内容又过于底层而且复杂，学习成本太高。怎么办呢？我们可以重点关注一些库。我们没有必要重复发明轮子，直接使用第三方的库来获取goroutine id就可以了。</p><p>好消息是现在已经有很多成熟的方法了，可以支持多个Go版本的goroutine id，给你推荐一个常用的库：<a target="_blank" rel="noopener noreferrer" href="https://github.com/petermattis/goid">petermattis/goid<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>知道了如何获取goroutine id，接下来就是最后的关键一步了，我们实现一个可以使用的可重入锁：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// RecursiveMutex 包装一个Mutex,实现可重入</span></div><div class="token-line"><span class="token plain">    type RecursiveMutex struct {</span></div><div class="token-line"><span class="token plain">        sync.Mutex</span></div><div class="token-line"><span class="token plain">        owner     int64 // 当前持有锁的goroutine id</span></div><div class="token-line"><span class="token plain">        recursion int32 // 这个goroutine 重入的次数</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func (m *RecursiveMutex) Lock() {</span></div><div class="token-line"><span class="token plain">        gid := goid.Get()</span></div><div class="token-line"><span class="token plain">        // 如果当前持有锁的goroutine就是这次调用的goroutine,说明是重入</span></div><div class="token-line"><span class="token plain">        if atomic.LoadInt64(&amp;m.owner) == gid {</span></div><div class="token-line"><span class="token plain">            m.recursion++</span></div><div class="token-line"><span class="token plain">            return</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        m.Mutex.Lock()</span></div><div class="token-line"><span class="token plain">        // 获得锁的goroutine第一次调用，记录下它的goroutine id,调用次数加1</span></div><div class="token-line"><span class="token plain">        atomic.StoreInt64(&amp;m.owner, gid)</span></div><div class="token-line"><span class="token plain">        m.recursion = 1</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func (m *RecursiveMutex) Unlock() {</span></div><div class="token-line"><span class="token plain">        gid := goid.Get()</span></div><div class="token-line"><span class="token plain">        // 非持有锁的goroutine尝试释放锁，错误的使用</span></div><div class="token-line"><span class="token plain">        if atomic.LoadInt64(&amp;m.owner) != gid {</span></div><div class="token-line"><span class="token plain">            panic(fmt.Sprintf(&quot;wrong the owner(%d): %d!&quot;, m.owner, gid))</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        // 调用次数减1</span></div><div class="token-line"><span class="token plain">        m.recursion--</span></div><div class="token-line"><span class="token plain">        if m.recursion != 0 { // 如果这个goroutine还没有完全释放，则直接返回</span></div><div class="token-line"><span class="token plain">            return</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        // 此goroutine最后一次调用，需要释放锁</span></div><div class="token-line"><span class="token plain">        atomic.StoreInt64(&amp;m.owner, -1)</span></div><div class="token-line"><span class="token plain">        m.Mutex.Unlock()</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>上面这段代码你可以拿来即用。我们一起来看下这个实现，真是非常巧妙，它相当于给Mutex打一个补丁，解决了记录锁的持有者的问题。可以看到，我们用owner字段，记录当前锁的拥有者goroutine的id；recursion 是辅助字段，用于记录重入的次数。</p><p>有一点，我要提醒你一句，尽管拥有者可以多次调用Lock，但是也必须调用相同次数的Unlock，这样才能把锁释放掉。这是一个合理的设计，可以保证Lock和Unlock一一对应。</p><p><strong>方案二</strong>：<strong>token</strong></p><p>方案一是用goroutine id做goroutine的标识，我们也可以让goroutine自己来提供标识。不管怎么说，Go开发者不期望你利用goroutine id做一些不确定的东西，所以，他们没有暴露获取goroutine id的方法。</p><p>下面的代码是第二种方案。调用者自己提供一个token，获取锁的时候把这个token传入，释放锁的时候也需要把这个token传入。通过用户传入的token替换方案一中goroutine id，其它逻辑和方案一一致。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// Token方式的递归锁</span></div><div class="token-line"><span class="token plain">    type TokenRecursiveMutex struct {</span></div><div class="token-line"><span class="token plain">        sync.Mutex</span></div><div class="token-line"><span class="token plain">        token     int64</span></div><div class="token-line"><span class="token plain">        recursion int32</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    // 请求锁，需要传入token</span></div><div class="token-line"><span class="token plain">    func (m *TokenRecursiveMutex) Lock(token int64) {</span></div><div class="token-line"><span class="token plain">        if atomic.LoadInt64(&amp;m.token) == token { //如果传入的token和持有锁的token一致，说明是递归调用</span></div><div class="token-line"><span class="token plain">            m.recursion++</span></div><div class="token-line"><span class="token plain">            return</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        m.Mutex.Lock() // 传入的token不一致，说明不是递归调用</span></div><div class="token-line"><span class="token plain">        // 抢到锁之后记录这个token</span></div><div class="token-line"><span class="token plain">        atomic.StoreInt64(&amp;m.token, token)</span></div><div class="token-line"><span class="token plain">        m.recursion = 1</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    // 释放锁</span></div><div class="token-line"><span class="token plain">    func (m *TokenRecursiveMutex) Unlock(token int64) {</span></div><div class="token-line"><span class="token plain">        if atomic.LoadInt64(&amp;m.token) != token { // 释放其它token持有的锁</span></div><div class="token-line"><span class="token plain">            panic(fmt.Sprintf(&quot;wrong the owner(%d): %d!&quot;, m.token, token))</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        m.recursion-- // 当前持有这个锁的token释放锁</span></div><div class="token-line"><span class="token plain">        if m.recursion != 0 { // 还没有回退到最初的递归调用</span></div><div class="token-line"><span class="token plain">            return</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        atomic.StoreInt64(&amp;m.token, 0) // 没有递归调用了，释放锁</span></div><div class="token-line"><span class="token plain">        m.Mutex.Unlock()</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><h2 id="死锁"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#死锁"><span class="icon icon-link"></span></a>死锁</h2><p>接下来，我们来看第四种错误场景：死锁。</p><p>我先解释下什么是死锁。两个或两个以上的进程（或线程，goroutine）在执行过程中，因争夺共享资源而处于一种互相等待的状态，如果没有外部干涉，它们都将无法推进下去，此时，我们称系统处于死锁状态或系统产生了死锁。</p><p>我们来分析一下死锁产生的必要条件。如果你想避免死锁，只要破坏这四个条件中的一个或者几个，就可以了。</p><ol><li><strong>互斥</strong>： 至少一个资源是被排他性独享的，其他线程必须处于等待状态，直到资源被释放。</li><li><strong>持有和等待</strong>：goroutine持有一个资源，并且还在请求其它goroutine持有的资源，也就是咱们常说的“吃着碗里，看着锅里”的意思。</li><li><strong>不可剥夺</strong>：资源只能由持有它的goroutine来释放。</li><li><strong>环路等待</strong>：一般来说，存在一组等待进程，P=<!-- -->{<!-- -->P1，P2，…，PN<!-- -->}<!-- -->，P1等待P2持有的资源，P2等待P3持有的资源，依此类推，最后是PN等待P1持有的资源，这就形成了一个环路等待的死结。</li></ol><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage4ad54ace1eecf856ef80607yyb6f7a45abd5.393cb1b0.jpg" alt=""/></p><p>你看，死锁问题还真是挺有意思的，所以有很多人研究这个事儿。一个经典的死锁问题就是<a target="_blank" rel="noopener noreferrer" href="https://zh.wikipedia.org/wiki/%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90%E9%97%AE%E9%A2%98">哲学家就餐问题<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，我不做介绍了，你可以点击链接进一步了解。其实，死锁问题在现实生活中也比比皆是。</p><p>举个例子。有一次我去派出所开证明，派出所要求物业先证明我是本物业的业主，但是，物业要我提供派出所的证明，才能给我开物业证明，结果就陷入了死锁状态。你可以把派出所和物业看成两个goroutine，派出所证明和物业证明是两个资源，双方都持有自己的资源而要求对方的资源，而且自己的资源自己持有，不可剥夺。</p><p>这是一个最简单的只有两个goroutine相互等待的死锁的例子，转化成代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">package main</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    import (</span></div><div class="token-line"><span class="token plain">        &quot;fmt&quot;</span></div><div class="token-line"><span class="token plain">        &quot;sync&quot;</span></div><div class="token-line"><span class="token plain">        &quot;time&quot;</span></div><div class="token-line"><span class="token plain">    )</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func main() {</span></div><div class="token-line"><span class="token plain">        // 派出所证明</span></div><div class="token-line"><span class="token plain">        var psCertificate sync.Mutex</span></div><div class="token-line"><span class="token plain">        // 物业证明</span></div><div class="token-line"><span class="token plain">        var propertyCertificate sync.Mutex</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        var wg sync.WaitGroup</span></div><div class="token-line"><span class="token plain">        wg.Add(2) // 需要派出所和物业都处理</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        // 派出所处理goroutine</span></div><div class="token-line"><span class="token plain">        go func() {</span></div><div class="token-line"><span class="token plain">            defer wg.Done() // 派出所处理完成</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            psCertificate.Lock()</span></div><div class="token-line"><span class="token plain">            defer psCertificate.Unlock()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            // 检查材料</span></div><div class="token-line"><span class="token plain">            time.Sleep(5 * time.Second)</span></div><div class="token-line"><span class="token plain">            // 请求物业的证明</span></div><div class="token-line"><span class="token plain">            propertyCertificate.Lock()</span></div><div class="token-line"><span class="token plain">            propertyCertificate.Unlock()</span></div><div class="token-line"><span class="token plain">        }()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        // 物业处理goroutine</span></div><div class="token-line"><span class="token plain">        go func() {</span></div><div class="token-line"><span class="token plain">            defer wg.Done() // 物业处理完成</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            propertyCertificate.Lock()</span></div><div class="token-line"><span class="token plain">            defer propertyCertificate.Unlock()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            // 检查材料</span></div><div class="token-line"><span class="token plain">            time.Sleep(5 * time.Second)</span></div><div class="token-line"><span class="token plain">            // 请求派出所的证明</span></div><div class="token-line"><span class="token plain">            psCertificate.Lock()</span></div><div class="token-line"><span class="token plain">            psCertificate.Unlock()</span></div><div class="token-line"><span class="token plain">        }()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        wg.Wait()</span></div><div class="token-line"><span class="token plain">        fmt.Println(&quot;成功完成&quot;)</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这个程序没有办法运行成功，因为派出所的处理和物业的处理是一个环路等待的死结。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>Go运行时，有死锁探测的功能，能够检查出是否出现了死锁的情况，如果出现了，这个时候你就需要调整策略来处理了。</p><p>你可以引入一个第三方的锁，大家都依赖这个锁进行业务处理，比如现在政府推行的一站式政务服务中心。或者是解决持有等待问题，物业不需要看到派出所的证明才给开物业证明，等等。</p><p>好了，到这里，我给你讲了使用Mutex常见的4类问题。你是不是觉得，哎呀，这几类问题也太不应该了吧，真的会有人犯这么基础的错误吗？</p><p>还真是有。虽然Mutex使用起来很简单，但是，仍然可能出现使用错误的问题。而且，就连一些经验丰富的开发人员，也会出现一些Mutex使用的问题。接下来，我就带你围观几个非常流行的Go开发项目，看看这些错误是怎么产生和修复的。</p><h1 id="流行的go开发项目踩坑记"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#流行的go开发项目踩坑记"><span class="icon icon-link"></span></a>流行的Go开发项目踩坑记</h1><h2 id="docker"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#docker"><span class="icon icon-link"></span></a>Docker</h2><p>Docker 容器是一个开源的应用容器引擎，开发者可以以统一的方式，把他们的应用和依赖包打包到一个可移植的容器中，然后发布到任何安装了docker引擎的服务器上。</p><p>Docker是使用Go开发的，也算是Go的一个杀手级产品了，它的Mutex相关的Bug也不少，我们来看几个典型的Bug。</p><h3 id="issue-36114"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-36114"><span class="icon icon-link"></span></a>issue 36114</h3><p>Docker的<a target="_blank" rel="noopener noreferrer" href="https://github.com/moby/moby/pull/36114/files">issue 36114<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个死锁问题。</p><p>原因在于，hotAddVHDsAtStart方法执行的时候，执行了加锁svm操作。但是，在其中调用hotRemoveVHDsAtStart方法时，这个hotRemoveVHDsAtStart方法也是要加锁svm的。很不幸，Go标准库中的Mutex是不可重入的，所以，代码执行到这里，就出现了死锁的现象。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimageda8cdac838666ee09c98dd9ac5db479aae8c.ba274105.png" alt=""/></p><p>针对这个问题，解决办法就是，再提供一个不需要锁的hotRemoveVHDsNoLock方法，避免Mutex的重入。</p><h3 id="issue-34881"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-34881"><span class="icon icon-link"></span></a>issue 34881</h3><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/moby/moby/pull/34881/files">issue 34881<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>本来是修复Docker的一个简单问题，如果节点在初始化的时候，发现自己不是一个swarm mananger，就快速返回，这个修复就几行代码，你看出问题来了吗？</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimagebf34bf78904a947d4228dc006fff94f97334.4b41acf0.png" alt=""/></p><p>在第34行，节点发现不满足条件就返回了，但是，c.mu这个锁没有释放！为什么会出现这个问题呢？其实，这是在重构或者添加新功能的时候经常犯的一个错误，因为不太了解上下文，或者是没有仔细看函数的逻辑，从而导致锁没有被释放。现在的Docker当然已经没有这个问题了。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage1cf11c7a5f8e12f642d82aac8045c046c6f1.91ea2cf6.png" alt=""/></p><p>这样的issue还有很多，我就不一一列举了。我给你推荐几个关于Mutex的issue或者pull request，你可以关注一下，分别是36840、37583、35517、35482、33305、32826、30696、29554、29191、28912、26507等。</p><h2 id="kubernetes"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#kubernetes"><span class="icon icon-link"></span></a>Kubernetes</h2><h3 id="issue-72361"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-72361"><span class="icon icon-link"></span></a>issue 72361</h3><p>issue 72361 增加Mutex为了保护资源。这是为了解决data race问题而做的一个修复，修复方法也很简单，使用互斥锁即可，这也是我们解决data race时常用的方法。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage21312171a7a0de179904ceba463026ee7231.641b5b19.png" alt=""/></p><h3 id="issue-45192"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-45192"><span class="icon icon-link"></span></a>issue 45192</h3><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/kubernetes/kubernetes/pull/45192/files">issue 45192<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>也是一个返回时忘记Unlock的典型例子，和 docker issue 34881犯的错误都是一样的。</p><p>两大知名项目的开发者都犯了这个错误，所以，你就可以知道，引入这个Bug是多么容易，记住晁老师这句话：<strong>保证Lock/Unlock成对出现，尽可能采用defer mutex.Unlock的方式，把它们成对、紧凑地写在一起</strong>。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimageba61ba0f7671fd64951a47365e46ab68db61.9107bb55.png" alt=""/></p><p>除了这些，我也建议你关注一下其它的Mutex相关的issue，比如 71617、70605等。</p><h2 id="grpc"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#grpc"><span class="icon icon-link"></span></a><strong>gRPC</strong></h2><p>gRPC是Google发起的一个开源远程过程调用 （Remote procedure call）系统。该系统基于 HTTP/2 协议传输，使用Protocol Buffers 作为接口描述语言。它提供Go语言的实现。</p><p>即使是Google官方出品的系统，也有一些Mutex的issue。</p><h3 id="issue-795"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-795"><span class="icon icon-link"></span></a>issue 795</h3><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/grpc/grpc-go/pull/795">issue 795<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是一个你可能想不到的bug，那就是将Unlock误写成了Lock。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimageb6f0b6e97a6938586e95c3427e693eb712f0.b3d89718.png" alt=""/></p><p>关于这个项目，还有一些其他的为了保护共享资源而添加Mutex的issue，比如1318、2074、2542等。</p><h2 id="etcd"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#etcd"><span class="icon icon-link"></span></a>etcd</h2><p>etcd是一个非常知名的分布式一致性的 key-value 存储技术， 被用来做配置共享和服务发现。</p><h2 id="issue-10419"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#issue-10419"><span class="icon icon-link"></span></a>issue 10419</h2><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/etcd-io/etcd/pull/10419/files">issue 10419<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是一个锁重入导致的问题。 Store方法内对请求了锁，而调用的Compact的方法内又请求了锁，这个时候，会导致死锁，一直等待，解决办法就是提供不需要加锁的Compact方法。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage5f7f5fed22fb735c107d130477562c28477f.7da6f6a4.png" alt=""/></p><h1 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#总结"><span class="icon icon-link"></span></a>总结</h1><p>这节课，我们学习了Mutex的一些易错场景，而且，我们还分析了流行的Go开源项目的错误，我也给你分享了我自己在开发中的经验总结。需要强调的是，<strong>手误和重入导致的死锁，是最常见的使用Mutex的Bug</strong>。</p><p>Go死锁探测工具只能探测整个程序是否因为死锁而冻结了，不能检测出一组goroutine死锁导致的某一块业务冻结的情况。你还可以通过Go运行时自带的死锁检测工具，或者是第三方的工具（比如<a target="_blank" rel="noopener noreferrer" href="https://github.com/sasha-s/go-deadlock">go-deadlock<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a target="_blank" rel="noopener noreferrer" href="https://github.com/dominikh/go-tools">go-tools<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）进行检查，这样可以尽早发现一些死锁的问题。不过，有些时候，死锁在某些特定情况下才会被触发，所以，如果你的测试或者短时间的运行没问题，不代表程序一定不会有死锁问题。</p><p>并发程序最难跟踪调试的就是很难重现，因为并发问题不是按照我们指定的顺序执行的，由于计算机调度的问题和事件触发的时机不同，死锁的Bug可能会在极端的情况下出现。通过搜索日志、查看日志，我们能够知道程序有异常了，比如某个流程一直没有结束。这个时候，可以通过Go pprof工具分析，它提供了一个block profiler监控阻塞的goroutine。除此之外，我们还可以查看全部的goroutine的堆栈信息，通过它，你可以查看阻塞的groutine究竟阻塞在哪一行哪一个对象上了。</p><h1 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go并发编程实战/02.基本并发原语/03#思考题"><span class="icon icon-link"></span></a>思考题</h1><p>查找知名的数据库系统TiDB的issue，看看有没有Mutex相关的issue，看看它们都是哪些相关的Bug。</p><p>欢迎在留言区写下你的思考和答案，我们一起交流讨论。如果你觉得有所收获，也欢迎你把今天的内容分享给你的朋友或同事。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/go并发编程实战/02.基本并发原语/03.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/27 11:15:40</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-backend/umi.e14e5a14.js"></script>
  </body>
</html>
