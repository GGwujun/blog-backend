<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-backend/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-backend";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>特别放送 | IAM排障指南 - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/go语言项目开发实战/08.特别放送/04" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-backend/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>后端开发<ul><li><a href="/blog-backend/go语言核心36讲">go语言核心36讲</a></li><li><a href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a aria-current="page" class="active" href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/kafka核心技术与实战">kafka核心技术与实战</a></li><li><a href="/blog-backend/kafka核心源码解读">kafka核心源码解读</a></li><li><a href="/blog-backend/零基础学python">零基础学python</a></li><li><a href="/blog-backend/python核心技术与实战">python核心技术与实战</a></li><li><a href="/blog-backend/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-backend/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-backend/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-backend/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-backend/后端存储实战课">后端存储实战课</a></li><li><a href="/blog-backend/后端技术面试38讲">后端技术面试38讲</a></li><li><a href="/blog-backend/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li><li><a href="/blog-backend/现代c编程实战">现代c编程实战</a></li><li><a href="/blog-backend/罗剑锋的c实战笔记">罗剑锋的c实战笔记</a></li><li><a href="/blog-backend/零基础入门spark">零基础入门spark</a></li></ul></span><span>架构师<ul><li><a href="/blog-backend/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-backend/数据中台实战课">数据中台实战课</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-backend/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>后端开发<ul><li><a href="/blog-backend/go语言核心36讲">go语言核心36讲</a></li><li><a href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a aria-current="page" class="active" href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/kafka核心技术与实战">kafka核心技术与实战</a></li><li><a href="/blog-backend/kafka核心源码解读">kafka核心源码解读</a></li><li><a href="/blog-backend/零基础学python">零基础学python</a></li><li><a href="/blog-backend/python核心技术与实战">python核心技术与实战</a></li><li><a href="/blog-backend/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-backend/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-backend/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-backend/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-backend/后端存储实战课">后端存储实战课</a></li><li><a href="/blog-backend/后端技术面试38讲">后端技术面试38讲</a></li><li><a href="/blog-backend/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li><li><a href="/blog-backend/现代c编程实战">现代c编程实战</a></li><li><a href="/blog-backend/罗剑锋的c实战笔记">罗剑锋的c实战笔记</a></li><li><a href="/blog-backend/零基础入门spark">零基础入门spark</a></li></ul></li><li>架构师<ul><li><a href="/blog-backend/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-backend/数据中台实战课">数据中台实战课</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/go语言项目开发实战/01.开篇词">01.开篇词</a><ul><li><a href="/blog-backend/go语言项目开发实战/01.开篇词/01"><span>开篇词 | 从 0 开始搭建一个企业级 Go 应用</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/02.课前必学">02.课前必学</a><ul><li><a href="/blog-backend/go语言项目开发实战/02.课前必学/01"><span>01 | IAM系统概述：我们要实现什么样的 Go 项目？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/02.课前必学/02"><span>02 | 环境准备：如何安装和配置一个基本的 Go 开发环境？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/02.课前必学/03"><span>03 | 项目部署：如何快速部署 IAM 系统？</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计">03.实战第1站规范设计</a><ul><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/01"><span>04 | 规范设计（上）：项目开发杂乱无章，如何规范？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/02"><span>05 | 规范设计（下）：commit 信息风格迥异、难以阅读，如何规范？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/03"><span>06 | 目录结构设计：如何组织一个可维护、可扩展的代码目录？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/04"><span>07 | 工作流设计：如何设计合理的多人开发模式？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/05"><span>08 | 研发流程设计（上）：如何设计 Go 项目的开发流程？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/06"><span>09 | 研发流程设计（下）：如何管理应用的生命周期？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/07"><span>10 | 设计方法：怎么写出优雅的 Go 项目？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/08"><span>11 | 设计模式：Go常用设计模式概述</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发">04.实战第2站基础功能设计或开发</a><ul><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/01"><span>12 | API 风格（上）：如何设计RESTful API？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/02"><span>13 | API 风格（下）：RPC API介绍</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/03"><span>14 | 项目管理：如何编写高质量的Makefile？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/04"><span>15 | 研发流程实战：IAM项目是如何进行研发流程管理的？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/05"><span>16 | 代码检查：如何进行静态代码检查？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/06"><span>17 | API 文档：如何生成 Swagger API 文档 ？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/07"><span>18 | 错误处理（上）：如何设计一套科学的错误码？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/08"><span>19 | 错误处理（下）：如何设计错误包？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/09"><span>20 | 日志处理（上）：如何设计日志包并记录日志？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/10"><span>21 | 日志处理（下）：手把手教你从 0 编写一个日志包</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/11"><span>22 | 应用构建三剑客：Pflag、Viper、Cobra 核心功能介绍</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/12"><span>23 | 应用构建实战：如何构建一个优秀的企业应用框架？</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发">05.实战第3站服务开发</a><ul><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/01"><span>24 | Web 服务：Web 服务核心功能有哪些，如何实现？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/02"><span>25 | 认证机制：应用程序如何进行访问认证？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/03"><span>26 | IAM项目是如何设计和实现访问认证功能的？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/04"><span>27 | 权限模型：5大权限模型是如何进行资源授权的？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/05"><span>28 | 控制流（上）：通过iam-apiserver设计，看Web服务的构建</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/06"><span>29｜控制流（下）：iam-apiserver服务核心功能实现讲解</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/07"><span>30 | ORM：CURD 神器 GORM 包介绍及实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/08"><span>31 | 数据流：通过iam-authz-server设计，看数据流服务的设计</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/09"><span>32 | 数据处理：如何高效处理应用程序产生的数据？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/10"><span>33 |  SDK 设计（上）：如何设计出一个优秀的 Go SDK？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/11"><span>34 | SDK 设计（下）：IAM项目Go SDK设计和实现</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/12"><span>35 | 效率神器：如何设计和实现一个命令行客户端工具？</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/06.实战第4站服务测试">06.实战第4站服务测试</a><ul><li><a href="/blog-backend/go语言项目开发实战/06.实战第4站服务测试/01"><span>36 | 代码测试（上）：如何编写 Go 语言单元测试和性能测试用例？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/06.实战第4站服务测试/02"><span>37 | 代码测试（下）：Go 语言其他测试类型及 IAM 测试介绍</span></a></li><li><a href="/blog-backend/go语言项目开发实战/06.实战第4站服务测试/03"><span>38｜性能分析（上）：如何分析 Go 语言代码的性能？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/06.实战第4站服务测试/04"><span>39｜性能分析（下）：API Server性能测试和调优实战</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署">07.实战第5站服务部署</a><ul><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/01"><span>40 | 软件部署实战（上）：部署方案及负载均衡、高可用组件介绍</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/02"><span>41 | 软件部署实战（中）：IAM 系统生产环境部署实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/03"><span>42 | 软件部署实战（下）：IAM系统安全加固、水平扩缩容实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/04"><span>43｜技术演进（上）：虚拟化技术演进之路</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/05"><span>44｜技术演进（下）：软件架构和应用生命周期技术演进之路</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/06"><span>45｜基于Kubernetes的云原生架构设计</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/07"><span>46 | 如何制作Docker镜像？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/08"><span>47 | 如何编写Kubernetes资源定义文件？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09"><span>48 | 基于腾讯云 EKS 的容器化部署实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/10"><span>49 | 服务编排（上）：Helm服务编排基础知识</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/11"><span>50 | 服务编排（下）：基于Helm的服务编排部署实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/12"><span>51 | 基于 GitHub Actions 的 CI 实战</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-backend/go语言项目开发实战/08.特别放送">08.特别放送</a><ul><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/01"><span>特别放送 | 给你一份清晰、可直接套用的Go编码规范</span></a></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/02"><span>特别放送 | 给你一份Go项目中最常用的Makefile核心语法</span></a></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/03"><span>特别放送 | Go Modules依赖包管理全讲</span></a></li><li><a aria-current="page" class="active" href="/blog-backend/go语言项目开发实战/08.特别放送/04"><span>特别放送 | IAM排障指南</span></a></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/05"><span>特别放送 | Go Modules实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/06"><span>特别放送 | 分布式作业系统设计和实现</span></a></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/07"><span>直播加餐｜如何从小白进阶成 Go 语言专家？</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/09.结束语">09.结束语</a><ul><li><a href="/blog-backend/go语言项目开发实战/09.结束语/01"><span>结束语 | 如何让自己的 Go 研发之路走得更远？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/09.结束语/02"><span>期末考试｜《Go语言项目开发实战》满分试卷，等你来挑战！</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/summary">go语言项目开发实战</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="如何排障？" data-depth="2"><a href="/blog-backend/go语言项目开发实战/08.特别放送/04#如何排障"><span>如何排障？</span></a></li><li title="发现问题" data-depth="3"><a href="/blog-backend/go语言项目开发实战/08.特别放送/04#发现问题"><span>发现问题</span></a></li><li title="定位问题" data-depth="3"><a href="/blog-backend/go语言项目开发实战/08.特别放送/04#定位问题"><span>定位问题</span></a></li><li title="解决问题" data-depth="3"><a href="/blog-backend/go语言项目开发实战/08.特别放送/04#解决问题"><span>解决问题</span></a></li><li title="IAM常见故障及解决办法" data-depth="2"><a href="/blog-backend/go语言项目开发实战/08.特别放送/04#iam常见故障及解决办法"><span>IAM常见故障及解决办法</span></a></li><li title="总结" data-depth="2"><a href="/blog-backend/go语言项目开发实战/08.特别放送/04#总结"><span>总结</span></a></li><li title="课后练习" data-depth="2"><a href="/blog-backend/go语言项目开发实战/08.特别放送/04#课后练习"><span>课后练习</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="特别放送--iam排障指南"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/08.特别放送/04#特别放送--iam排障指南"><span class="icon icon-link"></span></a>特别放送 | IAM排障指南</h1><p>你好，我是孔令飞。</p><p>今天我们更新一期特别放送作为加餐。在部署和使用IAM的过程中，难免会出现一些异常(也称为故障、问题)。这时候，就需要我们能够定位故障，并修复故障。这里，我总结了一些IAM的排障方法，以及一些常见故障的解决方法，供你参考。</p><h2 id="如何排障"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/08.特别放送/04#如何排障"><span class="icon icon-link"></span></a>如何排障？</h2><p>首先，我们需要发现问题，然后定位问题。我们可能需要经过多轮分析排查才能定位到问题的根因，最后去解决问题。排障流程如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage730f7330d836e7c4b5052c79bbd365abdd0f.9f00e99a.jpg" alt=""/></p><p>如果想排查问题并解决问题，你还需要具备这两个基本能力：能够理解错误日志的内容；根据错误日志，找出解决方案。</p><p>我们举个例子来说吧。有以下错误：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">[going@dev iam]$ mysql -h127.0.0.1 -uroot -p&#x27;iam59!z$&#x27;</span></div><div class="token-line"><span class="token plain">    bash: /usr/bin/mysql: 没有那个文件或目录</span></div><div class="token-line"><span class="token plain">    [going@dev iam]$</span></div></pre></div><p>对于这个错误，我们首先来理解错误内容：mysql命令没有找到，说明没有安装mysql，或者安装mysql失败。</p><p>那么，我们的解决方案就是重新执行 <a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/378082">03讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中安装MariaDB的步骤：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ cd $IAM_ROOT</span></div><div class="token-line"><span class="token plain">    $ ./scripts/install/mariadb.sh iam::mariadb::install</span></div></pre></div><p>接下来，我会以<code>iam-apiserver</code>服务为例，给你演示下具体如何排障并解决问题。</p><h3 id="发现问题"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/08.特别放送/04#发现问题"><span class="icon icon-link"></span></a>发现问题</h3><p>要排障，首先我们需要发现问题。我们通常用下面这几种方式来发现问题。</p><ul><li>检查服务状态：启动iam-apiserver服务后，执行<code>systemctl status iam-apiserver</code> 发现iam-apiserver启动失败，即<code>Active</code>的值不为<code>active (running)</code>。</li><li>功能异常：访问iam-apiserver服务，功能异常或者报错，例如接口返回值跟预期不一样等。</li><li>日志报错：在iam-apiserver的日志中发现一些<code>WARN</code>、<code>ERROR</code>、<code>PANIC</code>、<code>FATAL</code>等级别的错误日志。</li></ul><h3 id="定位问题"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/08.特别放送/04#定位问题"><span class="icon icon-link"></span></a>定位问题</h3><p>发现问题之后，就需要我们定位出问题的根本原因。我们可以通过下面这三种方式来定位问题。</p><ul><li>查看日志，它是最简单的排障方式。</li><li>使用Go调试工具Delve来定位问题。</li><li>添加Debug日志，从程序入口处跟读代码，在关键位置处打印Debug日志，来定位问题。</li></ul><p>在定位问题的过程中，我们可以采用“顺藤摸瓜”的思路去排查问题。比如，我们的程序执行流程是：A -&gt; B -&gt; … -&gt; N。其中A、B、N都可以理解为一个排查点。所谓的排查点，就是需要在该处定位问题的点，这些点可能是导致问题的根因所在。</p><p>在排障过程中，你可以根据最上层的日志报错，找到下一个排查点B。如果经过定位，发现B没有问题，那继续根据程序执行流程，找下一个排查点排查问题。如此反复，直到找到最终的排查点，也就是出问题的根因N，N即为Bug点。执行流程如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimagecc6dcc26b83cb2177106695e1a9f7f09ae6d.0195eeae.jpg" alt=""/></p><p>下面，我们来具体看看这三种定位问题的方法。</p><h4 id="查看日志定位问题"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/08.特别放送/04#查看日志定位问题"><span class="icon icon-link"></span></a>查看日志定位问题</h4><p>我们首先应该通过日志来定位问题，这是最简单高效的方式。要通过日志来定位问题，你不仅要会看日志，还要能读懂日志，也就是理解日志报错的原因。</p><p>下面我来具体讲解用这种方法定位问题的步骤。</p><p><strong>第一步，确保服务运行正常。</strong></p><p>你可以通过执行 <code>systemctl status</code> 命令来查看服务的运行状况：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ systemctl status iam-apiserver</span></div><div class="token-line"><span class="token plain">    ● iam-apiserver.service - IAM APIServer</span></div><div class="token-line"><span class="token plain">       Loaded: loaded (/etc/systemd/system/iam-apiserver.service; enabled; vendor preset: disabled)</span></div><div class="token-line"><span class="token plain">       Active: activating (auto-restart) (Result: exit-code) since Thu 2021-09-09 13:47:56 CST; 2s ago</span></div><div class="token-line"><span class="token plain">         Docs: https://github.com/marmotedu/iam/blob/master/init/README.md</span></div><div class="token-line"><span class="token plain">      Process: 119463 ExecStart=/opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml (code=exited, status=1/FAILURE)</span></div><div class="token-line"><span class="token plain">      Process: 119461 ExecStartPre=/usr/bin/mkdir -p /var/log/iam (code=exited, status=0/SUCCESS)</span></div><div class="token-line"><span class="token plain">      Process: 119460 ExecStartPre=/usr/bin/mkdir -p /data/iam/iam-apiserver (code=exited, status=0/SUCCESS)</span></div><div class="token-line"><span class="token plain">     Main PID: 119463 (code=exited, status=1/FAILURE)</span></div></pre></div><p>可以看到，<code>Active</code>不是<code>active (running)</code>，说明iam-apiserver服务没有正常运行。从上面输出中的<code>Process: 119463 ExecStart=/opt/iam/bin/iam-apiserver \--config=/etc/iam/iam-apiserver.yaml (code=exited, status=1/FAILURE)</code>信息中，我们可以获取以下信息：</p><ul><li>iam-apiserver服务启动命令为<code>/opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml</code>。</li><li><code>/opt/iam/bin/iam-apiserver</code>加载的配置文件为<code>/etc/iam/iam-apiserver.yaml</code>。</li><li><code>/opt/iam/bin/iam-apiserver</code>命令执行失败，退出码为1，其进程ID为<code>119463</code>。</li></ul><p>这里注意，<code>systemctl status</code>会将超过一定长度的行的后半部分用省略号替代，如果想查看完整的信息，可以追加<code>-l</code>参数，也就是<code>systemctl status \-l</code>来查看。</p><p>既然iam-apiserver命令启动失败，那我们就需要查看iam-apiserver启动时的日志，看看有没有一些报错日志。</p><p>接下来，就进入<strong>第二步，查看</strong><code>iam-apiserver</code><strong>运行日志。</strong></p><p>这里提一句，如果你对systemd不了解，也可以趁机恶补一波。你可以参考阮一峰大佬的两篇博客：<a target="_blank" rel="noopener noreferrer" href="https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html">Systemd 入门教程：命令篇<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a target="_blank" rel="noopener noreferrer" href="https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html">Systemd 入门教程：实战篇<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>那么如何查看呢？我们有3种查看方式，我在下面按优先级顺序排列了下。你在定位问题和查看日志时，按优先级3选1即可，1 &gt; 2 &gt; 3。</p><ol><li>通过<code>journalctl -u iam-apiserver</code>查看。</li><li>通过iam-apiserver日志文件查看。</li><li>通过console查看。</li></ol><p>下面我来分别介绍下这三种查看方式。</p><p>先来看优先级最高的方式，通过<code>journalctl \-u iam-apiserver</code>查看。</p><p>systemd 提供了自己的日志系统，称为 journal。我们可以使用<code>journalctl</code>命令来读取journal日志。<code>journalctl</code>提供了<code>-u</code>选项来查看某个 Unit 的日志，提供了<code>_PID</code>来查看指定进程ID的日志。在<strong>第一步</strong>中，我们知道服务启动失败的进程ID为<code>119463</code>。执行以下命令来查看这次启动的日志：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo journalctl _PID=119463</span></div><div class="token-line"><span class="token plain">    -- Logs begin at Thu 2021-09-09 09:12:25 CST, end at Thu 2021-09-09 14:40:48 CST. --</span></div><div class="token-line"><span class="token plain">    ...</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: 2021-09-09 13:47:56.727        INFO        apiserver        gorm@v1.21.12/gorm.go:202        mysql/mysql.go:75[error] faile&gt;</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: 2021-09-09 13:47:56.727        FATAL        apiserver        apiserver/server.go:139        Failed to get cache instance: g&gt;</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/internal/apiserver.(*completedExtraConfig).New</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:139</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/internal/apiserver.createAPIServer</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:66</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/internal/apiserver.Run</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/run.go:11</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/internal/apiserver.run.func1</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/app.go:46</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/pkg/app.(*App).runCommand</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:278</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/spf13/cobra.(*Command).execute</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:856</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/spf13/cobra.(*Command).ExecuteC</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:974</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/spf13/cobra.(*Command).Execute</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:902</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/pkg/app.(*App).Run</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:233</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: main.main</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/cmd/iam-apiserver/apiserver.go:24</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: runtime.main</span></div><div class="token-line"><span class="token plain">    Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/go/go1.16.2/src/runtime/proc.go:225</span></div><div class="token-line"><span class="token plain">    lines 10-54/54 (END)</span></div></pre></div><p>从上面的日志中，我们找到了服务启动失败的原因：<code>iam-apiserver</code>启动时，发生了<code>FATAL</code>级别的错误。到这里，你已经初步定位到问题原因了。</p><p>我们再来看通过iam-apiserver日志文件查看的方式。</p><p>作为一个企业级的实战项目，iam-apiserver的日志当然是会记录到日志文件中的。在<strong>第一步</strong>中，我们通过<code>systemctl status iam-apiserver</code>输出的信息，知道了iam-apiserver启动时加载的配置文件为<code>/etc/iam/iam-apiserver.yaml</code>。所以，我们可以通过iam-apiserver的配置文件iam-apiserver.yaml中的<code>log.output-paths</code>配置项，查看记录日志文件的位置：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">log:</span></div><div class="token-line"><span class="token plain">        name: apiserver # Logger的名字</span></div><div class="token-line"><span class="token plain">        development: true # 是否是开发模式。如果是开发模式，会对DPanicLevel进行堆栈跟踪。</span></div><div class="token-line"><span class="token plain">        level: debug # 日志级别，优先级从低到高依次为：debug, info, warn, error, dpanic, panic, fatal。</span></div><div class="token-line"><span class="token plain">        format: console # 支持的日志输出格式，目前支持console和json两种。console其实就是text格式。</span></div><div class="token-line"><span class="token plain">        enable-color: true # 是否开启颜色输出，true:是，false:否</span></div><div class="token-line"><span class="token plain">        disable-caller: false # 是否开启 caller，如果开启会在日志中显示调用日志所在的文件、函数和行号</span></div><div class="token-line"><span class="token plain">        disable-stacktrace: false # 是否在panic及以上级别禁止打印堆栈信息</span></div><div class="token-line"><span class="token plain">        output-paths: /var/log/iam/iam-apiserver.log,stdout # 支持输出到多个输出，逗号分开。支持输出到标准输出（stdout）和文件。</span></div><div class="token-line"><span class="token plain">        error-output-paths: /var/log/iam/iam-apiserver.error.log # zap内部(非业务)错误日志输出路径，多个输出，逗号分开</span></div></pre></div><p>可以看到，iam-apiserver将日志分别记录到了<code>/var/log/iam/iam-apiserver.log</code>和<code>stdout</code>中。所以，我们可以通过查看<code>/var/log/iam/iam-apiserver.log</code>日志文件，来查看报错信息：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ tail -25 /var/log/iam/iam-apiserver.log</span></div><div class="token-line"><span class="token plain">    ...</span></div><div class="token-line"><span class="token plain">    2021-09-09 15:42:35.231	INFO	apiserver	server/genericapiserver.go:88	GET    /version --&gt; github.com/marmotedu/iam/internal/pkg/server.(*GenericAPIServer).InstallAPIs.func2 (10 handlers)</span></div><div class="token-line"><span class="token plain">    2021-09-09 15:42:35.232	INFO	apiserver	gorm@v1.21.12/gorm.go:202	mysql/mysql.go:75[error] failed to initialize database, got error dial tcp 127.0.0.1:3309: connect: connection refused</span></div><div class="token-line"><span class="token plain">    2021-09-09 15:42:35.232	FATAL	apiserver	apiserver/server.go:139	Failed to get cache instance: got nil cache server</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/internal/apiserver.(*completedExtraConfig).New</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:139</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/internal/apiserver.createAPIServer</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:66</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/internal/apiserver.Run</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/run.go:11</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/internal/apiserver.run.func1</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/app.go:46</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/pkg/app.(*App).runCommand</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:278</span></div><div class="token-line"><span class="token plain">    github.com/spf13/cobra.(*Command).execute</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:856</span></div><div class="token-line"><span class="token plain">    github.com/spf13/cobra.(*Command).ExecuteC</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:974</span></div><div class="token-line"><span class="token plain">    github.com/spf13/cobra.(*Command).Execute</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:902</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/pkg/app.(*App).Run</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:233</span></div><div class="token-line"><span class="token plain">    main.main</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/cmd/iam-apiserver/apiserver.go:24</span></div><div class="token-line"><span class="token plain">    runtime.main</span></div><div class="token-line"><span class="token plain">    	/home/going/go/go1.16.2/src/runtime/proc.go:225</span></div></pre></div><p>我们再来看最后一种查看方式，通过console查看。</p><p>当然，我们也可以直接通过console来看日志，这就需要我们在Linux终端前台运行iam-apiserver（在<strong>第一步</strong>中，我们已经知道了启动命令）：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo /opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml</span></div><div class="token-line"><span class="token plain">    ...</span></div><div class="token-line"><span class="token plain">    2021-09-09 15:47:00.660	INFO	apiserver	server/genericapiserver.go:88	GET    /debug/pprof/mutex --&gt; github.com/gin-contrib/pprof.pprofHandler.func1 (10 handlers)</span></div><div class="token-line"><span class="token plain">    2021-09-09 15:47:00.660	INFO	apiserver	server/genericapiserver.go:88	GET    /debug/pprof/threadcreate --&gt; github.com/gin-contrib/pprof.pprofHandler.func1 (10 handlers)</span></div><div class="token-line"><span class="token plain">    2021-09-09 15:47:00.660	INFO	apiserver	server/genericapiserver.go:88	GET    /version --&gt; github.com/marmotedu/iam/internal/pkg/server.(*GenericAPIServer).InstallAPIs.func2 (10 handlers)</span></div><div class="token-line"><span class="token plain">    2021-09-09 15:47:00.661	INFO	apiserver	gorm@v1.21.12/gorm.go:202	mysql/mysql.go:75[error] failed to initialize database, got error dial tcp 127.0.0.1:3309: connect: connection refused</span></div><div class="token-line"><span class="token plain">    2021-09-09 15:47:00.661	FATAL	apiserver	apiserver/server.go:139	Failed to get cache instance: got nil cache server</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/internal/apiserver.(*completedExtraConfig).New</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:139</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/internal/apiserver.createAPIServer</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:66</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/internal/apiserver.Run</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/run.go:11</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/internal/apiserver.run.func1</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/app.go:46</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/pkg/app.(*App).runCommand</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:278</span></div><div class="token-line"><span class="token plain">    github.com/spf13/cobra.(*Command).execute</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:856</span></div><div class="token-line"><span class="token plain">    github.com/spf13/cobra.(*Command).ExecuteC</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:974</span></div><div class="token-line"><span class="token plain">    github.com/spf13/cobra.(*Command).Execute</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:902</span></div><div class="token-line"><span class="token plain">    github.com/marmotedu/iam/pkg/app.(*App).Run</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:233</span></div><div class="token-line"><span class="token plain">    main.main</span></div><div class="token-line"><span class="token plain">    	/home/going/workspace/golang/src/github.com/marmotedu/iam/cmd/iam-apiserver/apiserver.go:24</span></div><div class="token-line"><span class="token plain">    runtime.main</span></div><div class="token-line"><span class="token plain">    	/home/going/go/go1.16.2/src/runtime/proc.go:225</span></div></pre></div><p>通过上面这3种查看方式，我们均能初步定位到服务异常的原因。</p><h4 id="使用go调试工具delve来定位问题"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/08.特别放送/04#使用go调试工具delve来定位问题"><span class="icon icon-link"></span></a>使用Go调试工具Delve来定位问题</h4><p>查看日志是最简单的排障方式，通过查看日志，我们可能定位出问题的根本原因，这种情况下问题就能得到快速的解决。但有些情况下，我们通过日志并不一定能定位出问题，例如：</p><ul><li>程序异常，但是没有错误日志。</li><li>日志有报错，但只能判断问题的面，还不能精准找到问题的根因。</li></ul><p>遇到上面这两种情况，我们都需要再进一步地定位问题。这时候，我们可以使用Delve调试工具来尝试定位问题。Delve工具的用法你可以参考 <a target="_blank" rel="noopener noreferrer" href="https://github.com/marmotedu/geekbang-go/blob/master/Delve%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3.md">Delve使用详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><h4 id="添加debug日志定位问题"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/08.特别放送/04#添加debug日志定位问题"><span class="icon icon-link"></span></a>添加Debug日志定位问题</h4><p>如果使用 Delve 工具仍然没有定位出问题，接下来你可以尝试最原始的方法：添加Debug日志来定位问题。这种方法具体可以分为两个步骤。</p><p><strong>第一步，在关键代码段添加Debug日志。</strong></p><p>你需要根据自己对代码的理解来决定关键代码段。如果不确定哪段代码出问题，可以从请求入口处添加Debug日志，然后跟着代码流程一步步往下排查，并在需要的地方添加Debug日志。</p><p>例如，通过排查日志，我们定位到<code>internal/apiserver/server.go:139</code>位置的代码导致程序FATAL，FATAL原因是<code>Failed to get cache instance: got nil cache server</code>。<code>cache server</code>是<code>nil</code>，说明<code>cache server</code>没有被初始化。查看<code>cache server</code>初始化函数：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">func GetCacheInsOr(store store.Factory) (*Cache, error) {</span></div><div class="token-line"><span class="token plain">        if store != nil {</span></div><div class="token-line"><span class="token plain">            once.Do(func() {</span></div><div class="token-line"><span class="token plain">                cacheServer = &amp;Cache{store}</span></div><div class="token-line"><span class="token plain">            })</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        if cacheServer == nil {</span></div><div class="token-line"><span class="token plain">            return nil, fmt.Errorf(&quot;got nil cache server&quot;)</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        return cacheServer, nil</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>我们不难分析出，是<code>store == nil</code>导致<code>cacheServer</code>没有被初始化。再来看下store的初始化代码，并加一些Debug日志，如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimagecc15cc50c340e4ff0e5401b3d89430456b15.84ed6d1c.png" alt="图片"/></p><p>我们添加完Debug代码后，就可以重新编译并运行程序了。</p><p>这里有个小技巧：可以在错误返回的位置添加Debug日志，这样能大概率帮助你定位到出错的位置，例如：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">if err != nil {</span></div><div class="token-line"><span class="token plain">      log.Debugf(&quot;DEBUG POINT - 1: %v&quot;, err)</span></div><div class="token-line"><span class="token plain">      return err</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p><strong>第二步，重新编译源码，并启动。</strong></p><p>这里为了调试、看日志方便，我们直接在Linux终端的前端运行iam-apiserver：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo /opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml</span></div></pre></div><p>查看我们添加的Debug日志打印的内容，如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage610361f31a4b9e45ed9079470e928f7d3b03.67d9c362.png" alt="图片"/></p><p>从Debug日志中，可以看到用来创建MySQL实例的端口是错误的，正确的端口应该是<code>3306</code>，而不是<code>3309</code>。MySQL服务器的端口是在iam-apiserver.yaml中配置的。修改iam-apiserver.yaml为正确的配置，并启动：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo /opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml</span></div></pre></div><p>再次查看console日志，如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimagef79df72b766b7504016259bef04eb03dac9d.6ab0cbf6.png" alt="图片"/></p><p>可以看到问题已经修复，<code>dbIns</code>不为<code>nil</code>，程序正常运行：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ systemctl status iam-apiserver</span></div><div class="token-line"><span class="token plain">    ● iam-apiserver.service - IAM APIServer</span></div><div class="token-line"><span class="token plain">       Loaded: loaded (/etc/systemd/system/iam-apiserver.service; enabled; vendor preset: disabled)</span></div><div class="token-line"><span class="token plain">       Active: active (running) since Thu 2021-09-09 20:48:18 CST; 17s ago</span></div><div class="token-line"><span class="token plain">         Docs: https://github.com/marmotedu/iam/blob/master/init/README.md</span></div><div class="token-line"><span class="token plain">      Process: 255648 ExecStartPre=/usr/bin/mkdir -p /var/log/iam (code=exited, status=0/SUCCESS)</span></div><div class="token-line"><span class="token plain">      Process: 255647 ExecStartPre=/usr/bin/mkdir -p /data/iam/iam-apiserver (code=exited, status=0/SUCCESS)</span></div><div class="token-line"><span class="token plain">     Main PID: 255650 (iam-apiserver)</span></div><div class="token-line"><span class="token plain">        Tasks: 5 (limit: 23724)</span></div><div class="token-line"><span class="token plain">       Memory: 7.3M</span></div><div class="token-line"><span class="token plain">       CGroup: /system.slice/iam-apiserver.service</span></div><div class="token-line"><span class="token plain">               └─255650 /opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml</span></div></pre></div><p>在这里，<code>Active</code>为<code>active (running)</code>状态。</p><p>因为这些Debug日志能够协助你定位问题，从侧面说明这些日志是有用的，所以你可以保留这些Debug日志调用代码。</p><h3 id="解决问题"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/08.特别放送/04#解决问题"><span class="icon icon-link"></span></a>解决问题</h3><p>在定位问题阶段，我们已经找到了问题的原因，接下来就可以根据自己对业务、底层代码实现的掌握和理解，修复这个问题了。至于怎么修复，你需要结合具体情况来判断，并没有统一的流程和方法论，这里就不多介绍了。</p><p>上面，我介绍了排查问题的思路和方法。接下来，我来向你展示9个在部署和使用IAM系统时容易遇到的问题，并提供解决方法。这些问题基本上都是由服务器环境引起的。</p><h2 id="iam常见故障及解决办法"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/08.特别放送/04#iam常见故障及解决办法"><span class="icon icon-link"></span></a>IAM常见故障及解决办法</h2><p>**问题一：**安装neovim，报 <code>No match for argument: neovim</code> 错误。</p><p>解决方法是安装 EPEL 源：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm</span></div></pre></div><p>**问题二：**安装protoc-gen-go失败（超时、报错等）。</p><p>这个故障出现，可能是因为你当前服务器所在的网络环境无法访问<code>github.com</code>，或者访问<code>github.com</code>速度太慢。</p><p>解决方法是手动编译安装，方法如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ git clone --depth 1 https://github.com/golang/protobuf $GOPATH/src/github.com/golang/protobuf</span></div><div class="token-line"><span class="token plain">    $ cd $GOPATH/src/github.com/golang/protobuf/protoc-gen-go</span></div><div class="token-line"><span class="token plain">    $ go install -v .</span></div></pre></div><p>**问题三：**遇到<code>xxx: permission denied</code>这类的错误。</p><p>出现这种错误，是因为你没有权限执行当前的操作。解决方法是排查自己是否有权限执行当前操作。如果没有权限，需要你切换到有权限的用户，或者放弃执行当前操作。</p><p>为了说明问题，这里我举一个错误例子，并给出排查思路。例子的错误日志如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">[going@VM-8-9-centos /]$ go get -u github.com/golang/protobuf/protoc-gen-go</span></div><div class="token-line"><span class="token plain">    go: could not create module cache: mkdir /golang: permission denied</span></div><div class="token-line"><span class="token plain">    [going@VM-8-9-centos /]$ sudo go get -u github.com/golang/protobuf/protoc-gen-go</span></div><div class="token-line"><span class="token plain">    sudo: go: command not found</span></div></pre></div><p>上述错误中， 一共报了两个错误，分别是<code>mkdir /golang: permission denied</code>和<code>sudo: go: command not found</code>。我们先来看<code>mkdir /golang: permission denied</code>错误。</p><p>通过命令行提示符<code>$</code>可以知道，当前登陆用户是普通用户；通过报错<code>mkdir /golang: permission denied</code>可以知道<code>go get \-u github.com/golang/protobuf/protoc-gen-go</code>命令底层执行了<code>mkdir /golang</code>，因为普通用户没有写<code>/</code> 目录的权限，所以会报权限错误。解决方法是切换到用户的目录下，执行<code>go get \-u</code>命令。</p><p>我们再来看下<code>sudo: go: command not found</code>错误。<code>sudo</code>命令会将命令执行的环境切换到<code>root</code>用户，<code>root</code>用户显然是没有安装<code>go</code>命令的，所以会导致<code>command not found</code>错误。解决方式是去掉 <code>sudo</code> ，直接执行 <code>$ go get \-u xxx</code> 。</p><p>**问题四：**VimIDE使用过程中，报各类错误。</p><p>这里的报错原因跟环境有关系，安装VimIDE时的系统环境、包的版本等等，都可能会导致使用VimIDE报错。因为错误类型太多，没法一一说明，所以我建议你忽略这些错误，其实完全不影响后面的学习。</p><p>**问题五：**访问iam-authz-server的<code>/v1/authz</code>接口报<code>{<!-- -->&quot;code&quot;:100202,&quot;message&quot;:&quot;Signature is invalid&quot;<!-- -->}</code>。</p><p>这时可能是签发的Token有问题，建议重新执行以下5个步骤：</p><ol><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">重新登陆系统，并获取访问令牌：</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ token=`curl -s -XPOST -H&#x27;Content-Type: application/json&#x27; -d&#x27;{&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;Admin@2021&quot;}&#x27; http://127.0.0.1:8080/login | jq -r .token`</span></div></pre></div><p>如果没有安装<code>jq</code>命令，可以执行<code>sudo yum \-y install jq</code>命令来安装。</p><ol start="2"><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">创建授权策略：</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ curl -s -XPOST -H&quot;Content-Type: application/json&quot; -H&quot;Authorization: Bearer $token&quot; -d&#x27;{&quot;metadata&quot;:{&quot;name&quot;:&quot;authztest&quot;},&quot;policy&quot;:{&quot;description&quot;:&quot;One policy to rule them all.&quot;,&quot;subjects&quot;:[&quot;users:&lt;peter|ken&gt;&quot;,&quot;users:maria&quot;,&quot;groups:admins&quot;],&quot;actions&quot;:[&quot;delete&quot;,&quot;&lt;create|update&gt;&quot;],&quot;effect&quot;:&quot;allow&quot;,&quot;resources&quot;:[&quot;resources:articles:&lt;.*&gt;&quot;,&quot;resources:printer&quot;],&quot;conditions&quot;:{&quot;remoteIPAddress&quot;:{&quot;type&quot;:&quot;CIDRCondition&quot;,&quot;options&quot;:{&quot;cidr&quot;:&quot;192.168.0.1/16&quot;}}}}}&#x27; http://127.0.0.1:8080/v1/policies</span></div></pre></div><ol start="3"><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">创建密钥，并从命令的输出中提取secretID 和 secretKey：</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ curl -s -XPOST -H&quot;Content-Type: application/json&quot; -H&quot;Authorization: Bearer $token&quot; -d&#x27;{&quot;metadata&quot;:{&quot;name&quot;:&quot;authztest&quot;},&quot;expires&quot;:0,&quot;description&quot;:&quot;admin secret&quot;}&#x27; http://127.0.0.1:8080/v1/secrets</span></div><div class="token-line"><span class="token plain">    {&quot;metadata&quot;:{&quot;id&quot;:23,&quot;name&quot;:&quot;authztest&quot;,&quot;createdAt&quot;:&quot;2021-04-08T07:24:50.071671422+08:00&quot;,&quot;updatedAt&quot;:&quot;2021-04-08T07:24:50.071671422+08:00&quot;},&quot;username&quot;:&quot;admin&quot;,&quot;secretID&quot;:&quot;ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox&quot;,&quot;secretKey&quot;:&quot;7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8&quot;,&quot;expires&quot;:0,&quot;description&quot;:&quot;admin secret&quot;}</span></div></pre></div><ol start="4"><li>生成访问 iam-authz-server 的 Token</li></ol><p>iamctl 提供了 <code>jwt sigin</code> 命令，你可以根据 <code>secretID</code> 和 <code>secretKey</code> 签发 Token，方便你使用。签发Token的具体命令如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ iamctl jwt sign ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox 7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8 # iamctl jwt sign $secretID $secretKey</span></div><div class="token-line"><span class="token plain">    eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ</span></div></pre></div><ol start="5"><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">测试资源授权是否通过：</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ curl -s -XPOST -H&#x27;Content-Type: application/json&#x27; -H&#x27;Authorization: Bearer eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ&#x27; -d&#x27;{&quot;subject&quot;:&quot;users:maria&quot;,&quot;action&quot;:&quot;delete&quot;,&quot;resource&quot;:&quot;resources:articles:ladon-introduction&quot;,&quot;context&quot;:{&quot;remoteIPAddress&quot;:&quot;192.168.0.5&quot;}}&#x27; http://127.0.0.1:9090/v1/authz</span></div><div class="token-line"><span class="token plain">    {&quot;allowed&quot;:true}</span></div></pre></div><p>**问题六：**执行<code>iamctl user list</code>报<code>error: <!-- -->{<!-- -->&quot;code&quot;:100207,&quot;message&quot;:&quot;Permission denied&quot;<!-- -->}</code>。</p><p>出现这种情况，可能是密码没有配置正确。</p><p>你可以看下<code>$HOME/.iam/iamctl.yaml</code>配置文件中的用户名和密码配置的是不是admin，以及admin的密码是否是<code>Admin@2021</code>。</p><p>**问题七：**在创建用户时报<code>{<!-- -->&quot;code&quot;:100101,&quot;message&quot;:&quot;Database error&quot;<!-- -->}</code>错误。</p><p>出现这种情况，可能是用户名重了，建议换个新的用户名再次创建。</p><p>**问题八：**报<code>No such file or directory</code>、<code>command not found</code>、<code>permission denied</code>错误。</p><p>遇到这类错误，要根据提示排查和解决问题。</p><ul><li><code>No such file or directory</code>：确认文件是否存在，不存在的原因是什么。</li><li><code>command not found</code>：确认命令是否存在，如果不存在，可以重新安装命令。</li><li><code>permission denied</code>：确认是否有操作权限，如果没有，要切换到有权限的用户或者目录。</li></ul><p>**问题九：**报<code>iam-apiserver.service</code>、<code>/opt/iam/bin/iam-apiserver</code>、<code>/etc/iam/iam-apiserver.yaml</code>文件不存在。</p><p>我来介绍下这些文件的作用。</p><ul><li><code>/etc/systemd/system/iam-apiserver.service</code>：iam-apiserver的sysmted Unit文件。</li><li><code>/opt/iam/bin/iam-apiserver</code>：iam-apiserver的二进制启动命令。</li><li><code>/etc/iam/iam-apiserver.yaml</code>：iam-apiserver的配置文件。</li></ul><p>如果某个文件不存在，那就需要你重新安装这些文件。我来分别介绍这三个文件的安装方法。</p><p><code>/etc/systemd/system/iam-apiserver.service</code>安装方法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ cd $IAM_ROOT</span></div><div class="token-line"><span class="token plain">    $ ./scripts/genconfig.sh scripts/install/environment.sh init/iam-apiserver.service &gt; iam-apiserver.service</span></div><div class="token-line"><span class="token plain">    $ sudo mv iam-apiserver.service /etc/systemd/system/</span></div></pre></div><p><code>/opt/iam/bin/iam-apiserver</code>安装方法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ cd $IAM_ROOT</span></div><div class="token-line"><span class="token plain">    $ source scripts/install/environment.sh</span></div><div class="token-line"><span class="token plain">    $ make build BINS=iam-apiserver</span></div><div class="token-line"><span class="token plain">    $ sudo cp _output/platforms/linux/amd64/iam-apiserver ${IAM_INSTALL_DIR}/bin</span></div></pre></div><p><code>/etc/iam/iam-apiserver.yaml</code>安装方法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ cd $IAM_ROOT</span></div><div class="token-line"><span class="token plain">    $ ./scripts/genconfig.sh scripts/install/environment.sh configs/iam-apiserver.yaml &gt; iam-apiserver.yaml</span></div><div class="token-line"><span class="token plain">    $ sudo mv iam-apiserver.yaml ${IAM_CONFIG_DIR}</span></div></pre></div><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/08.特别放送/04#总结"><span class="icon icon-link"></span></a>总结</h2><p>这一讲，我以<code>iam-apiserver</code>服务为例，向你介绍了排障的基本流程：发现问题 -&gt; 定位问题 -&gt; 解决问题。</p><p>你可以通过三种方式来发现问题。</p><ul><li>检查服务状态：启动iam-apiserver服务后，执行<code>systemctl status iam-apiserver</code> 发现iam-apiserver启动失败，即<code>Active</code>的值不为<code>active (running)</code>。</li><li>功能异常：访问iam-apiserver服务，功能异常或者报错，例如接口返回值跟预期不一样；接口报错。</li><li>日志报错：在iam-apiserver的日志中发现一些<code>WARN</code>、<code>ERROR</code>、<code>PANIC</code>、<code>FATAL</code>等高级别的错误日志。</li></ul><p>发现问题之后，你可以通过查看日志、使用Go调试工具Delve和添加Debug日志这三种方式来定位问题。</p><ul><li>查看日志：查看日志是最简单的排障方式。</li><li>使用Go调试工具Delve来定位问题。</li><li>添加Debug日志：从程序入口处跟读代码，在关键位置处打印Debug日志，来定位问题。</li></ul><p>找到问题根因之后，就要解决问题。你需要根据自己对业务、底层代码实现的掌握和理解，解决这个问题。</p><p>最后，我向你展示了9个在部署和使用IAM系统时容易遇到的问题，并提供了解决方法，希望能给你一些切实的帮助。</p><h2 id="课后练习"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/08.特别放送/04#课后练习"><span class="icon icon-link"></span></a>课后练习</h2><ol><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">思考下，如何查找iam-apiserver的systemd Unit文件的路径？</span></div></pre></div></li><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">执行以下命令：</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ token=`curl -s -XPOST -H&#x27;Content-Type: application/json&#x27; -d&#x27;{&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;Admin@2021&quot;}&#x27; http://127.0.0.1:8080/login | jq -r .token`</span></div><div class="token-line"><span class="token plain">    $ echo $token</span></div></pre></div><p>可以获取<code>token</code>，但发现<code>token</code>值为空。请给出你的排障流程和方法。</p><p>欢迎你在留言区与我交流讨论，我们下一讲见。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/go语言项目开发实战/08.特别放送/04.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/27 11:15:40</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-backend/umi.e14e5a14.js"></script>
  </body>
</html>
