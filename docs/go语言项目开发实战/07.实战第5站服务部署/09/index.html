<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-backend/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-backend";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>48 | 基于腾讯云 EKS 的容器化部署实战 - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/go语言项目开发实战/07.实战第5站服务部署/09" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-backend/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>后端开发<ul><li><a href="/blog-backend/go语言核心36讲">go语言核心36讲</a></li><li><a href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a aria-current="page" class="active" href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/kafka核心技术与实战">kafka核心技术与实战</a></li><li><a href="/blog-backend/kafka核心源码解读">kafka核心源码解读</a></li><li><a href="/blog-backend/零基础学python">零基础学python</a></li><li><a href="/blog-backend/python核心技术与实战">python核心技术与实战</a></li><li><a href="/blog-backend/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-backend/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-backend/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-backend/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-backend/后端存储实战课">后端存储实战课</a></li><li><a href="/blog-backend/后端技术面试38讲">后端技术面试38讲</a></li><li><a href="/blog-backend/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li><li><a href="/blog-backend/现代c编程实战">现代c编程实战</a></li><li><a href="/blog-backend/罗剑锋的c实战笔记">罗剑锋的c实战笔记</a></li><li><a href="/blog-backend/零基础入门spark">零基础入门spark</a></li></ul></span><span>架构师<ul><li><a href="/blog-backend/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-backend/数据中台实战课">数据中台实战课</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-backend/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>后端开发<ul><li><a href="/blog-backend/go语言核心36讲">go语言核心36讲</a></li><li><a href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a aria-current="page" class="active" href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/kafka核心技术与实战">kafka核心技术与实战</a></li><li><a href="/blog-backend/kafka核心源码解读">kafka核心源码解读</a></li><li><a href="/blog-backend/零基础学python">零基础学python</a></li><li><a href="/blog-backend/python核心技术与实战">python核心技术与实战</a></li><li><a href="/blog-backend/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-backend/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-backend/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-backend/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-backend/后端存储实战课">后端存储实战课</a></li><li><a href="/blog-backend/后端技术面试38讲">后端技术面试38讲</a></li><li><a href="/blog-backend/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li><li><a href="/blog-backend/现代c编程实战">现代c编程实战</a></li><li><a href="/blog-backend/罗剑锋的c实战笔记">罗剑锋的c实战笔记</a></li><li><a href="/blog-backend/零基础入门spark">零基础入门spark</a></li></ul></li><li>架构师<ul><li><a href="/blog-backend/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-backend/数据中台实战课">数据中台实战课</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/go语言项目开发实战/01.开篇词">01.开篇词</a><ul><li><a href="/blog-backend/go语言项目开发实战/01.开篇词/01"><span>开篇词 | 从 0 开始搭建一个企业级 Go 应用</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/02.课前必学">02.课前必学</a><ul><li><a href="/blog-backend/go语言项目开发实战/02.课前必学/01"><span>01 | IAM系统概述：我们要实现什么样的 Go 项目？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/02.课前必学/02"><span>02 | 环境准备：如何安装和配置一个基本的 Go 开发环境？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/02.课前必学/03"><span>03 | 项目部署：如何快速部署 IAM 系统？</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计">03.实战第1站规范设计</a><ul><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/01"><span>04 | 规范设计（上）：项目开发杂乱无章，如何规范？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/02"><span>05 | 规范设计（下）：commit 信息风格迥异、难以阅读，如何规范？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/03"><span>06 | 目录结构设计：如何组织一个可维护、可扩展的代码目录？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/04"><span>07 | 工作流设计：如何设计合理的多人开发模式？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/05"><span>08 | 研发流程设计（上）：如何设计 Go 项目的开发流程？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/06"><span>09 | 研发流程设计（下）：如何管理应用的生命周期？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/07"><span>10 | 设计方法：怎么写出优雅的 Go 项目？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/03.实战第1站规范设计/08"><span>11 | 设计模式：Go常用设计模式概述</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发">04.实战第2站基础功能设计或开发</a><ul><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/01"><span>12 | API 风格（上）：如何设计RESTful API？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/02"><span>13 | API 风格（下）：RPC API介绍</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/03"><span>14 | 项目管理：如何编写高质量的Makefile？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/04"><span>15 | 研发流程实战：IAM项目是如何进行研发流程管理的？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/05"><span>16 | 代码检查：如何进行静态代码检查？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/06"><span>17 | API 文档：如何生成 Swagger API 文档 ？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/07"><span>18 | 错误处理（上）：如何设计一套科学的错误码？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/08"><span>19 | 错误处理（下）：如何设计错误包？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/09"><span>20 | 日志处理（上）：如何设计日志包并记录日志？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/10"><span>21 | 日志处理（下）：手把手教你从 0 编写一个日志包</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/11"><span>22 | 应用构建三剑客：Pflag、Viper、Cobra 核心功能介绍</span></a></li><li><a href="/blog-backend/go语言项目开发实战/04.实战第2站基础功能设计或开发/12"><span>23 | 应用构建实战：如何构建一个优秀的企业应用框架？</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发">05.实战第3站服务开发</a><ul><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/01"><span>24 | Web 服务：Web 服务核心功能有哪些，如何实现？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/02"><span>25 | 认证机制：应用程序如何进行访问认证？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/03"><span>26 | IAM项目是如何设计和实现访问认证功能的？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/04"><span>27 | 权限模型：5大权限模型是如何进行资源授权的？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/05"><span>28 | 控制流（上）：通过iam-apiserver设计，看Web服务的构建</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/06"><span>29｜控制流（下）：iam-apiserver服务核心功能实现讲解</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/07"><span>30 | ORM：CURD 神器 GORM 包介绍及实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/08"><span>31 | 数据流：通过iam-authz-server设计，看数据流服务的设计</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/09"><span>32 | 数据处理：如何高效处理应用程序产生的数据？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/10"><span>33 |  SDK 设计（上）：如何设计出一个优秀的 Go SDK？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/11"><span>34 | SDK 设计（下）：IAM项目Go SDK设计和实现</span></a></li><li><a href="/blog-backend/go语言项目开发实战/05.实战第3站服务开发/12"><span>35 | 效率神器：如何设计和实现一个命令行客户端工具？</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/06.实战第4站服务测试">06.实战第4站服务测试</a><ul><li><a href="/blog-backend/go语言项目开发实战/06.实战第4站服务测试/01"><span>36 | 代码测试（上）：如何编写 Go 语言单元测试和性能测试用例？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/06.实战第4站服务测试/02"><span>37 | 代码测试（下）：Go 语言其他测试类型及 IAM 测试介绍</span></a></li><li><a href="/blog-backend/go语言项目开发实战/06.实战第4站服务测试/03"><span>38｜性能分析（上）：如何分析 Go 语言代码的性能？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/06.实战第4站服务测试/04"><span>39｜性能分析（下）：API Server性能测试和调优实战</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署">07.实战第5站服务部署</a><ul><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/01"><span>40 | 软件部署实战（上）：部署方案及负载均衡、高可用组件介绍</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/02"><span>41 | 软件部署实战（中）：IAM 系统生产环境部署实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/03"><span>42 | 软件部署实战（下）：IAM系统安全加固、水平扩缩容实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/04"><span>43｜技术演进（上）：虚拟化技术演进之路</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/05"><span>44｜技术演进（下）：软件架构和应用生命周期技术演进之路</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/06"><span>45｜基于Kubernetes的云原生架构设计</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/07"><span>46 | 如何制作Docker镜像？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/08"><span>47 | 如何编写Kubernetes资源定义文件？</span></a></li><li><a aria-current="page" class="active" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09"><span>48 | 基于腾讯云 EKS 的容器化部署实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/10"><span>49 | 服务编排（上）：Helm服务编排基础知识</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/11"><span>50 | 服务编排（下）：基于Helm的服务编排部署实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/12"><span>51 | 基于 GitHub Actions 的 CI 实战</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送">08.特别放送</a><ul><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/01"><span>特别放送 | 给你一份清晰、可直接套用的Go编码规范</span></a></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/02"><span>特别放送 | 给你一份Go项目中最常用的Makefile核心语法</span></a></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/03"><span>特别放送 | Go Modules依赖包管理全讲</span></a></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/04"><span>特别放送 | IAM排障指南</span></a></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/05"><span>特别放送 | Go Modules实战</span></a></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/06"><span>特别放送 | 分布式作业系统设计和实现</span></a></li><li><a href="/blog-backend/go语言项目开发实战/08.特别放送/07"><span>直播加餐｜如何从小白进阶成 Go 语言专家？</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/09.结束语">09.结束语</a><ul><li><a href="/blog-backend/go语言项目开发实战/09.结束语/01"><span>结束语 | 如何让自己的 Go 研发之路走得更远？</span></a></li><li><a href="/blog-backend/go语言项目开发实战/09.结束语/02"><span>期末考试｜《Go语言项目开发实战》满分试卷，等你来挑战！</span></a></li></ul></li><li><a href="/blog-backend/go语言项目开发实战/summary">go语言项目开发实战</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="准备工作" data-depth="2"><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#准备工作"><span>准备工作</span></a></li><li title="开通腾讯云容器服务镜像仓库" data-depth="3"><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#开通腾讯云容器服务镜像仓库"><span>开通腾讯云容器服务镜像仓库</span></a></li><li title="安装Docker" data-depth="3"><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#安装docker"><span>安装Docker</span></a></li><li title="准备一个Kubernetes集群" data-depth="3"><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#准备一个kubernetes集群"><span>准备一个Kubernetes集群</span></a></li><li title="安装IAM应用" data-depth="2"><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#安装iam应用"><span>安装IAM应用</span></a></li><li title="测试IAM应用" data-depth="2"><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#测试iam应用"><span>测试IAM应用</span></a></li><li title="销毁EKS集群及其资源" data-depth="2"><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#销毁eks集群及其资源"><span>销毁EKS集群及其资源</span></a></li><li title="总结" data-depth="2"><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#总结"><span>总结</span></a></li><li title="课后练习" data-depth="2"><a href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#课后练习"><span>课后练习</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="48--基于腾讯云-eks-的容器化部署实战"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#48--基于腾讯云-eks-的容器化部署实战"><span class="icon icon-link"></span></a>48 | 基于腾讯云 EKS 的容器化部署实战</h1><p>你好，我是孔令飞。</p><p>在 <a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/415606">45讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中，我介绍了一种基于Kubernetes的云原生架构设计方案。在云原生架构中，我们是通过Docker + Kubernetes来部署云原生应用的。那么这一讲，我就手把手教你如何在Kubernetes集群中部署好IAM应用。因为步骤比较多，所以希望你能跟着我完成每一个操作步骤。相信在实操的过程中，你也会学到更多的知识。</p><h2 id="准备工作"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#准备工作"><span class="icon icon-link"></span></a>准备工作</h2><p>在部署IAM应用之前，我们需要做以下准备工作：</p><ol><li>开通腾讯云容器服务镜像仓库。</li><li>安装并配置Docker。</li><li>准备一个Kubernetes集群。</li></ol><h3 id="开通腾讯云容器服务镜像仓库"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#开通腾讯云容器服务镜像仓库"><span class="icon icon-link"></span></a>开通腾讯云容器服务镜像仓库</h3><p>在Kubernetes集群中部署IAM应用，需要从镜像仓库下载指定的IAM镜像，所以首先需要有一个镜像仓库来托管IAM的镜像。我们可以选择将IAM镜像托管到<a target="_blank" rel="noopener noreferrer" href="https://hub.docker.com/">DockerHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上，这也是docker运行时默认获取镜像的地址。</p><p>但因为DockerHub服务部署在国外，国内访问速度很慢。所以，我建议将IAM镜像托管在国内的镜像仓库中。这里我们可以选择腾讯云提供的镜像仓库服务，访问地址为<a target="_blank" rel="noopener noreferrer" href="https://console.cloud.tencent.com/tke2/registry">容器镜像服务个人版<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>如果你已经有腾讯云的镜像仓库，可以忽略腾讯云镜像仓库开通步骤。</p><p>在开通腾讯云镜像仓库之前，你需要<a target="_blank" rel="noopener noreferrer" href="https://cloud.tencent.com/document/product/378/17985">注册腾讯云账号<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，并完成<a target="_blank" rel="noopener noreferrer" href="https://cloud.tencent.com/document/product/378/3629">实名认证<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>开通腾讯云镜像仓库的具体步骤如下：</p><p><strong>第一步，开通个人版镜像仓库。</strong></p><ol><li><p>登录<a target="_blank" rel="noopener noreferrer" href="https://console.cloud.tencent.com/tke2">容器服务控制台<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，选择左侧导航栏中的【镜像仓库】&gt;【<a target="_blank" rel="noopener noreferrer" href="https://console.cloud.tencent.com/tke2/registry/user/self">个人版<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>】。</p></li><li><p>根据以下提示，填写相关信息，并单击**【开通】**进行初始化。如下图所示：</p></li></ol><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage1d8c1d4bdfe89bc049d224e7002c23a0ea8c.4d0e0612.png" alt="图片"/></p><ul><li>**用户名：**默认是当前用户的账号ID，是你登录到腾讯云Docker镜像仓库的身份，可在 <a target="_blank" rel="noopener noreferrer" href="https://console.cloud.tencent.com/developer">账号信息<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 页面获取。</li><li>**密码：**是你登录到腾讯云 Docker 镜像仓库的凭证。</li></ul><p>这里需要你记录用户名及密码，用于推送及拉取镜像。假如我们开通的镜像仓库，用户名为<code>10000099xxxx</code>，密码为<code>iam59!z$</code>。</p><p>这里要注意，<code>10000099xxxx</code><strong>要替换成你镜像仓库的用户名。</strong></p><p><strong>第二步，登录到腾讯云Registry</strong>**（镜像仓库）。**</p><p>在我们开通完Registry，就可以登录Registry了。可以通过以下命令来登录腾讯云Registry：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ docker login --username=[username] ccr.ccs.tencentyun.com</span></div></pre></div><p>这里的username是腾讯云账号 ID，开通时已注册，可在 <a target="_blank" rel="noopener noreferrer" href="https://console.cloud.tencent.com/developer">账号信息<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 页面获取。docker命令会在后面安装。<br/><strong>第三步，新建镜像仓库命名空间</strong>**。**</p><p>如果想使用镜像仓库，那么你首先需要创建一个用来创建镜像的命名空间。上一步，我们开通了镜像仓库，就可以在“命名空间”页签新建命名空间了，如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage1e5a1e79852fdc5ee1a094bd42efdf21015a.00cb1389.png" alt="图片"/></p><p>上图中，我们创建了一个叫<code>marmotedu</code>的命名空间。</p><p>这里，镜像仓库服务、命名空间、镜像仓库、标签这几个概念你可能弄不清楚。接下来，我详细介绍下四者的关系，关系如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimageab3babe8358d3ea2851bc32c80fd9519c63b.71df05b8.jpg" alt=""/></p><p>先来看下我们使用镜像仓库的格式：<code>&lt;镜像仓库服务地址&gt;/&lt;命名空间&gt;/&lt;镜像仓库&gt;:&lt;标签&gt;</code>，例如<code>ccr.ccs.tencentyun.com/marmotedu/iam-apiserver-amd64:v1.1.0</code>。</p><p>如果想使用一个Docker镜像，我们首先需要开通一个镜像仓库服务（Registry），镜像仓库服务都会对外提供一个固定的地址供你访问。在Registry中，我们（User）可以创建一个或多个命名空间（Namespace），命名空间也可以简单理解为镜像仓库逻辑上的一个分组。</p><p>接下来，就可以在Namespace中创建一个或多个镜像仓库，例如<code>iam-apiserver-amd64</code>、<code>iam-authz-server-amd64</code>、<code>iam-pump-amd64</code>等。针对每一个镜像仓库，又可以创建多个标签（Tag），例如<code>v1.0.1</code>、<code>v1.0.2</code>等。</p><p><code>&lt;镜像仓库&gt;:&lt;标签&gt;</code>又称为镜像。镜像又分为私有镜像和公有镜像，公有镜像可供所有能访问Registry的用户下载使用，私有镜像只提供给通过授权的用户使用。</p><h3 id="安装docker"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#安装docker"><span class="icon icon-link"></span></a>安装Docker</h3><p>开通完镜像仓库之后，我们还需要安装Docker，用来构建和测试Docker镜像。下面我来讲解下具体的安装步骤。</p><p><strong>第一步，安装Docker前置条件检查。</strong></p><p>需要确保CentOS系统启用了<code>centos-extras</code> yum源，默认情况下已经启用，检查方式如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ cat /etc/yum.repos.d/CentOS-Extras.repo</span></div><div class="token-line"><span class="token plain">    # Qcloud-Extras.repo</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    [extras]</span></div><div class="token-line"><span class="token plain">    name=Qcloud-$releasever - Extras</span></div><div class="token-line"><span class="token plain">    baseurl=http://mirrors.tencentyun.com/centos/$releasever/extras/$basearch/os/</span></div><div class="token-line"><span class="token plain">    gpgcheck=1</span></div><div class="token-line"><span class="token plain">    enabled=1</span></div><div class="token-line"><span class="token plain">    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Qcloud-8</span></div></pre></div><p>如果<code>/etc/yum.repos.d/CentOS-Extras.repo</code>文件存在，且文件中<code>extras</code>部分的<code>enabled</code>配置项值为<code>1</code>，说明已经启用了<code>centos-extras</code> yum源。如果<code>/etc/yum.repos.d/CentOS-Extras.repo</code> 文件不存在，或者<code>enabled</code> 不为1，则需要创建<code>/etc/yum.repos.d/CentOS-Extras.repo</code> 文件，并将上述内容复制进去。</p><p><strong>第二步，安装docker。</strong></p><p>Docker官方文档 <a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/engine/install/centos/">Install Docker Engine on CentOS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提供了3种安装方法:</p><ul><li>通过Yum源安装。</li><li>通过RPM包安装</li><li>通过脚本安装。</li></ul><p>这里，我们选择最简单的安装方式：<strong>通过Yum源安装</strong>。它具体又分为下面3个步骤。</p><ol><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">安装docker。</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo yum install -y yum-utils # 1. 安装 `yum-utils` 包，该包提供了 `yum-config-manager` 工具</span></div><div class="token-line"><span class="token plain">    $ sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo # 2. 安装 `docker-ce.repo` yum 源</span></div><div class="token-line"><span class="token plain">    $ sudo yum-config-manager --enable docker-ce-nightly docker-ce-test # 3. 启用 `nightly` 和 `test` yum 源</span></div><div class="token-line"><span class="token plain">    $ sudo yum install -y docker-ce docker-ce-cli containerd.io # 4. 安装最新版本的 docker 引擎和 containerd</span></div></pre></div><ol start="2"><li>启动docker。</li></ol><p>可以通过以下命令来启动 docker：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo systemctl start docker</span></div></pre></div><p>docker的配置文件是 <code>/etc/docker/daemon.json</code> ，这个配置文件默认是没有的，需要我们手动创建：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo tee /etc/docker/daemon.json &lt;&lt; EOF</span></div><div class="token-line"><span class="token plain">    {</span></div><div class="token-line"><span class="token plain">      &quot;bip&quot;: &quot;172.16.0.1/24&quot;,</span></div><div class="token-line"><span class="token plain">      &quot;registry-mirrors&quot;: [],</span></div><div class="token-line"><span class="token plain">      &quot;graph&quot;: &quot;/data/lib/docker&quot;</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    EOF</span></div></pre></div><p>这里，我来解释下常用的配置参数。</p><ul><li>registry-mirrors：仓库地址，可以根据需要修改为指定的地址。</li><li>graph：镜像、容器的存储路径，默认是/var/lib/docker。如果你的 <code>/</code> 目录存储空间满足不了需求，需要设置graph为更大的目录。</li><li>bip：指定容器的IP网段。</li></ul><p>配置完成后，需要重启Docker：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo systemctl restart docker</span></div></pre></div><ol start="3"><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">测试Docker是否安装成功。</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo docker run hello-world</span></div><div class="token-line"><span class="token plain">    Unable to find image &#x27;hello-world:latest&#x27; locally</span></div><div class="token-line"><span class="token plain">    latest: Pulling from library/hello-world</span></div><div class="token-line"><span class="token plain">    b8dfde127a29: Pull complete</span></div><div class="token-line"><span class="token plain">    Digest: sha256:0fe98d7debd9049c50b597ef1f85b7c1e8cc81f59c8d623fcb2250e8bec85b38</span></div><div class="token-line"><span class="token plain">    Status: Downloaded newer image for hello-world:latest</span></div><div class="token-line"><span class="token plain">    ...</span></div><div class="token-line"><span class="token plain">    Hello from Docker!</span></div><div class="token-line"><span class="token plain">    This message shows that your installation appears to be working correctly.</span></div><div class="token-line"><span class="token plain">    ....</span></div></pre></div><p><code>docker run hello-world</code>命令会下载<code>hello-world</code>镜像，并启动容器，打印安装成功提示信息后退出。</p><p>这里注意，如果你通过Yum源安装失败，可以尝试Docker官方文档 <a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/engine/install/centos/">Install Docker Engine on CentOS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提供的其他方式安装。</p><p><strong>第三步，安装后配置。</strong></p><p>安装成功后，我们还需要做一些其他配置。主要有两个，一个是配置docker，使其可通过<code>non-root</code>用户使用，另一个是配置docker开机启动。</p><ol><li>使用<code>non-root</code>用户操作Docker</li></ol><p>我们在Linux系统上操作，为了安全，需要以普通用户的身份登录系统并执行操作。所以，我们需要配置docker，使它可以被<code>non-root</code>用户使用。具体配置方法如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo groupadd docker # 1. 创建`docker`用户组</span></div><div class="token-line"><span class="token plain">    $ sudo usermod -aG docker $USER # 2. 将当前用户添加到`docker`用户组下</span></div><div class="token-line"><span class="token plain">    $ newgrp docker # 3. 重新加载组成员身份</span></div><div class="token-line"><span class="token plain">    $ docker run hello-world # 4. 确认能够以普通用户使用docker</span></div></pre></div><p>如果在执行 <code>sudo groupadd docker</code> 时报 <code>groupadd: group &#x27;docker&#x27; already exists</code> 错误，说明 <code>docker</code> 组已经存在了，可以忽略这个报错。</p><p>如果你在将用户添加到 docker 组之前，使用sudo运行过docker命令，你可能会看到以下错误：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">WARNING: Error loading config file: /home/user/.docker/config.json -</span></div><div class="token-line"><span class="token plain">    stat /home/user/.docker/config.json: permission denied</span></div></pre></div><p>这个错误，我们可以通过删除<code>~/.docker/</code>目录来解决，或者通过以下命令更改<code>~/.docker/</code>目录的所有者和权限：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo chown &quot;$USER&quot;:&quot;$USER&quot; /home/&quot;$USER&quot;/.docker -R</span></div><div class="token-line"><span class="token plain">    $ sudo chmod g+rwx &quot;$HOME/.docker&quot; -R</span></div></pre></div><ol start="2"><li>配置docker开机启动</li></ol><p>大部分Linux发行版（RHEL、CentOS、Fedora、Debian、Ubuntu 16.04及更高版本）使用systemd来管理服务，包括指定开启时启动的服务。在Debian和Ubuntu上，Docker默认配置为开机启动。</p><p>在其他系统，我们需要手动配置Docker开机启动，配置方式如下（分别需要配置docker和containerd服务）：</p><p>要在引导时为其他发行版自动启动 Docker 和 Containerd，你可以使用以下命令：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo systemctl enable docker.service # 设置 docker 开机启动</span></div><div class="token-line"><span class="token plain">    $ sudo systemctl enable containerd.service # 设置 containerd 开机启动</span></div></pre></div><p>如果要禁止<code>docker</code>、<code>containerd</code>开启启动，可以用这个命令：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ sudo systemctl disable docker.service # 禁止 docker 开机启动</span></div><div class="token-line"><span class="token plain">    $ sudo systemctl disable containerd.service # 禁止 containerd 开机启动</span></div></pre></div><h3 id="准备一个kubernetes集群"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#准备一个kubernetes集群"><span class="icon icon-link"></span></a>准备一个Kubernetes集群</h3><p>安装完Docker之后，我们还需要一个Kubernetes集群，来调度docker容器。安装Kubernetes集群极其复杂，这里选择一种最简单的方式来准备一个Kubernetes集群：购买一个腾讯云弹性集群（EKS）。</p><p>如果你想自己搭建Kubernetes集群，这里建议你购买3台腾讯云CVM机器，并参照<a target="_blank" rel="noopener noreferrer" href="https://github.com/opsnull/follow-me-install-kubernetes-cluster">follow-me-install-kubernetes-cluster<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>教程来一步步搭建Kubernetes集群，CVM机器建议的最小配置如下：<br/><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage880b885d2431e7f2d9bcd02b32d33yye930b.8af9ec3b.jpg" alt=""/></p><h4 id="eks简介"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#eks简介"><span class="icon icon-link"></span></a>EKS简介</h4><p>我先简单介绍一下EKS是什么。EKS（Elastic Kubernetes Service）即腾讯云弹性容器服务，是腾讯云容器服务推出的无须用户购买节点即可部署工作负载的服务模式。它完全兼容原生的 Kubernetes，支持使用原生方式创建及管理资源，按照容器真实的资源使用量计费。弹性容器服务 EKS 还扩展支持腾讯云的存储及网络等产品，同时确保用户容器的安全隔离，开箱即用。</p><h4 id="eks费用"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#eks费用"><span class="icon icon-link"></span></a>EKS费用</h4><p>那它是如何收费呢？EKS 是全托管的Serverless Kubernetes 服务，不会收取托管的 Master、etcd 等资源的费用。弹性集群内运行的工作负载采用后付费的按量计费模式，费用根据实际配置的资源量按使用时间计算。也就是说：<strong>Kubernetes集群本身是免费的，只有运行工作负载，消耗节点资源时收费。</strong></p><p>EKS有3种计费模式：预留券、按量计费、竞价模式，这里我建议选择<strong>按量计费</strong>。按量计费，支持按秒计费，按小时结算，随时购买随时释放，从专栏学习的角度来说，费用是最低的。EKS 会根据工作负载申请的 CPU、内存数值以及工作负载的运行时间来核算费用，具体定价，你可以参考：<a target="_blank" rel="noopener noreferrer" href="https://buy.cloud.tencent.com/price/eks">定价|弹性容器服务<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>这里我通过例子来说明一下费用问题，IAM应用会部署4个Deployment，每个Deployment一个副本：</p><ul><li>iam-apiserver：IAM REST API服务，提供用户、密钥、策略资源的CURD功能的API接口。</li><li>iam-authz-server：IAM资源授权服务，对外提供资源授权接口。</li><li>iam-pump：IAM数据清洗服务，从Redis中获取授权日志，处理后保存在MongoDB中。</li><li>iamctl：IAM应用的测试服务，登陆iamctl Pod可以执行iamctl命令和smoke测试脚本，完成对IAM应用的运维和测试。</li></ul><p>上述4个Deployment中的<strong>Pod配置均为0.25核、512Mi内存</strong>。</p><p>这里，我们根据EKS的费用计算公式 <code>费用 = 相关计费项配置 × 资源单位时间价格 × 运行时间</code> 计算IAM部署一天的费用：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">总费用 = (4 x 1) x (0.25 x 0.12 + 0.5 x 0.05) x 24 = 4.8 元</span></div></pre></div><p>也就是按最低配置部署IAM应用，运行一天的费用是4.8元（一瓶水的钱，就能学到如何将IAM应用部署在Kubernetes平台上，很值！）。你可能想这个计算公式里每个数值都代表什么呢？我来解释一下，其中：</p><ul><li>(4 x 1)：Kubernetes Pod总个数（一共是4个Deployment，每个Pod 1个副本）。</li><li>0.25 x 0.12：连续运行1小时的CPU配置费用。</li><li>0.5 x 0.05：连续运行1小时的内存配置费用。</li><li>24：24小时，也即一天。</li></ul><p>这里需要注意，为了帮助你节省费用，上述配置都是最低配置。在实际生产环境中，建议的配置如下：<br/><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage1d351d20c7eeb9dba8f53194969b0da5e835.2d45455d.jpg" alt=""/><br/>因为iam-pump组件是有状态的，并且目前没有实现抢占机制，所以副本数需要设置为1。</p><p>另外，Intel按量计费的配置费用见下图：</p><p><img src="data:image/png;base64,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" alt="图片"/></p><p>在这里有个很重要的事情提醒你：<strong>学完本节课，销毁这些Deployment，避免被继续扣费。建议腾讯云账户余额不要超过50元。</strong></p><h4 id="申请eks集群"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#申请eks集群"><span class="icon icon-link"></span></a>申请EKS集群</h4><p>了解了EKS以及费用相关的问题，接下来我们看看如何申请EKS集群。你可以通过以下5步来申请EKS集群。在正式申请前，请先确保腾讯云账户有大于 <strong>10 元</strong>的账户余额，否则在创建和使用EKS集群的过程中可能会因为费用不足而报错。</p><ol><li>创建腾讯云弹性集群</li></ol><p>具体步骤如下：</p><p>首先，登录容器服务控制台，选择左侧导航栏中的【<a target="_blank" rel="noopener noreferrer" href="https://console.cloud.tencent.com/tke2/ecluster">弹性集群<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>】。<br/>然后，在页面上方选择需创建弹性集群的地域，并单击【新建】。在“创建弹性集群”页面，根据以下提示设置集群信息。如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage378c3740a98a6140b9c85517bdd27f30268c.38ebee16.png" alt="图片"/></p><p>页面中各选择项的意思，我来给你解释一下：</p><ul><li>**集群名称：**创建的弹性集群名称，不超过60个字符。</li><li>**Kubernetes版本：**弹性集群支持1.12以上的多个 Kubernetes 版本选择，建议选择最新的版本。</li><li>**所在地域：**建议你根据所在地理位置选择靠近的地域，可降低访问延迟，提高下载速度。</li><li>**集群网络：**已创建的弹性集群 VPC 网络，你可以选择私有网络中的子网用于弹性集群的容器网络，详情请见 <a target="_blank" rel="noopener noreferrer" href="https://cloud.tencent.com/document/product/215/20046">私有网络（VPC）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 。</li><li>**容器网络：**为集群内容器分配在容器网络地址范围内的 IP 地址。弹性集群的 Pod 会直接占用 VPC 子网 IP，请尽量选择 IP 数量充足且与其他产品使用无冲突的子网。</li><li>**Service CIDR：**集群的 ClusterIP Service 默认分配在所选 VPC 子网中，请尽量选择 IP 数量充足且与其他产品使用无冲突的子网。</li><li>**集群描述：**创建集群的相关信息，该信息将显示在“集群信息”页面。</li></ul><p>设置完成后，单击【完成】即可开始创建，可在“弹性集群”列表页面查看集群的创建进度。</p><p>等待弹性集群创建完成，创建完成后的弹性集群页面如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage1c3e1c533956986531f0245b27864f17dc3e.1413f5fb.png" alt="图片"/></p><p>我们创建的弹性集群ID为<strong>cls-dc6sdos4</strong>。</p><ol start="2"><li>开启外网访问</li></ol><p>如果想访问EKS集群，需要先开启EKS的外网访问能力，开启方法如下：</p><p>登录容器服务控制台 -&gt; 选择左侧导航栏中的【<a target="_blank" rel="noopener noreferrer" href="https://console.cloud.tencent.com/tke2/ecluster">弹性集群<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>】 -&gt; 进入<strong>cls-dc6sdos4</strong> 集群的详情页中 -&gt; 选择【基本信息】 -&gt; 点击【外网访问】按钮。如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage23c6235679797980de87432a0d4b05dd83c6.418e9f0f.png" alt="图片"/></p><p>这里要注意，开启外网访问时，为了安全，需要设置允许访问kube-apiserver的IP段。为了避免不必要的错误，外网访问地址我们设置为<code>0.0.0.0/0</code> 。如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimageea21ea627942e5a432401e5959ee90c06221.53bb0238.png" alt="图片"/></p><p>注意，只有测试时才可这么设置为 <code>0.0.0.0/0</code> ，如果是生产环境，建议严格限制可以访问kube-apiserver的来源IP。</p><ol start="3"><li>安装kubectl命令行工具</li></ol><p>如果要访问EKS（标准的Kubernetes集群），比较高效的方式是通过Kubernetes提供的命令行工具kubectl来访问。所以，还需要安装kubectl工具。</p><p>安装方式如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ curl -LO &quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;</span></div><div class="token-line"><span class="token plain">    $ mkdir -p $HOME/bin</span></div><div class="token-line"><span class="token plain">    $ mv kubectl $HOME/bin</span></div><div class="token-line"><span class="token plain">    $ chmod +x $HOME/bin/kubectl</span></div></pre></div><p>具体可参考<a target="_blank" rel="noopener noreferrer" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">安装和设置 kubectl<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。<br/>你可以通过以下命令来配置kubectl的bash自动补全：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl completion bash &gt; $HOME/.kube-completion.bash</span></div><div class="token-line"><span class="token plain">    $ echo &#x27;source $HOME/.kube-completion.bash&#x27; &gt;&gt; ~/.bashrc</span></div><div class="token-line"><span class="token plain">    $ bash</span></div></pre></div><ol start="4"><li>下载并安装kubeconfig</li></ol><p>安装完kubectl工具之后，需要配置kubectl所读取的配置文件。</p><p>这里注意，在上一步，我们开启了外网访问，开启后EKS会生成一个kubeconfig配置（ <code>kubeconfig</code> 即为kubectl的配置文件）。我们可以从页面下载并安装。</p><p>在弹性集群的基本信息页面，点击【复制】按钮，复制kubeconfig文件内容，如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimagebcbfbc314604334dd56b7337a905c9b6bfbf.09ffca5a.png" alt="图片"/></p><p>复制后，将粘贴板的内容保存在<code>$HOME/.kube/config</code>文件中。需要先执行<code>mkdir \-p $HOME/.kube</code>创建<code>.kube</code>目录，再将粘贴版中的内容写到 <code>config</code> 文件中。</p><p>你可以通过以下命令，来测试kubectl工具是否成功安装和配置：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl get nodes</span></div><div class="token-line"><span class="token plain">    NAME                    STATUS   ROLES    AGE    VERSION</span></div><div class="token-line"><span class="token plain">    eklet-subnet-lowt256k   Ready    &lt;none&gt;   2d1h   v2.5.21</span></div></pre></div><p>如果输出了Kubernetes的eklet节点，并且节点状态为<strong>Ready</strong>，说明Kubernetes集群运行正常，并且kubectl安装和配置正确。</p><ol start="5"><li>EKS集群开通集群内服务访问外网能力</li></ol><p>因为IAM应用中的数据库：MariaDB、Redis、MongoDB可能需要通过外网访问，所以还需要开通EKS中Pod访问外网的能力。</p><p>EKS支持通过配置 <a target="_blank" rel="noopener noreferrer" href="https://cloud.tencent.com/document/product/215/4975">NAT 网关<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 <a target="_blank" rel="noopener noreferrer" href="https://cloud.tencent.com/document/product/215/4954">路由表<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来实现集群内服务访问外网。具体开启步骤，需要你查看腾讯云官方文档：<a target="_blank" rel="noopener noreferrer" href="https://cloud.tencent.com/document/product/457/48710">通过 NAT 网关访问外网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>在开通过程中有以下两点需要你注意：</p><ul><li>在<strong>创建指向 NAT 网关的路由表</strong>步骤中，目的端要选择：0.0.0.0/0。</li><li>在<strong>关联子网至路由表</strong>步骤中，只关联创建EKS集群时选择的子网。</li></ul><p>如果你的数据库需要通过外网访问，这里一定要确保EKS集群成功开通集群内服务访问外网能力，否则部署IAM应用时会因为访问不了数据库而失败。</p><h2 id="安装iam应用"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#安装iam应用"><span class="icon icon-link"></span></a>安装IAM应用</h2><p>上面，我们开通了镜像仓库、安装了Docker引擎、安装和配置了Kubernetes集群，那么接下来，我们就来看下如何将IAM应用部署到Kubernetes集群中。</p><p>假设IAM项目仓库根目录路径为 <code>$IAM_ROOT</code>，具体安装步骤如下：</p><ol><li>配置<code>scripts/install/environment.sh</code></li></ol><p><code>scripts/install/environment.sh</code>文件中包含了各类自定义配置。你可能需要配置跟数据库相关的配置（当然，也可以都使用默认值）：</p><ul><li>MariaDB配置：environment.sh文件中以<code>MARIADB_</code>开头的变量。</li><li>Redis配置：environment.sh文件中以<code>REDIS_</code>开头的变量。</li><li>MongoDB配置：environment.sh文件中以<code>MONGO_</code>开头的变量。</li></ul><p>其他配置，使用默认值。</p><ol start="2"><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">创建IAM应用的配置文件</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ cd ${IAM_ROOT}</span></div><div class="token-line"><span class="token plain">    $ make gen.defaultconfigs # 生成iam-apiserver、iam-authz-server、iam-pump、iamctl组件的默认配置文件</span></div><div class="token-line"><span class="token plain">    $ make gen.ca # 生成 CA 证书</span></div></pre></div><p>上述命令会将IAM的配置文件存放在这个<code>$<!-- -->{<!-- -->IAM_ROOT<!-- -->}<!-- -->/_output/configs/</code>目录下。</p><ol start="3"><li>创建IAM命名空间</li></ol><p>我们将IAM应用涉及到的各类资源，都创建在<code>iam</code>命名空间中。将IAM资源创建在独立的命名空间中，不仅方便维护，还可以有效避免影响其他Kubernetes资源。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl create namespace iam</span></div></pre></div><ol start="4"><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">将IAM各服务的配置文件，以ConfigMap资源的形式保存在Kubernetes集群中</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl -n iam create configmap iam --from-file=${IAM_ROOT}/_output/configs/</span></div><div class="token-line"><span class="token plain">    $ kubectl -n iam get configmap iam</span></div><div class="token-line"><span class="token plain">    NAME   DATA   AGE</span></div><div class="token-line"><span class="token plain">    iam    4      13s</span></div></pre></div><p>执行<code>kubectl \-n iam get configmap iam</code>命令，可以成功获取创建的<code>iam</code> configmap。</p><p>如果你觉得每次执行<code>kubectl</code>命令都要指定<code>-n iam</code>选项很繁琐，你可以使用以下命令，将<code>kubectl</code>上下文环境中的命名空间指定为<code>iam</code>。设置后，执行<code>kubectl</code>命令，默认在<code>iam</code>命名空间下执行：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl config set-context `kubectl config current-context` --namespace=iam</span></div></pre></div><ol start="5"><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">将IAM各服务使用的证书文件，以ConfigMap资源的形式创建在Kubernetes集群中</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl -n iam create configmap iam-cert --from-file=${IAM_ROOT}/_output/cert</span></div><div class="token-line"><span class="token plain">    $ kubectl -n iam get configmap iam-cert</span></div><div class="token-line"><span class="token plain">    NAME       DATA   AGE</span></div><div class="token-line"><span class="token plain">    iam-cert   14     12s</span></div></pre></div><p>执行<code>kubectl \-n iam get configmap iam-cert</code>命令，可以成功获取创建的<code>iam-cert</code> configmap。</p><ol start="6"><li>创建镜像仓库访问密钥</li></ol><p>在准备阶段，我们开通了腾讯云镜像仓库服务（访问地址为ccr.ccs.tencentyun.com），并创建了用户<code>10000099xxxx</code>，其密码为<code>iam59!z$</code>。</p><p>接下来，我们就可以创建docker-registry secret。Kubernetes在下载Docker镜像时，需要docker-registry secret来进行认证。创建命令如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl -n iam create secret docker-registry ccr-registry --docker-server=ccr.ccs.tencentyun.com --docker-username=10000099xxxx --docker-password=&#x27;iam59!z$&#x27;</span></div></pre></div><ol start="7"><li>创建Docker镜像，并Push到镜像仓库</li></ol><p>将镜像Push到CCR镜像仓库，需要确保你已经登录到腾讯云CCR镜像仓库，如果没登录，可以执行以下命令来登录：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ docker login --username=[username] ccr.ccs.tencentyun.com</span></div></pre></div><p>执行 <code>make push</code> 命令构建镜像，并将镜像Push到CCR镜像仓库：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ make push REGISTRY_PREFIX=ccr.ccs.tencentyun.com/marmotedu VERSION=v1.1.0</span></div></pre></div><p>上述命令，会构建iam-apiserver-amd64、iam-authz-server-amd64、iam-pump-amd64、iamctl-amd64 四个镜像，并将这些镜像Push到腾讯云镜像仓库的<code>marmotedu</code>命名空间下。</p><p>构建的镜像如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ docker images|grep marmotedu</span></div><div class="token-line"><span class="token plain">    ccr.ccs.tencentyun.com/marmotedu/iam-pump-amd64           v1.1.0   e078d340e3fb        10 seconds ago      244MB</span></div><div class="token-line"><span class="token plain">    ccr.ccs.tencentyun.com/marmotedu/iam-apiserver-amd64      v1.1.0   5e90b67cc949        2 minutes ago       239MB</span></div><div class="token-line"><span class="token plain">    ccr.ccs.tencentyun.com/marmotedu/iam-authz-server-amd64   v1.1.0   6796b02be68c        2 minutes ago       238MB</span></div><div class="token-line"><span class="token plain">    ccr.ccs.tencentyun.com/marmotedu/iamctl-amd64             v1.1.0   320a77d525e3        2 minutes ago       235MB</span></div></pre></div><ol start="8"><li>修改 <code>$<!-- -->{<!-- -->IAM_ROOT<!-- -->}<!-- -->/deployments/iam.yaml</code> 配置</li></ol><p>这里请你注意，如果在上一个步骤中，你构建的镜像tag不是 <code>v1.1.0</code> ，那么你需要修改 <code>$<!-- -->{<!-- -->IAM_ROOT<!-- -->}<!-- -->/deployments/iam.yaml</code> 文件，并将iam-apiserver-amd64、 iam-authz-server-amd64、 iam-pump-amd64、iamctl-amd64 镜像的tag修改成你构建镜像时指定的tag。</p><ol start="9"><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">部署IAM应用</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl -n iam apply -f ${IAM_ROOT}/deployments/iam.yaml</span></div></pre></div><p>执行上述命令，会在<code>iam</code>命令空间下，创建一系列Kubernetes资源，可以使用以下命令，来获取这些资源的状态：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl -n iam get all</span></div><div class="token-line"><span class="token plain">    NAME                                    READY   STATUS    RESTARTS   AGE</span></div><div class="token-line"><span class="token plain">    pod/iam-apiserver-d8dc48596-wkhpl       1/1     Running   0          94m</span></div><div class="token-line"><span class="token plain">    pod/iam-authz-server-6bc899c747-fbpbk   1/1     Running   0          94m</span></div><div class="token-line"><span class="token plain">    pod/iam-pump-7dcbfd4f59-2w9vk           1/1     Running   0          94m</span></div><div class="token-line"><span class="token plain">    pod/iamctl-6fc46b8ccb-gs62l             1/1     Running   1          98m</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span></div><div class="token-line"><span class="token plain">    service/iam-apiserver      ClusterIP   192.168.0.174   &lt;none&gt;        8443/TCP,8080/TCP,8081/TCP   101m</span></div><div class="token-line"><span class="token plain">    service/iam-authz-server   ClusterIP   192.168.0.76    &lt;none&gt;        9443/TCP,9090/TCP            101m</span></div><div class="token-line"><span class="token plain">    service/iam-pump           ClusterIP   192.168.0.155   &lt;none&gt;        7070/TCP                     101m</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    NAME                               READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line"><span class="token plain">    deployment.apps/iam-apiserver      1/1     1            1           101m</span></div><div class="token-line"><span class="token plain">    deployment.apps/iam-authz-server   1/1     1            1           101m</span></div><div class="token-line"><span class="token plain">    deployment.apps/iam-pump           1/1     1            1           101m</span></div><div class="token-line"><span class="token plain">    deployment.apps/iamctl             1/1     1            1           101m</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    NAME                                          DESIRED   CURRENT   READY   AGE</span></div><div class="token-line"><span class="token plain">    replicaset.apps/iam-apiserver-d8dc48596       1         1         1       101m</span></div><div class="token-line"><span class="token plain">    replicaset.apps/iam-authz-server-6bc899c747   1         1         1       101m</span></div><div class="token-line"><span class="token plain">    replicaset.apps/iam-pump-7dcbfd4f59           1         1         1       101m</span></div><div class="token-line"><span class="token plain">    replicaset.apps/iamctl-6fc46b8ccb             1         1         1       101m</span></div></pre></div><p>我们看到<code>pod/iam-apiserver-d8dc48596-wkhpl</code>、<code>pod/iam-authz-server-6bc899c747-fbpbk</code>、<code>pod/iam-pump-7dcbfd4f59-2w9vk</code>、<code>pod/iamctl-6fc46b8ccb-gs62l</code> 4个Pod都处在<code>Running</code>状态，说明服务都成功启动。</p><h2 id="测试iam应用"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#测试iam应用"><span class="icon icon-link"></span></a>测试IAM应用</h2><p>我们在<code>iam</code>命令空间下创建了一个测试Deployment <code>iamctl</code>。你可以登陆<code>iamctl</code> Deployment所创建出来的Pod，执行一些运维操作和冒烟测试。登陆命令如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl -n iam exec -it `kubectl -n iam get pods -l app=iamctl | awk &#x27;/iamctl/{print $1}&#x27;` -- bash</span></div></pre></div><p>登陆到<code>iamctl-xxxxxxxxxx-xxxxx</code> Pod中后，就可以执行运维操作和冒烟测试了。</p><ol><li>运维操作</li></ol><p>在iamctl容器中，你可以使用iamctl工具提供的各类功能，iamctl以子命令的方式对外提供功能。命令执行效果见下图：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage447e4460dfd5cd7f7fae5cbb0c64e605367e.f090ba76.png" alt="图片"/></p><ol start="2"><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">冒烟测试</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"># cd /opt/iam/scripts/install</span></div><div class="token-line"><span class="token plain">    # ./test.sh iam::test::smoke</span></div></pre></div><p>如果<code>./test.sh iam::test::smoke</code>命令，打印的输出中，最后一行为<code>congratulations, smoke test passed!</code>字符串，说明IAM应用安装成功。如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimageb92eb9688e6b0609571a06401da412b63d2e.3c9831ed.png" alt="图片"/></p><h2 id="销毁eks集群及其资源"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#销毁eks集群及其资源"><span class="icon icon-link"></span></a>销毁EKS集群及其资源</h2><p>好了，到这里，你已经成功在EKS集群中部署了IAM应用，EKS的使命也就完成了。接下来，为避免账户被持续扣费，需要删除EKS内的资源和集群。</p><ol><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">删除EKS内创建的IAM资源</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl delete namespace iam</span></div></pre></div><p>因为删除Namespace会删除Namespace下的所有资源，所以上述命令执行时间会久点。</p><ol start="2"><li>删除EKS集群</li></ol><p>首先，登录容器服务控制台，选择左侧导航栏中的【<a target="_blank" rel="noopener noreferrer" href="https://console.cloud.tencent.com/tke2/ecluster">弹性集群<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>】。<br/>然后，选择创建的EKS集群：cls-dc6sdos4，点击最右侧的【删除】按钮，删除EKS集群。如下图所示：</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage059505db9d9aca0a2a06e0a9a9faf37c4695.8ffe84bb.png" alt="图片"/></p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#总结"><span class="icon icon-link"></span></a>总结</h2><p>云原生架构设计中，需要将IAM应用部署到Kubernetes集群中。所以，首先需要你准备一个Kubernetes集群。你可以自己购买腾讯云CVM机器搭建Kubernetes集群，但这种方式费用高、操作复杂。所以，我建议你直接申请一个EKS集群来部署IAM应用。</p><p>EKS集群是一个标准的Kubernetes集群，可以快速申请，并免运维。EKS集群只收取实际的资源使用费用。在专栏学习过程中，部署IAM应用期间产生的资源使用费用其实是很低的，所以推荐使用这种方式来部署IAM应用。</p><p>有了Kubernetes集群，就可以直接通过以下命令来部署整个IAM应用：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ kubectl -n iam apply -f ${IAM_ROOT}/deployments/iam.yaml</span></div></pre></div><p>应用部署起来之后，我们可以登陆到<code>iamctl-xxxxxxxxxx-xxxxx</code>Pod，并执行以下命令来测试整个IAM应用是否被成功部署：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"># cd /opt/iam/scripts/install</span></div><div class="token-line"><span class="token plain">    # ./test.sh iam::test::smoke</span></div></pre></div><h2 id="课后练习"><a aria-hidden="true" tabindex="-1" href="/blog-backend/go语言项目开发实战/07.实战第5站服务部署/09#课后练习"><span class="icon icon-link"></span></a>课后练习</h2><ol><li>思考下，如何将MariaDB、MongoDB、Redis实现容器化？</li><li>思考下，如何更相信IAM应用中的iam-apiserver服务，试着更新这个服务。</li></ol><p>欢迎你在留言区与我交流讨论，我们下一讲见。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/go语言项目开发实战/07.实战第5站服务部署/09.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/27 11:15:40</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-backend/umi.e14e5a14.js"></script>
  </body>
</html>
