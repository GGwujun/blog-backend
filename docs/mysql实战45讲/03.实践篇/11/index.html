<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-backend/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-backend";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>19 | 为什么我只查一行的语句，也执行这么慢？ - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/mysql实战45讲/03.实践篇/11" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-backend/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>后端开发<ul><li><a href="/blog-backend/go语言核心36讲">go语言核心36讲</a></li><li><a href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/kafka核心技术与实战">kafka核心技术与实战</a></li><li><a href="/blog-backend/kafka核心源码解读">kafka核心源码解读</a></li><li><a href="/blog-backend/零基础学python">零基础学python</a></li><li><a href="/blog-backend/python核心技术与实战">python核心技术与实战</a></li><li><a href="/blog-backend/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-backend/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-backend/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-backend/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-backend/后端存储实战课">后端存储实战课</a></li><li><a href="/blog-backend/后端技术面试38讲">后端技术面试38讲</a></li><li><a href="/blog-backend/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li><li><a href="/blog-backend/现代c编程实战">现代c编程实战</a></li><li><a href="/blog-backend/罗剑锋的c实战笔记">罗剑锋的c实战笔记</a></li><li><a href="/blog-backend/零基础入门spark">零基础入门spark</a></li></ul></span><span>架构师<ul><li><a aria-current="page" class="active" href="/blog-backend/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-backend/数据中台实战课">数据中台实战课</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-backend/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>后端开发<ul><li><a href="/blog-backend/go语言核心36讲">go语言核心36讲</a></li><li><a href="/blog-backend/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-backend/go语言项目开发实战">go语言项目开发实战</a></li><li><a href="/blog-backend/kafka核心技术与实战">kafka核心技术与实战</a></li><li><a href="/blog-backend/kafka核心源码解读">kafka核心源码解读</a></li><li><a href="/blog-backend/零基础学python">零基础学python</a></li><li><a href="/blog-backend/python核心技术与实战">python核心技术与实战</a></li><li><a href="/blog-backend/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-backend/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-backend/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-backend/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-backend/后端存储实战课">后端存储实战课</a></li><li><a href="/blog-backend/后端技术面试38讲">后端技术面试38讲</a></li><li><a href="/blog-backend/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li><li><a href="/blog-backend/现代c编程实战">现代c编程实战</a></li><li><a href="/blog-backend/罗剑锋的c实战笔记">罗剑锋的c实战笔记</a></li><li><a href="/blog-backend/零基础入门spark">零基础入门spark</a></li></ul></li><li>架构师<ul><li><a aria-current="page" class="active" href="/blog-backend/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-backend/数据中台实战课">数据中台实战课</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-backend/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-backend/mysql实战45讲/01.开篇词">01.开篇词</a><ul><li><a href="/blog-backend/mysql实战45讲/01.开篇词/01"><span>开篇词 | 这一次，让我们一起来搞懂MySQL</span></a></li></ul></li><li><a href="/blog-backend/mysql实战45讲/02.基础篇">02.基础篇</a><ul><li><a href="/blog-backend/mysql实战45讲/02.基础篇/01"><span>01 | 基础架构：一条SQL查询语句是如何执行的？</span></a></li><li><a href="/blog-backend/mysql实战45讲/02.基础篇/02"><span>02  | 日志系统：一条SQL更新语句是如何执行的？</span></a></li><li><a href="/blog-backend/mysql实战45讲/02.基础篇/03"><span>03 | 事务隔离：为什么你改了我还看不见？</span></a></li><li><a href="/blog-backend/mysql实战45讲/02.基础篇/04"><span>04 | 深入浅出索引（上）</span></a></li><li><a href="/blog-backend/mysql实战45讲/02.基础篇/05"><span>05 | 深入浅出索引（下）</span></a></li><li><a href="/blog-backend/mysql实战45讲/02.基础篇/06"><span>06 | 全局锁和表锁 ：给表加个字段怎么有这么多阻碍？</span></a></li><li><a href="/blog-backend/mysql实战45讲/02.基础篇/07"><span>07 | 行锁功过：怎么减少行锁对性能的影响？</span></a></li><li><a href="/blog-backend/mysql实战45讲/02.基础篇/08"><span>08 | 事务到底是隔离的还是不隔离的？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-backend/mysql实战45讲/03.实践篇">03.实践篇</a><ul><li><a href="/blog-backend/mysql实战45讲/03.实践篇/01"><span>09 | 普通索引和唯一索引，应该怎么选择？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/02"><span>10 | MySQL为什么有时候会选错索引？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/03"><span>11 |  怎么给字符串字段加索引？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/04"><span>12 | 为什么我的MySQL会“抖”一下？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/05"><span>13 | 为什么表数据删掉一半，表文件大小不变？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/06"><span>14 | count(*)这么慢，我该怎么办？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/07"><span>15 | 答疑文章（一）：日志和索引相关问题</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/08"><span>16 | “order by”是怎么工作的？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/09"><span>17 | 如何正确地显示随机消息？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/10"><span>18 | 为什么这些SQL语句逻辑相同，性能却差异巨大？</span></a></li><li><a aria-current="page" class="active" href="/blog-backend/mysql实战45讲/03.实践篇/11"><span>19 | 为什么我只查一行的语句，也执行这么慢？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/12"><span>20 | 幻读是什么，幻读有什么问题？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/13"><span>21 | 为什么我只改一行的语句，锁这么多？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/14"><span>22 | MySQL有哪些“饮鸩止渴”提高性能的方法？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/15"><span>23 | MySQL是怎么保证数据不丢的？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/16"><span>24 | MySQL是怎么保证主备一致的？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/17"><span>25 | MySQL是怎么保证高可用的？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/18"><span>26 | 备库为什么会延迟好几个小时？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/19"><span>27 | 主库出问题了，从库怎么办？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/20"><span>28 | 读写分离有哪些坑？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/21"><span>29 | 如何判断一个数据库是不是出问题了？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/22"><span>30 | 答疑文章（二）：用动态的观点看加锁</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/23"><span>31 | 误删数据后除了跑路，还能怎么办？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/24"><span>32 | 为什么还有kill不掉的语句？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/25"><span>33 | 我查这么多数据，会不会把数据库内存打爆？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/26"><span>34 | 到底可不可以使用join？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/27"><span>35 | join语句怎么优化？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/28"><span>36 | 为什么临时表可以重名？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/29"><span>37 | 什么时候会使用内部临时表？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/30"><span>38 | 都说InnoDB好，那还要不要使用Memory引擎？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/31"><span>39 | 自增主键为什么不是连续的？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/32"><span>40 | insert语句的锁为什么这么多？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/33"><span>41 | 怎么最快地复制一张表？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/34"><span>42 | grant之后要跟着flush privileges吗？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/35"><span>43 | 要不要使用分区表？</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/36"><span>44 | 答疑文章（三）：说一说这些好问题</span></a></li><li><a href="/blog-backend/mysql实战45讲/03.实践篇/37"><span>45 | 自增id用完怎么办？</span></a></li></ul></li><li><a href="/blog-backend/mysql实战45讲/04.特别放送">04.特别放送</a><ul><li><a href="/blog-backend/mysql实战45讲/04.特别放送/01"><span>直播回顾 | 林晓斌：我的 MySQL 心路历程</span></a></li></ul></li><li><a href="/blog-backend/mysql实战45讲/05.结束语">05.结束语</a><ul><li><a href="/blog-backend/mysql实战45讲/05.结束语/01"><span>结束语 | 点线网面，一起构建MySQL知识网络</span></a></li></ul></li><li><a href="/blog-backend/mysql实战45讲/summary">mysql实战45讲</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="等MDL锁" data-depth="2"><a href="/blog-backend/mysql实战45讲/03.实践篇/11#等mdl锁"><span>等MDL锁</span></a></li><li title="等flush" data-depth="2"><a href="/blog-backend/mysql实战45讲/03.实践篇/11#等flush"><span>等flush</span></a></li><li title="等行锁" data-depth="2"><a href="/blog-backend/mysql实战45讲/03.实践篇/11#等行锁"><span>等行锁</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="19--为什么我只查一行的语句也执行这么慢"><a aria-hidden="true" tabindex="-1" href="/blog-backend/mysql实战45讲/03.实践篇/11#19--为什么我只查一行的语句也执行这么慢"><span class="icon icon-link"></span></a>19 | 为什么我只查一行的语句，也执行这么慢？</h1><p>一般情况下，如果我跟你说查询性能优化，你首先会想到一些复杂的语句，想到查询需要返回大量的数据。但有些情况下，“查一行”，也会执行得特别慢。今天，我就跟你聊聊这个有趣的话题，看看什么情况下，会出现这个现象。</p><p>需要说明的是，如果MySQL数据库本身就有很大的压力，导致数据库服务器CPU占用率很高或ioutil（IO利用率）很高，这种情况下所有语句的执行都有可能变慢，不属于我们今天的讨论范围。</p><p>为了便于描述，我还是构造一个表，基于这个表来说明今天的问题。这个表有两个字段id和c，并且我在里面插入了10万行记录。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql&gt; CREATE TABLE `t` (</span></div><div class="token-line"><span class="token plain">      `id` int(11) NOT NULL,</span></div><div class="token-line"><span class="token plain">      `c` int(11) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      PRIMARY KEY (`id`)</span></div><div class="token-line"><span class="token plain">    ) ENGINE=InnoDB;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    delimiter ;;</span></div><div class="token-line"><span class="token plain">    create procedure idata()</span></div><div class="token-line"><span class="token plain">    begin</span></div><div class="token-line"><span class="token plain">      declare i int;</span></div><div class="token-line"><span class="token plain">      set i=1;</span></div><div class="token-line"><span class="token plain">      while(i&lt;=100000) do</span></div><div class="token-line"><span class="token plain">        insert into t values(i,i);</span></div><div class="token-line"><span class="token plain">        set i=i+1;</span></div><div class="token-line"><span class="token plain">      end while;</span></div><div class="token-line"><span class="token plain">    end;;</span></div><div class="token-line"><span class="token plain">    delimiter ;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    call idata();</span></div></pre></div><p>接下来，我会用几个不同的场景来举例，有些是前面的文章中我们已经介绍过的知识点，你看看能不能一眼看穿，来检验一下吧。</p><h1 id="第一类查询长时间不返回"><a aria-hidden="true" tabindex="-1" href="/blog-backend/mysql实战45讲/03.实践篇/11#第一类查询长时间不返回"><span class="icon icon-link"></span></a>第一类：查询长时间不返回</h1><p>如图1所示，在表t执行下面的SQL语句：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql&gt; select * from t where id=1;</span></div></pre></div><p>查询结果长时间不返回。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>图1 查询长时间不返回</p><p>一般碰到这种情况的话，大概率是表t被锁住了。接下来分析原因的时候，一般都是首先执行一下show processlist命令，看看当前语句处于什么状态。</p><p>然后我们再针对每种状态，去分析它们产生的原因、如何复现，以及如何处理。</p><h2 id="等mdl锁"><a aria-hidden="true" tabindex="-1" href="/blog-backend/mysql实战45讲/03.实践篇/11#等mdl锁"><span class="icon icon-link"></span></a>等MDL锁</h2><p>如图2所示，就是使用show processlist命令查看Waiting for table metadata lock的示意图。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage50285008d7e9e22be88a9c80916df4f4b328.22a649d8.png" alt=""/></p><p>图2 Waiting for table metadata lock状态示意图</p><p>出现<strong>这个状态表示的是，现在有一个线程正在表t上请求或者持有MDL写锁，把select语句堵住了。</strong></p><p>在第6篇文章<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/69862">《全局锁和表锁 ：给表加个字段怎么有这么多阻碍？》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中，我给你介绍过一种复现方法。但需要说明的是，那个复现过程是基于MySQL 5.6版本的。而MySQL 5.7版本修改了MDL的加锁策略，所以就不能复现这个场景了。</p><p>不过，在MySQL 5.7版本下复现这个场景，也很容易。如图3所示，我给出了简单的复现步骤。<br/><img src="data:image/png;base64,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" alt=""/></p><p>图3 MySQL 5.7中Waiting for table metadata lock的复现步骤</p><p>session A 通过lock table命令持有表t的MDL写锁，而session B的查询需要获取MDL读锁。所以，session B进入等待状态。</p><p>这类问题的处理方式，就是找到谁持有MDL写锁，然后把它kill掉。</p><p>但是，由于在show processlist的结果里面，session A的Command列是“Sleep”，导致查找起来很不方便。不过有了performance_schema和sys系统库以后，就方便多了。（MySQL启动时需要设置performance_schema=on，相比于设置为off会有10%左右的性能损失)</p><p>通过查询sys.schema_table_lock_waits这张表，我们就可以直接找出造成阻塞的process id，把这个连接用kill 命令断开即可。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>图4 查获加表锁的线程id</p><h2 id="等flush"><a aria-hidden="true" tabindex="-1" href="/blog-backend/mysql实战45讲/03.实践篇/11#等flush"><span class="icon icon-link"></span></a>等flush</h2><p>接下来，我给你举另外一种查询被堵住的情况。</p><p>我在表t上，执行下面的SQL语句：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql&gt; select * from information_schema.processlist where id=1;</span></div></pre></div><p>这里，我先卖个关子。</p><p>你可以看一下图5。我查出来这个线程的状态是Waiting for table flush，你可以设想一下这是什么原因。<br/><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage2d242d8250398bc7f8f7dce8b6b1923c3724.6d67a73e.png" alt=""/></p><p>图5 Waiting for table flush状态示意图</p><p>这个状态表示的是，现在有一个线程正要对表t做flush操作。MySQL里面对表做flush操作的用法，一般有以下两个：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">flush tables t with read lock;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    flush tables with read lock;</span></div></pre></div><p>这两个flush语句，如果指定表t的话，代表的是只关闭表t；如果没有指定具体的表名，则表示关闭MySQL里所有打开的表。</p><p>但是正常这两个语句执行起来都很快，除非它们也被别的线程堵住了。</p><p>所以，出现Waiting for table flush状态的可能情况是：有一个flush tables命令被别的语句堵住了，然后它又堵住了我们的select语句。</p><p>现在，我们一起来复现一下这种情况，<strong>复现步骤</strong>如图6所示：</p><p><img src="data:image/png;base64,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" alt=""/></p><p>图6 Waiting for table flush的复现步骤</p><p>在session A中，我故意每行都调用一次sleep(1)，这样这个语句默认要执行10万秒，在这期间表t一直是被session A“打开”着。然后，session B的flush tables t命令再要去关闭表t，就需要等session A的查询结束。这样，session C要再次查询的话，就会被flush 命令堵住了。</p><p>图7是这个复现步骤的show processlist结果。这个例子的排查也很简单，你看到这个show processlist的结果，肯定就知道应该怎么做了。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage397e398407014180be4146c2d088fc07357e.57773d32.png" alt=""/></p><p>图 7 Waiting for table flush的show processlist 结果</p><h2 id="等行锁"><a aria-hidden="true" tabindex="-1" href="/blog-backend/mysql实战45讲/03.实践篇/11#等行锁"><span class="icon icon-link"></span></a>等行锁</h2><p>现在，经过了表级锁的考验，我们的select 语句终于来到引擎里了。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql&gt; select * from t where id=1 lock in share mode;</span></div></pre></div><p>上面这条语句的用法你也很熟悉了，我们在第8篇<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/70562">《事务到底是隔离的还是不隔离的？》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>文章介绍当前读时提到过。</p><p>由于访问id=1这个记录时要加读锁，如果这时候已经有一个事务在这行记录上持有一个写锁，我们的select语句就会被堵住。</p><p>复现步骤和现场如下：</p><p><img src="data:image/png;base64,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" alt=""/></p><p>图 8 行锁复现</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage3c8f3c266e23fc307283aa94923ecbbc738f.cb695cde.png" alt=""/></p><p>图 9 行锁show processlist 现场</p><p>显然，session A启动了事务，占有写锁，还不提交，是导致session B被堵住的原因。</p><p>这个问题并不难分析，但问题是怎么查出是谁占着这个写锁。如果你用的是MySQL 5.7版本，可以通过sys.innodb_lock_waits 表查到。</p><p>查询方法是：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql&gt; select * from t sys.innodb_lock_waits where locked_table=&#x27;`test`.`t`&#x27;\G</span></div></pre></div><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimaged818d8603aeb4eaad3326699c13c46379118.7cd0d993.png" alt=""/></p><p>图10 通过sys.innodb_lock_waits 查行锁</p><p>可以看到，这个信息很全，4号线程是造成堵塞的罪魁祸首。而干掉这个罪魁祸首的方式，就是KILL QUERY 4或KILL 4。</p><p>不过，这里不应该显示“KILL QUERY 4”。这个命令表示停止4号线程当前正在执行的语句，而这个方法其实是没有用的。因为占有行锁的是update语句，这个语句已经是之前执行完成了的，现在执行KILL QUERY，无法让这个事务去掉id=1上的行锁。</p><p>实际上，KILL 4才有效，也就是说直接断开这个连接。这里隐含的一个逻辑就是，连接被断开的时候，会自动回滚这个连接里面正在执行的线程，也就释放了id=1上的行锁。</p><h1 id="第二类查询慢"><a aria-hidden="true" tabindex="-1" href="/blog-backend/mysql实战45讲/03.实践篇/11#第二类查询慢"><span class="icon icon-link"></span></a>第二类：查询慢</h1><p>经过了重重封“锁”，我们再来看看一些查询慢的例子。</p><p>先来看一条你一定知道原因的SQL语句：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql&gt; select * from t where c=50000 limit 1;</span></div></pre></div><p>由于字段c上没有索引，这个语句只能走id主键顺序扫描，因此需要扫描5万行。</p><p>作为确认，你可以看一下慢查询日志。注意，这里为了把所有语句记录到slow log里，我在连接后先执行了 set long_query_time=0，将慢查询日志的时间阈值设置为0。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimaged83cd8b2b5f97c60ae4fc4a03c616847503c.74274f3c.png" alt=""/></p><p>图11 全表扫描5万行的slow log</p><p>Rows_examined显示扫描了50000行。你可能会说，不是很慢呀，11.5毫秒就返回了，我们线上一般都配置超过1秒才算慢查询。但你要记住：<strong>坏查询不一定是慢查询</strong>。我们这个例子里面只有10万行记录，数据量大起来的话，执行时间就线性涨上去了。</p><p>扫描行数多，所以执行慢，这个很好理解。</p><p>但是接下来，我们再看一个只扫描一行，但是执行很慢的语句。</p><p>如图12所示，是这个例子的slow log。可以看到，执行的语句是</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql&gt; select * from t where id=1；</span></div></pre></div><p>虽然扫描行数是1，但执行时间却长达800毫秒。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage664666f26bb885401e8e460451ff6b0c0746.21e47ca7.png" alt=""/></p><p>图12 扫描一行却执行得很慢</p><p>是不是有点奇怪呢，这些时间都花在哪里了？</p><p>如果我把这个slow log的截图再往下拉一点，你可以看到下一个语句，select * from t where id=1 lock in share mode，执行时扫描行数也是1行，执行时间是0.2毫秒。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimagebdd2bde83e269d9fa185b27900c8aa8137d2.1a04fd7b.png" alt=""/></p><p>图 13 加上lock in share mode的slow log</p><p>看上去是不是更奇怪了？按理说lock in share mode还要加锁，时间应该更长才对啊。</p><p>可能有的同学已经有答案了。如果你还没有答案的话，我再给你一个提示信息，图14是这两个语句的执行输出结果。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage1f1c1fbb84bb392b6bfa93786fe032690b1c.1f6b6765.png" alt=""/></p><p>图14 两个语句的输出结果</p><p>第一个语句的查询结果里c=1，带lock in share mode的语句返回的是c=1000001。看到这里应该有更多的同学知道原因了。如果你还是没有头绪的话，也别着急。我先跟你说明一下复现步骤，再分析原因。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage84ff84667a3449dc846e393142600ee7a2ff.b4db9575.png" alt=""/></p><p>图15 复现步骤</p><p>你看到了，session A先用start transaction with consistent snapshot命令启动了一个事务，之后session B才开始执行update 语句。</p><p>session B执行完100万次update语句后，id=1这一行处于什么状态呢？你可以从图16中找到答案。</p><p><img src="/blog-backend/static/httpsstatic001geekbangorgresourceimage468c46bb9f5e27854678bfcaeaf0c3b8a98c.5e8567bc.png" alt=""/></p><p>图16 id=1的数据状态</p><p>session B更新完100万次，生成了100万个回滚日志(undo log)。</p><p>带lock in share mode的SQL语句，是当前读，因此会直接读到1000001这个结果，所以速度很快；而select * from t where id=1这个语句，是一致性读，因此需要从1000001开始，依次执行undo log，执行了100万次以后，才将1这个结果返回。</p><p>注意，undo log里记录的其实是“把2改成1”，“把3改成2”这样的操作逻辑，画成减1的目的是方便你看图。</p><h1 id="小结"><a aria-hidden="true" tabindex="-1" href="/blog-backend/mysql实战45讲/03.实践篇/11#小结"><span class="icon icon-link"></span></a>小结</h1><p>今天我给你举了在一个简单的表上，执行“查一行”，可能会出现的被锁住和执行慢的例子。这其中涉及到了表锁、行锁和一致性读的概念。</p><p>在实际使用中，碰到的场景会更复杂。但大同小异，你可以按照我在文章中介绍的定位方法，来定位并解决问题。</p><p>最后，我给你留一个问题吧。</p><p>我们在举例加锁读的时候，用的是这个语句，select * from t where id=1 lock in share mode。由于id上有索引，所以可以直接定位到id=1这一行，因此读锁也是只加在了这一行上。</p><p>但如果是下面的SQL语句，</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">begin;</span></div><div class="token-line"><span class="token plain">    select * from t where c=5 for update;</span></div><div class="token-line"><span class="token plain">    commit;</span></div></pre></div><p>这个语句序列是怎么加锁的呢？加的锁又是什么时候释放呢？</p><p>你可以把你的观点和验证方法写在留言区里，我会在下一篇文章的末尾给出我的参考答案。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1 id="上期问题时间"><a aria-hidden="true" tabindex="-1" href="/blog-backend/mysql实战45讲/03.实践篇/11#上期问题时间"><span class="icon icon-link"></span></a>上期问题时间</h1><p>在上一篇文章最后，我留给你的问题是，希望你可以分享一下之前碰到过的、与文章中类似的场景。</p><p>@封建的风 提到一个有趣的场景，值得一说。我把他的问题重写一下，表结构如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql&gt; CREATE TABLE `table_a` (</span></div><div class="token-line"><span class="token plain">      `id` int(11) NOT NULL,</span></div><div class="token-line"><span class="token plain">      `b` varchar(10) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      PRIMARY KEY (`id`),</span></div><div class="token-line"><span class="token plain">      KEY `b` (`b`)</span></div><div class="token-line"><span class="token plain">    ) ENGINE=InnoDB;</span></div></pre></div><p>假设现在表里面，有100万行数据，其中有10万行数据的b的值是’1234567890’， 假设现在执行语句是这么写的:</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql&gt; select * from table_a where b=&#x27;1234567890abcd&#x27;;</span></div></pre></div><p>这时候，MySQL会怎么执行呢？</p><p>最理想的情况是，MySQL看到字段b定义的是varchar(10)，那肯定返回空呀。可惜，MySQL并没有这么做。</p><p>那要不，就是把’1234567890abcd’拿到索引里面去做匹配，肯定也没能够快速判断出索引树b上并没有这个值，也很快就能返回空结果。</p><p>但实际上，MySQL也不是这么做的。</p><p>这条SQL语句的执行很慢，流程是这样的：</p><ol><li><p>在传给引擎执行的时候，做了字符截断。因为引擎里面这个行只定义了长度是10，所以只截了前10个字节，就是’1234567890’进去做匹配；</p></li><li><p>这样满足条件的数据有10万行；</p></li><li><p>因为是select *， 所以要做10万次回表；</p></li><li><p>但是每次回表以后查出整行，到server层一判断，b的值都不是’1234567890abcd’;</p></li><li><p>返回结果是空。</p></li></ol><p>这个例子，是我们文章内容的一个很好的补充。虽然执行过程中可能经过函数操作，但是最终在拿到结果后，server层还是要做一轮判断的。</p><p>评论区留言点赞板：</p><blockquote><p>@赖阿甘 提到了等号顺序问题，实际上MySQL优化器执行过程中，where 条件部分， a=b和 b=a的写法是一样的。<br/>@沙漠里的骆驼 提到了一个常见的问题。相同的模板语句，但是匹配行数不同，语句执行时间相差很大。这种情况，在语句里面有order by这样的操作时会更明显。<br/>@Justin 回答了我们正文中的问题，如果id 的类型是整数，传入的参数类型是字符串的时候，可以用上索引。</p></blockquote></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/mysql实战45讲/03.实践篇/11.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/27 11:15:40</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-backend/umi.e14e5a14.js"></script>
  </body>
</html>
